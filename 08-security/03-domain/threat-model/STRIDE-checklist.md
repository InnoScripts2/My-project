# STRIDE Threat Model — Модель угроз по методологии STRIDE

## Что такое STRIDE?

STRIDE — методология моделирования угроз, разработанная Microsoft. Акроним означает:

- **S**poofing (Подмена) — атака на аутентификацию
- **T**ampering (Модификация) — атака на целостность данных
- **R**epudiation (Отказ) — отрицание выполненных действий
- **I**nformation Disclosure (Раскрытие информации) — атака на конфиденциальность
- **D**enial of Service (Отказ в обслуживании) — атака на доступность
- **E**levation of Privilege (Повышение привилегий) — атака на авторизацию

## Архитектура системы (контекст)

### Компоненты киоска самообслуживания

1. **Kiosk Frontend** — статический UI (HTML/CSS/JS)
2. **Kiosk Agent** — локальный Node.js сервис
3. **Cloud API** — облачный REST API
4. **Supabase** — база данных и backend
5. **Payment Provider** — платёжный шлюз (ЮKassa)
6. **OBD-II Device** — диагностический адаптер
7. **Thickness Meter** — толщиномер
8. **Device Locks** — замки выдачи устройств

### Потоки данных

- Frontend ↔ Agent (HTTP)
- Agent ↔ Cloud API (HTTP)
- Agent ↔ Supabase (PostgreSQL over TLS)
- Agent ↔ Payment Provider (HTTPS)
- Agent ↔ OBD Device (Serial/Bluetooth)
- Agent ↔ Thickness Meter (BLE/SDK)
- Agent → Device Locks (GPIO/Serial)

## STRIDE Checklist по компонентам

### 1. Kiosk Frontend

#### Spoofing (Подмена)
- [ ] **S-F-01**: Поддельные QR-коды оплаты
  - **Митигация**: QR генерируется только агентом с валидацией; проверка payment_id при возврате
- [ ] **S-F-02**: Подделка UI (фишинг-экраны)
  - **Митигация**: Киоск-режим браузера; блокировка внешних источников; CSP headers

#### Tampering (Модификация)
- [ ] **T-F-01**: Изменение JavaScript в DevTools
  - **Митигация**: Критичные валидации на стороне агента/API; DEV-флаги отключены в PROD
- [ ] **T-F-02**: Подмена статических файлов
  - **Митигация**: Subresource Integrity (SRI) для внешних библиотек; HTTPS с валидным сертификатом

#### Repudiation (Отказ)
- [ ] **R-F-01**: Клиент отрицает действия в UI
  - **Митигация**: Логирование всех значимых действий (клик "Оплатить", "Согласен с условиями")

#### Information Disclosure (Раскрытие)
- [ ] **I-F-01**: Персональные данные в LocalStorage/SessionStorage
  - **Митигация**: Хранить только неперсональные настройки (source=agent/supabase)
- [ ] **I-F-02**: Секреты в JavaScript
  - **Митигация**: Только ANON_KEY для чтения публичных VIEW; SERVICE_ROLE_KEY только на сервере

#### Denial of Service (Отказ в обслуживании)
- [ ] **D-F-01**: Переполнение памяти браузера
  - **Митигация**: Авто-сброс сессии по таймауту; очистка state при возврате на ожидание

#### Elevation of Privilege (Повышение привилегий)
- [ ] **E-F-01**: Доступ к admin-функциям из UI
  - **Митигация**: Настройки скрыты (Ctrl+Shift+S только в DEV); операции записи недоступны из frontend

---

### 2. Kiosk Agent

#### Spoofing (Подмена)
- [ ] **S-A-01**: Поддельные webhook'и от Payment Provider
  - **Митигация**: HMAC verification с PROVIDER_WEBHOOK_SECRET
- [ ] **S-A-02**: Подключение неавторизованных устройств (OBD/толщиномер)
  - **Митигация**: Whitelist MAC-адресов/портов; драйверы с валидацией протокола

#### Tampering (Модификация)
- [ ] **T-A-01**: Изменение логов/отчётов
  - **Митигация**: Append-only логирование; контрольные суммы для отчётов
- [ ] **T-A-02**: Подмена данных OBD/толщиномера
  - **Митигация**: Проверка валидности протокола; детекция аномалий (например, толщина > 5000 мкм)

#### Repudiation (Отказ)
- [ ] **R-A-01**: Оператор отрицает действия (ручная выдача устройства)
  - **Митигация**: Аудит-логи всех критичных операций с метками времени и operator_id

#### Information Disclosure (Раскрытие)
- [ ] **I-A-01**: Секреты в логах
  - **Митигация**: Redact секретов в логгере; YOOKASSA_SECRET_KEY, SUPABASE_SERVICE_ROLE_KEY не логируются
- [ ] **I-A-02**: Персональные данные в локальной БД
  - **Митигация**: Минимальное хранение; шифрование SQLite; очистка старых данных

#### Denial of Service (Отказ в обслуживании)
- [ ] **D-A-01**: Переполнение логов/памяти
  - **Митигация**: LOG_MAX_ENTRIES, LOG_ROTATE_AFTER_MS; graceful shutdown
- [ ] **D-A-02**: Зависание на долгих операциях
  - **Митигация**: Таймауты для всех I/O; retry с exponential backoff

#### Elevation of Privilege (Повышение привилегий)
- [ ] **E-A-01**: Запуск агента с root/admin правами
  - **Митигация**: Работа под ограниченной учёткой; только необходимые права (serial port, USB)

---

### 3. Cloud API

#### Spoofing (Подмена)
- [ ] **S-C-01**: Поддельные запросы от неавторизованных клиентов
  - **Митигация**: API ключи или JWT tokens; CORS whitelist

#### Tampering (Модификация)
- [ ] **T-C-01**: Изменение данных в transit
  - **Митигация**: HTTPS/TLS обязательно; HSTS header

#### Repudiation (Отказ)
- [ ] **R-C-01**: Клиент отрицает API запросы
  - **Митигация**: Логирование всех запросов с IP, User-Agent, timestamp

#### Information Disclosure (Раскрытие)
- [ ] **I-C-01**: Утечка данных через API
  - **Митигация**: Возврат только публичных VIEW; валидация input/output schemas (Zod)

#### Denial of Service (Отказ в обслуживании)
- [ ] **D-C-01**: DDoS атака на API
  - **Митигация**: Rate limiting (express-rate-limit); WAF/Cloudflare

#### Elevation of Privilege (Повышение привилегий)
- [ ] **E-C-01**: Доступ к admin endpoints без авторизации
  - **Митигация**: Role-based access control; /metrics, /admin защищены

---

### 4. Supabase (Database)

#### Spoofing (Подмена)
- [ ] **S-DB-01**: Подключение с поддельными credentials
  - **Митигация**: Service role key только на доверенных серверах; TLS для подключений

#### Tampering (Модификация)
- [ ] **T-DB-01**: SQL injection
  - **Митигация**: Parameterized queries; ORM (Supabase client); input validation
- [ ] **T-DB-02**: Изменение данных через anon key
  - **Митигация**: RLS policies; anon имеет только SELECT на публичных VIEW

#### Repudiation (Отказ)
- [ ] **R-DB-01**: Отрицание изменений в БД
  - **Митигация**: Audit triggers (created_at, updated_at); pg_audit для критичных таблиц

#### Information Disclosure (Раскрытие)
- [ ] **I-DB-01**: Чтение персональных данных через anon key
  - **Митигация**: RLS блокирует прямой доступ к таблицам; только публичные VIEW

#### Denial of Service (Отказ в обслуживании)
- [ ] **D-DB-01**: Переполнение БД
  - **Митигация**: Retention policy для логов; архивация старых данных

#### Elevation of Privilege (Повышение привилегий)
- [ ] **E-DB-01**: Escalation через SQL
  - **Митигация**: RLS на всех таблицах; минимальные права для service_role

---

### 5. Payment Provider

#### Spoofing (Подмена)
- [ ] **S-P-01**: Поддельные webhook'и
  - **Митигация**: HMAC verification; IP whitelist (если доступен)

#### Tampering (Модификация)
- [ ] **T-P-01**: Изменение суммы платежа
  - **Митигация**: Сумма фиксируется в createIntent; проверка при webhook

#### Repudiation (Отказ)
- [ ] **R-P-01**: Клиент оспаривает платёж
  - **Митигация**: Логирование payment_id, timestamps; хранение квитанций

#### Information Disclosure (Раскрытие)
- [ ] **I-P-01**: Утечка YOOKASSA_SECRET_KEY
  - **Митигация**: Хранение в vault; не логировать; ротация каждые 180 дней

#### Denial of Service (Отказ в обслуживании)
- [ ] **D-P-01**: Провайдер недоступен
  - **Митигация**: Retry с exponential backoff; fallback на ручную проверку платежей

#### Elevation of Privilege (Повышение привилегий)
- [ ] **E-P-01**: Доступ к чужим платежам через API
  - **Митигация**: Проверка ownership (session_id, payment_id)

---

### 6. OBD-II Device & Thickness Meter

#### Spoofing (Подмена)
- [ ] **S-D-01**: Подключение поддельного устройства
  - **Митигация**: Whitelist MAC/портов; проверка firmware version

#### Tampering (Модификация)
- [ ] **T-D-01**: Подмена данных от устройства
  - **Митигация**: Валидация протокола; детекция аномалий; проверка checksums

#### Repudiation (Отказ)
- [ ] **R-D-01**: Отрицание факта измерений
  - **Митигация**: Логирование raw data; timestamps; привязка к session_id

#### Information Disclosure (Раскрытие)
- [ ] **I-D-01**: Утечка данных через Bluetooth
  - **Митигация**: BLE pairing; encryption на уровне транспорта

#### Denial of Service (Отказ в обслуживании)
- [ ] **D-D-01**: Устройство зависает/отключается
  - **Митигация**: Watchdog; retry; clear error messages для клиента

#### Elevation of Privilege (Повышение привилегий)
- [ ] **E-D-01**: Выполнение команд через устройство
  - **Митигация**: Whitelist разрешённых команд; изоляция драйверов

---

### 7. Device Locks (Замки)

#### Spoofing (Подмена)
- [ ] **S-L-01**: Поддельная команда открытия замка
  - **Митигация**: Команды только от агента; физическая изоляция контроллера

#### Tampering (Модификация)
- [ ] **T-L-01**: Механическое взламывание
  - **Митигация**: Физическая защита; алерт при открытии без команды (датчики)

#### Repudiation (Отказ)
- [ ] **R-L-01**: Оператор отрицает выдачу устройства
  - **Митигация**: Логирование всех команд openSlot/closeSlot с timestamps

#### Information Disclosure (Раскрытие)
- [ ] **I-L-01**: —
  - **Митигация**: Не применимо

#### Denial of Service (Отказ в обслуживании)
- [ ] **D-L-01**: Замок заклинивает
  - **Митигация**: Механический bypass; мониторинг состояния; алерт операторам

#### Elevation of Privilege (Повышение привилегий)
- [ ] **E-L-01**: Получение устройства без оплаты
  - **Митигация**: Выдача только после подтверждённого платежа; логирование

---

## Сводная таблица приоритетов

| ID | Угроза | Компонент | Вероятность | Влияние | Приоритет | Статус |
|----|--------|-----------|-------------|---------|-----------|--------|
| S-A-01 | Поддельные webhook'и | Agent | Средняя | Высокая | **Критичный** | ✅ Митигировано |
| I-A-01 | Секреты в логах | Agent | Средняя | Критичная | **Критичный** | ✅ Митигировано |
| T-DB-02 | Изменение данных через anon | Database | Низкая | Критичная | **Высокий** | ✅ Митигировано |
| E-A-01 | Запуск с root | Agent | Низкая | Высокая | **Высокий** | 🔄 В процессе |
| D-A-02 | Зависание на операциях | Agent | Средняя | Средняя | Средний | ✅ Митигировано |
| T-D-01 | Подмена данных устройства | Device | Низкая | Средняя | Средний | 🔄 В процессе |
| D-C-01 | DDoS на API | Cloud API | Средняя | Средняя | Средний | ✅ Митигировано |
| E-L-01 | Выдача без оплаты | Locks | Низкая | Высокая | **Высокий** | ✅ Митигировано |

## Рекомендации

### Немедленные действия
1. ✅ Включить RLS на всех таблицах
2. ✅ Настроить HMAC verification для webhook'ов
3. ✅ Redact секретов в логах
4. ✅ Rate limiting на API
5. 🔄 Запуск агента под ограниченной учёткой

### Долгосрочные меры
1. Внедрение hardware security module (HSM) для ключей
2. Penetration testing перед production launch
3. Bug bounty программа после запуска
4. Регулярные security audits (ежеквартально)

## Связанные документы

- `08-security/01-interfaces/policies/` — политики безопасности
- `08-security/05-tests/` — чеклисты верификации
- `09-docs/01-interfaces/docs-root/tech/CYCLE2_SECURITY_GUIDE.md` — гид по безопасности
- `09-docs/01-interfaces/docs-root/internal/structure/blocks/threat-matrix/` — операционная матрица угроз

## Обновление модели

Этот документ должен обновляться:
- При добавлении новых компонентов
- После инцидентов безопасности
- При изменении архитектуры
- Минимум раз в квартал (review)

**Версия:** 1.0  
**Дата:** 2024-12  
**Автор:** Security Team
