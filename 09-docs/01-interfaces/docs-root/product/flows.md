# Пользовательские потоки

См. единые инструкции проекта в `.github/instructions/instructions.instructions.md` (разделы 3 и 14). Этот файл будет расширяться по мере детализации текстов и подсказок на экранах.

## Источники данных

Фронтенд поддерживает два режима работы, настраиваемых через скрытое меню настроек (Ctrl+Shift+S или кнопка ⚙️ в DEV-режиме):

### source=agent (дефолт)
- Фронтенд общается с локальным kiosk-agent по HTTP (http://localhost:7070)
- Полная функциональность: устройства, платежи, отчёты, управление
- Используется в киоске для полноценного self-service опыта
- Агент может использовать разные хранилища через `AGENT_PERSISTENCE`:
  - `memory` — InMemoryStore (для тестирования)
  - `sqlite` — локальная БД (дефолт для DEV)
  - `pg` — PostgreSQL (для локального сервера)
  - `supabase` — облачная БД через SupabaseStore (service role key)

### source=supabase (read-only)
- Фронтенд читает данные напрямую из Supabase через anon key
- Только просмотр публичных VIEW: `v_sessions_public`, `v_reports_public`, `v_equipment_status_public`
- **Девайсные операции (OBD/толщиномер) полностью заблокированы** — нет доступа к записи
- Используется для:
  - Удалённого мониторинга состояния терминалов
  - Просмотра истории сессий и отчётов
  - Дашбордов и аналитики без риска изменения данных
- Настройка через модальное окно (требует Supabase URL и Anon Key)
- Режим обозначается индикатором "☁️ Supabase (read-only)" в правом верхнем углу

**Безопасность:**
- Service Role Key используется ТОЛЬКО на серверах (kiosk-agent, cloud-api)
- Anon Key передаётся только во фронтенд для чтения публичных VIEW
- RLS политики защищают данные: anon может только SELECT из VIEW, запись через service role

### Переключение режимов

1. Откройте настройки (Ctrl+Shift+S)
2. Выберите "Источник данных"
3. При выборе Supabase — введите URL и Anon Key
4. Сохраните настройки
5. Режим сохраняется в localStorage и применяется автоматически при перезагрузке

## Экраны ядра
1. Ожидание (Attract)
2. Приветствие + Согласие (Welcome)
3. Выбор услуги (Services)

## Ветвь «Толщиномер» (черновик)
- Описание → Выбор типа авто → Контакты → QR‑оплата (в DEV — имитация) → Подготовка → Экран измерений (40–60 полей, только реальные данные) → Завершение → Отчёт.

## Ветвь «Диагностика OBD‑II» (черновик)
- Описание → Контакты → Выбор режима (Общая / OBD‑II) → Выбор авто (Toyota/Lexus) → Подготовка → Вставить адаптер → Сканирование (реальные данные) → Пейволл (в DEV — имитация) → Показ результатов → Clear DTC (опционально) → Завершение → Отчёт.