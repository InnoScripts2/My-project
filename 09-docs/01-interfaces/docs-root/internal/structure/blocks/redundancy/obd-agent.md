# Резервирование: OBD-агент

## Цель

Обеспечить непрерывность диагностики даже при отказе основного канала связи с адаптером.

## Компоненты

- Основной адаптер: ELM327 (Bluetooth Classic) → используется в `ObdConnectionManager`.
- Резервный адаптер: ELM327 USB → подключение через виртуальный COM-порт.
- Контроллер переключения: сервис `ObdConnectionManager`, расширенный модулем auto-failover.

## План действий

1. **Детектирование отказа**
   - Таймер удержания соединения → при `timeout` или `read` ошибке фиксируем инцидент.
   - Запись события в журнал (`logs/device-obd.log`).

2. **Автопереключение**
   - Попытка переподключения к Bluetooth (3 попытки).
   - Если неудачно, переключаемся на конфигурацию USB (`config/fallbacks/obd-usb.json`).

3. **Проверка работоспособности**
   - Выполнить команду `ATZ` и базовое чтение VIN.
   - При успехе отмечаем режим `degraded` (работаем на резерве).

4. **Восстановление основного канала**
   - Каждые 5 минут пробуем обнаружить Bluetooth-адаптер.
   - После успешного подключения возвращаемся в режим `primary`.

## Требуемые доработки

- Добавить в `ObdConnectionManager` поддержку нескольких транспортов и флаг режима.
- Создать конфигурационные файлы транспорта (`primary`, `backup`).
- Настроить уведомления (UI или лог) о переходе на резерв.
- Подготовить тестовые сценарии (см. `../threat-matrix/README.md`, запись TM-001).
