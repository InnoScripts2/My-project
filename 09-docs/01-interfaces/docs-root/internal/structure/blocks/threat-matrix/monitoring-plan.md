# План мониторинга угроз

## Метрики агентского уровня

| Метрика | Источник | Назначение | Порог/алерты |
| --- | --- | --- | --- |
| `obd.disconnected_count` | сервис `ObdConnectionManager` | Отслеживание частоты обрывов связи с OBD | Алерт при >3 разрывах за 10 мин. |
| `thickness.measurement_errors` | модуль толщиномера | Контроль качества замеров | Алерт при >2 ошибках за сессию. |
| `payments.pending_over_90s` | платежный модуль | Непоступившие подтверждения оплат | Алерт при >=1 записи. |
| `power.voltage_drop` | `PowerStatusService` | Просадки напряжения | Алерт при напряжении <200В более 5 сек. |
| `data.access_anomaly` | модуль аудита данных | Подозрительные обращения к данным клиентов | Алерт при выходе за профиль поведения. |

## Логи и аудит

- `logs/device-obd.log` — фиксировать коды ошибок подключения, идентификаторы адаптеров.
- `logs/device-thickness.log` — хранить калибровочные значения и статусы датчиков.
- `logs/payments-fallback.log` — документировать ручные подтверждения и причины.
- `logs/power.log` — сохранять события перехода на резервное питание.
- `logs/data-access.log` — аудит чтения персональных данных (IP, пользователь, время).

## Визуализация и алерты

1. Настроить дашборд (Grafana/Prometheus) с перечисленными метриками.
2. Определить каналы уведомлений: `#kiosk-alerts`, SMS оператору.
3. Ввести недельный отчёт: экспортировать метрики и обсуждать на ретро.

## Интеграция

- `/metrics` — Prometheus-совместимый экспорт (через `prom-client`), включает системные и платежные показатели.
- `/payments/metrics` — JSON-снимок для быстрой проверки в DEV (оставляем до подключения внешнего мониторинга).
- Юнит-тесты генерации алертов: `apps/kiosk-agent/src/monitoring/__tests__/alerts.test.ts`.

## TODO

- Подключить систему оповещений (PagerDuty или аналог) для критичных событий.
