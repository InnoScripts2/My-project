---
status: draft
owner: GitHub Copilot
created: 2025-09-30
tags:
  - internal
  - maintenance
  - monitoring
---

# Watchdog: расширенный журнал самопроверки устройств

## 1. Контекст и обоснование
- Ежедневные проверки готовности устройств (толщиномер, OBD-адаптер) пока не фиксируются централизованно.
- Отсутствие истории self-check затрудняет анализ плавающих сбоев и прогнозирование замены оборудования.
- Инициатива IMP-2025-09-30-02 предполагает формирование журнала с временными метками, статусом и диагностическими данными.

## 2. Цели и критерии успеха
- **Primary KPI:** 100% self-check запусков сохраняют структурированную запись в журнале.
- **Secondary KPI:** Среднее время расследования инцидента устройства ≤ 15 минут (за счёт наличия истории).
- **Definition of Done:**
  - Агент проводит self-check по расписанию/по требованию и пишет результаты в JSONL.
  - Документация описывает формат лога и процесс реагирования.
  - Watchdog-скрипт отслеживает свежесть записей и сигнализирует, если self-check не выполнялся дольше заданного порога.

## 3. Область ответственности
| Компонент/зона | Ответственный | Описание вклада |
| --- | --- | --- |
| `apps/kiosk-agent/` | GitHub Copilot | Реализация API self-check и запись результатов |
| `infra/scripts/service-watchdog.ps1` | GitHub Copilot | Дополнение проверки на свежесть self-check лога |
| `docs/internal/autonomous-updates/` | GitHub Copilot | Актуализация инструкций и журнала инцидентов |

## 4. План работ
| Этап | Задачи | Артефакты | Дата-цель |
| --- | --- | --- | --- |
| 1. Анализ | Описать требования к self-check, определить формат JSONL, подготовить контракт и схему | `docs/internal/autonomous-updates/drafts/2025-09-watchdog-self-check-log.md` (текущий документ) | 2025-10-02 |
| 2. Реализация агента | Добавить модуль self-check, логгер, управление тайм-аутами (стартовано: базовый модуль, запись OBD результатов в JSONL из API и CLI от 2025-09-30) | `apps/kiosk-agent/src/selfcheck/`, обновлённые тесты | 2025-10-09 |
| 3. Watchdog и алерты | Поддерживать PowerShell-скрипт (watchdog создан), подготовить схему алертов/уведомлений, ротацию и отчётность | `infra/scripts/service-watchdog.ps1`, `infra/scripts/self-check-maintenance.cjs`, `infra/scripts/self-check-report.cjs`, схема алертов | 2025-10-12 |
| 4. Документы и запуск | Обновить README, чек-лист, журнал; провести пробный прогон | Обновлённые документы, запись в `log.md` | 2025-10-13 |

## 5. Контроль качества
- Проверки линтов/тестов: `npm run lint`, unit-тесты для self-check модуля (будут добавлены).
- Ревью документации: сверка `docs/internal/autonomous-updates/README.md` и `docs/internal/checklist.md`.
- Дополнительные проверки: ручной запуск self-check и валидация структуры JSONL.

## 6. Риски и меры реагирования
| Риск | Вероятность | Влияние | План предотвращения | План реагирования |
| --- | --- | --- | --- | --- |
| Недоступность устройств в момент self-check | Средняя | Среднее | Планировать self-check вне активной сессии клиента, настраивать тайм-ауты | Повторный self-check с повышенным логированием, уведомление владельца |
| Рост объёма логов | Низкая | Среднее | Настроить ротацию JSONL раз в 30 дней (`infra/scripts/self-check-maintenance.cjs`) и регулярные отчёты (`infra/scripts/self-check-report.cjs`) | Архивировать старые записи, компрессия |
| Ошибки PowerShell watchог-скрипта | Средняя | Высокое | Автотест на ключевые сценарии, ревью обновлений | Откат скрипта, ручной мониторинг до фикса |

## 7. Связанные документы
- `docs/internal/autonomous-updates/README.md` — разделы «Мониторинг и телеметрия», «Протокол ведения журнала».
- `docs/internal/autonomous-updates/log.md` — статус инициативы и ссылки на артефакты.
- `docs/internal/improvement-backlog.md` — элемент IMP-2025-09-30-02.

## 8. История правок
| Дата | Автор | Сводка |
| --- | --- | --- |
| 2025-09-30 | GitHub Copilot | Создан черновик плана self-check журнала |
| 2025-09-30 | GitHub Copilot | Добавлен модуль `selfcheck/` в агенте и прототип логгера с интеграцией HTTP-эндпоинта |
| 2025-09-30 | GitHub Copilot | CLI `devices/obd/runSelfCheck.ts` сохраняет результаты self-check в JSONL |
| 2025-09-30 | GitHub Copilot | Создан PowerShell-скрипт watchdog для проверки свежести self-check JSONL и статусов |
| 2025-09-30 | GitHub Copilot | Добавлен скрипт обслуживания self-check журнала с поддержкой dry-run/backup |
| 2025-09-30 | GitHub Copilot | Реализован отчёт self-check (JSON/CLI summary) для мониторинга трендов |
