# План интеграции адаптера KINGBOLEN Ediag

- **Дата:** 2025-09-30
- **Статус:** draft
- **Ответственный:** GitHub Copilot (автономные обновления)
- **Связанные материалы:** `research-notes/2025-09-kingbolen-ediag.md`

## 1. Цели
- Перейти на адаптеры KINGBOLEN Ediag (линейка Ediag / Plus / Elite) для диагностики OBD-II/UDS.
- Обеспечить стабильную работу Bluetooth-транспорта в киоске и интегрировать устройство в существующую архитектуру self-check.
- Поддержать расширенные протоколы (CAN-FD, DoIP, FCA AutoAuth) в roadmap без нарушения текущих SLA.

## 2. Этапы и контрольные точки
| Этап | Срок | Ответственный | Результат |
| --- | --- | --- | --- |
| 1. Подготовка стенда | 2025-10-03 | DevOps | Android 8 стенд с адаптером, логирование BT и автоподключение |
| 2. Смоук-тесты ELM327 | 2025-10-07 | Embedded/OBD | Протокол и задержки зафиксированы, автоматические сценарии подтверждены |
| 3. Интеграция транспорта | 2025-10-14 | Backend | Новый транспорт `EdiagBluetoothTransport` + keep-alive + авто-реконнект |
| 4. Self-check & Watchdog | 2025-10-17 | Ops | Обновлён `self-check-trigger`, отчёты фиксируют задержки/ошибки, автотесты без ручного ввода |
| 5. Пилот на Toyota/Lexus | 2025-10-21 | QA Field | Протоколы ISO 15765-4 и ISO 14230-4 подтверждены, лог DTC |
| 6. Документация и roll-out | 2025-10-24 | Docs | Обновлены инструкции, чек-листы, обучение персонала |

## 3. Область работ
- **Транспорт:** Android Bluetooth Classic API, автоматическое переподключение, фильтрация шумов.
- **Драйвер OBD:** расширение `apps/kiosk-agent/src/devices/obd` для поддержки keep-alive, таймаутов и мультикадров ISO-TP.
- **Self-check:** добавление тестов команд `ATZ`, `ATI`, `0100`, `03`, `04`, публикуем метрики в отчёты.
- **Логи и мониторинг:** метрики задержек, количество переподключений, fail rate команд.
- **Документация:** обновление `docs/product/flows.md` (OBD ветка), операции в `docs/internal/checklist.md`, обучение в `docs/internal/training`.
- **Автоматизация:** все этапы подключения, выбора протокола и запуска диагностики выполняются агентом; будущая админ-панель получит ручные переключатели отдельно.

## 4. Требования и ограничения
- Минимальная версия Android киоска — 8.0 (API 26); нужны разрешения на Bluetooth + локализацию (для BLE).
- Таймауты команд: 10 с на ответ, 30 с на reconnect. Keep-alive каждые 45 с.
- Нельзя запускать параллельные диагностические запросы — драйвер должен сериализовать обращения.
- Отчёт Self-check обновляется только при наличии реального адаптера (dev-режим — ручной override).
- FCA AutoAuth: подготовить аккаунт и тестовую машину до этапа 5.
- Клиентский UI не должен требовать ручного участия в подключении адаптера; служебные настройки выводятся в будущую админ-панель.

## 5. Риски
- Неожиданные ограничения фирменной прошивки (блокировка стороннего ПО) → митигируем контрольной проверкой на этапе 2.
- Падение соединения при длительных сессиях → усилить watchdog, добавить backoff переподключения.
- Отсутствие CAN-FD/DoIP без обновлений → планируем как отдельный follow-up (фича-флаг).

## 6. Метрики успеха
- Успешное прохождение self-check (команды `ATZ`, `ATI`, `0100`, чтение/очистка DTC) ≥99% попыток.
- Средняя задержка ответа ≤600 мс, стандартное отклонение ≤150 мс.
- Количество переподключений за сессию ≤1 при тестах длительностью 30 минут.
- Документация и чек-листы обновлены, персонал прошёл инструктаж (запись в `training/schedule.md`).

## 7. Follow-up
- Исследовать интеграцию `packages/uds-c` для полноценной поддержки UDS (многокадровых запросов и CAN-FD/DoIP).
- Подготовить скрипт экспорта логов задержек в BI.
- Рассмотреть сертификацию адаптера в стандартах безопасности киоска.
