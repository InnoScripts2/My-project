# Оперативный план: ежедневное обслуживание self-check журнала

**Дата:** 2025-09-30
**Статус:** draft
**Ответственный:** GitHub Copilot
**Связанные артефакты:**
- `infra/scripts/self-check-daily.ps1`
- `infra/scripts/self-check-maintenance.cjs`
- `infra/scripts/service-watchdog.ps1`
- `infra/scripts/self-check-report.cjs`
- `docs/internal/autonomous-updates/README.md`
- `docs/internal/autonomous-updates/log.md`

## 1. Контекст

Сформирован стек вспомогательных утилит для контроля self-check журнала:
- `self-check-maintenance.cjs` очищает устаревшие записи.
- `service-watchdog.ps1` проверяет свежесть и статус последней записи.
- `self-check-report.cjs` строит агрегированную сводку.

Новый скрипт `self-check-daily.ps1` должен запускаться по расписанию и последовательно вызывать все инструменты, возвращая единый код завершения и дружелюбный вывод. Требуется описать регламент и подготовить шаги внедрения.

## 2. Цели

1. Автоматизировать ежедневный прогон обслуживания журнала self-check.
2. Обеспечить прозрачные оповещения при устаревших или проблемных записях.
3. Сохранять текстовый и JSON-отчёт каждого прогона в локальном артефакте.

## 3. Предпосылки

- Node.js ≥ 20 установлен и доступен в `PATH`.
- PowerShell 7 (pwsh.exe) установлен и разрешён к запуску скриптов.
- Репозиторий киоска доступен на пути `C:\kiosk\repo` (настроить по фактическому расположению).
- Self-check журнал хранится в `artifacts/logs/selfcheck/self-check.log.jsonl` (можно переопределить через `SELF_CHECK_LOG_FILE`).
- Оборудование OBD self-check проводит минимум одну проверку в сутки (по отдельному расписанию или вручную).

## 4. Пошаговый сценарий

1. **OBD self-check перед оркестратором**
   - Настроить ежедневный запуск `infra/scripts/self-check-trigger.ps1` (07:15) с параметрами `-Port`, `-Attempts`, `-AgentEnv`, `-LogDir`.
   - Проверять код возврата (`0` — успех, `2` — диагностика не прошла, ≥3 — ошибка запуска) и фиксировать отклонения в журнале.
2. **Подготовка директорий**
   - Убедиться, что `artifacts/logs/selfcheck/` существует. Скрипт создаёт каталог автоматически, но рекомендуется проверить права доступа.
3. **Сухой прогон**
   - Выполнить `pwsh -NoProfile -File infra/scripts/self-check-daily.ps1 -DryRun -EmitJson` и убедиться, что вывод корректно отображает шаги и коды возврата.
4. **Базовая конфигурация**
   - Определить параметры: `RetentionDays` (по умолчанию 30) и `MaxAgeMinutes` (по умолчанию 60). Зафиксировать значения в журнале.
5. **Настройка Task Scheduler**
   - Создать задачу с правами администратора:
       ```powershell
       SCHTASKS /Create /TN "Kiosk Self-Check Daily" /SC DAILY /ST 07:30 /RL HIGHEST /TR "pwsh -NoProfile -ExecutionPolicy Bypass -File `"C:\\kiosk\\repo\\infra\\scripts\\self-check-daily.ps1`" -Quiet -EmitJson -SummaryFile `"C:\\kiosk\\repo\\artifacts\\logs\\selfcheck\\daily-summary.jsonl`""
       ```
   - Проверить свойства задачи: включён флажок "Запускать с наивысшими правами", указана служебная учётная запись киоска.
6. **Тест расписания**
   - Выполнить ручной запуск задачи из Task Scheduler и удостовериться, что создаётся новая строка в `daily-summary.jsonl`.
   - Проверить код возврата задачи (0 — успех, 1 — предупреждение). При коде 1 инициировать ручной self-check.
7. **Мониторинг и алерты**
   - Подготовить правило: код `1` => предупреждение, код `≥2` => критическая ошибка. Согласовать канал уведомлений (email/SMS/локальный дисплей).
   - Добавить в журнал `docs/internal/autonomous-updates/log.md` ссылку на последние предупреждения.
8. **Архивация отчетов**
   - Раз в неделю выполнять `Compress-Archive` для накопленных `daily-summary.jsonl` и перемещать архив в `artifacts/logs/selfcheck/archive/`.

## 5. Критерии готовности

- Задача в Task Scheduler выполняется без ошибок в течение трёх последовательных дней.
- Последняя запись журнала self-check не старше `MaxAgeMinutes` + 10% буфера.
- `daily-summary.log` содержит JSON-объекты с полями `checkedAt`, `steps`, `summary`.
- Предупреждения и ошибки фиксируются в журнале внутренних обновлений.

## 6. Follow-up

- Поддерживать актуальность расписания `self-check-trigger.ps1` (порт, попытки, окружение).
- Настроить автоматическую выгрузку `daily-summary.log` в ежемесячный отчет.
- Рассмотреть отправку JSON-вывода на локальный REST-эндпоинт мониторинга.
- Добавить smoke-тест на PowerShell-скрипт в будущий набор автоматизированных проверок.

## 7. История изменений

| Дата | Автор | Изменение |
| --- | --- | --- |
| 2025-09-30 | GitHub Copilot | Черновик плана: расписание, команда Task Scheduler, критерии готовности |
