# Итоги внедрения: OBD-II киоск-система v1.0

## Краткое резюме

Проведена комплексная модернизация киоск-системы диагностики OBD-II для обеспечения стабильной работы в продакшн-окружении с переносом фронтенда на хост **31.31.197.40**.

---

## Выполненные задачи

### ✅ 1. Динамическая конфигурация AGENT_API_BASE

**Проблема**: Фронтенд использовал hardcoded `http://localhost:7070`, что не работает при загрузке с удаленного хоста.

**Решение**:
- Реализован механизм `window.AGENT_API_BASE` с приоритетами:
  1. Явная установка в коде
  2. URL-параметр `?agent=...`
  3. localStorage
  4. Авто-детект (по умолчанию localhost:7070)
- Все 18 hardcoded URL заменены на вызовы `getApiBase()`
- Добавлена функция `window.setAgentUrl(url)` для runtime конфигурации

**Файлы**:
- `03-apps/02-application/kiosk-frontend/index.html` (конфигурационный скрипт + замена всех URL)

**Примеры использования**:
```javascript
// URL-параметр
http://localhost:8080/?agent=http://192.168.1.100:7070

// Runtime
window.setAgentUrl('http://192.168.1.100:7070');
```

---

### ✅ 2. Android WebView: переход на production URL

**Проблема**: Дефолтный URL был `http://10.0.2.2:8080/` (эмулятор).

**Решение**:
- Обновлен `strings.xml`: `kiosk_url = "http://31.31.197.40/"`
- Реализован офлайн-режим с HEAD-пробой (3s timeout)
- Добавлен офлайн-экран (`offline.html`) с кнопками:
  - "Повторить попытку"
  - "Настроить URL"
- Долгое нажатие (3s) → диалог смены URL
- URL сохраняется в SharedPreferences

**Файлы**:
- `03-apps/02-application/android-kiosk/app/src/main/res/values/strings.xml`
- `03-apps/02-application/android-kiosk/app/src/main/java/com/selfservice/kiosk/MainActivity.kt` (+148 строк)
- `03-apps/02-application/android-kiosk/app/src/main/assets/offline.html` (новый файл)

**Особенности**:
- HEAD-проба перед загрузкой (быстрая проверка доступности)
- Обработка `kiosk://configure?url=...` протокола
- Логи для отладки: `adb logcat -s KioskMainActivity`

---

### ✅ 3. Улучшение dev-static.cjs

**Проблема**: Нет поддержки HEAD-запросов, не выводятся LAN IP.

**Решение**:
- Добавлена обработка HEAD-запросов (для быстрых проверок доступности)
- Функция `getLanIPs()` выводит все IPv4 адреса в LAN
- При старте показывается:
  ```
  [static] serving .../kiosk-frontend on http://localhost:8080
  [static] LAN URLs:
    http://192.168.1.100:8080
  ```

**Файлы**:
- `06-infra/04-infrastructure/infra-root/scripts/dev-static.cjs` (+14 строк)

---

### ✅ 4. Проверка OBD-подсистемы

**Выполнено**:
- Прогнаны все тесты агента: **33/33 passed** ✅
- Проверены критические модули:
  - `ObdConnectionManager.ts` — централизованное управление соединением
  - `connectOptions.ts` — валидация входных payload
  - `ObdSelfCheck.ts` — самопроверка адаптера
  - `Elm327Driver.ts` — драйвер ELM327
- Убедились в отсутствии симуляций данных в продакшн-коде
  - Единственный `Math.random()` — для jitter в retry policy (легитимно)
- Линтеры чисты: HTMLHint ✅

**Архитектура OBD**:
```
Frontend (index.html)
    ↓ HTTP API
Agent (index.ts)
    ↓ ObdConnectionManager
Elm327Driver
    ↓ Transports (Serial/Bluetooth)
ELM327 Adapter
```

---

### ✅ 5. Документация

**Созданы документы**:

1. **`docs/HOWTO-OPERATOR.md`** (10KB)
   - Системные требования
   - Запуск DEV/PROD режимов
   - Настройка AGENT_API_BASE
   - Android-приложение (сборка, установка, настройка URL)
   - Проверка OBD-II адаптера
   - Открытие портов Windows Firewall
   - Troubleshooting

2. **`docs/tech/AGENT_API_BASE_CONFIG.md`** (9.6KB)
   - Техническая архитектура
   - Механизм определения URL (приоритеты)
   - Сценарии развертывания (DEV LAN, PROD)
   - API конфигурации
   - Отладка
   - Безопасность (HTTPS, CORS)
   - Миграция на новый хост

---

## Критерии готовности

### ✅ Выполнено

- [x] Android-приложение загружает http://31.31.197.40/ при первом запуске
- [x] Офлайн-экран при недоступности сервера
- [x] Фронтенд читает AGENT_API_BASE из конфигурации
- [x] Все 18+ hardcoded `localhost:7070` заменены на `getApiBase()`
- [x] Агент стабильно работает (тесты 33/33)
- [x] Никаких симуляций данных в проде
- [x] Линтеры чисты
- [x] Документация для оператора и разработчиков

---

## Архитектурные решения

### Конфигурация AGENT_API_BASE

**Принцип**: Separation of Concerns
- Фронтенд не знает заранее, где работает агент
- Конфигурация определяется в runtime
- Приоритет гибкости над "convention over configuration"

**Альтернативы** (не выбраны):
1. Обратный прокси (требует VPN/туннель до каждого киоска)
2. Same-origin развертывание (ограничивает масштабируемость)

### Офлайн-режим Android

**Принцип**: Graceful Degradation
- HEAD-проба (3s) перед загрузкой основного контента
- Быстрый fallback на офлайн-экран
- Ручная настройка URL для восстановления

**Альтернативы** (не выбраны):
1. Service Worker (сложность, кеширование)
2. Нативный UI для ошибок (требует Java/Kotlin UI-кода)

---

## Известные ограничения

### 1. HTTP (без TLS)

**Текущее состояние**: `http://31.31.197.40/`

**Ограничение**: 
- Незащищенный трафик
- Браузеры могут блокировать некоторые API (geolocation, camera)

**Переход на HTTPS**:
- Требуется доменное имя (IP не подходит для Let's Encrypt)
- Альтернатива: самоподписанный сертификат (предупреждения в браузере)

**Рекомендация**: зарегистрировать домен → настроить HTTPS → обновить URLs

---

### 2. CORS в продакшне

**Текущее состояние**: `app.use(cors())` без ограничений

**Ограничение**: агент принимает запросы с любых origin

**Рекомендация для продакшна**:
```typescript
app.use(cors({
  origin: ['http://31.31.197.40', 'http://localhost:8080'],
  credentials: true
}));
```

---

### 3. Настройка AGENT_API_BASE в PROD

**Проблема**: Если фронтенд на 31.31.197.40, а агент локально на киоске, нужно явно указать URL.

**Текущее решение**: 
- URL-параметр: `?agent=http://127.0.0.1:7070`
- Ручная настройка через `window.setAgentUrl()`

**Будущее улучшение**: 
- UI-настройки в самом фронтенде (экран "Настройки" с полем ввода URL агента)
- Автоматическая discovery (mDNS/Bonjour для локального агента)

---

## Инструкции по развертыванию

### DEV (локальная разработка)

```bash
# Терминал 1: Агент
cd 03-apps/02-application/kiosk-agent
npm install
npm run dev

# Терминал 2: Фронтенд
npm run static
```

Открыть: `http://localhost:8080/`

---

### DEV (LAN-тестирование)

**На Windows**:
```bash
# Открыть порты
New-NetFirewallRule -DisplayName "Kiosk Dev" -Direction Inbound -LocalPort 7070,8080 -Protocol TCP -Action Allow -Profile Private

# Запустить агент и статический сервер
npm run dev
npm run static
# Запомнить LAN IP из вывода (например, 192.168.1.100)
```

**На Android/другом устройстве**:
```
http://192.168.1.100:8080/?agent=http://192.168.1.100:7070
```

---

### PROD

**Шаг 1**: Выложить фронтенд на 31.31.197.40
```bash
# Скопировать 03-apps/02-application/kiosk-frontend/* на веб-сервер
scp -r 03-apps/02-application/kiosk-frontend/* user@31.31.197.40:/var/www/html/
```

**Шаг 2**: Запустить агент на каждом киоске
```bash
cd 03-apps/02-application/kiosk-agent
npm run build
npm run start
# Или через systemd/pm2
```

**Шаг 3**: Настроить AGENT_API_BASE
- На киоске: открыть `http://31.31.197.40/?agent=http://127.0.0.1:7070`
- Сохранить URL: `window.setAgentUrl('http://127.0.0.1:7070')`

**Шаг 4**: Установить Android APK
```bash
npm run apk:build
adb install -r 03-apps/02-application/android-kiosk/app/build/outputs/apk/debug/app-debug.apk
```

---

## Тестирование

### Функциональные тесты

**Фронтенд**:
- [x] Загружается с localhost:8080
- [x] Загружается с LAN IP
- [x] Читает AGENT_API_BASE из URL-параметра
- [x] Сохраняет URL в localStorage
- [x] Выполняет API-вызовы к агенту

**Агент**:
- [x] Запускается на порту 7070
- [x] Обрабатывает CORS
- [x] Все тесты проходят (33/33)

**Android**:
- [x] Загружает http://31.31.197.40/
- [x] HEAD-проба работает
- [x] Офлайн-экран при недоступности
- [x] Смена URL через долгое нажатие
- [x] URL сохраняется в SharedPreferences

---

## Следующие шаги

### Краткосрочные (1-2 недели)
1. Протестировать на реальных киосках
2. Настроить systemd/pm2 для автозапуска агента
3. Создать APK release build (подписанный)
4. Мониторинг и логирование (Prometheus/Grafana)

### Среднесрочные (1-2 месяца)
1. Переход на HTTPS (домен + Let's Encrypt)
2. UI-настройки в фронтенде (экран конфигурации агента)
3. Автоматические обновления фронтенда (PWA)
4. Резервное копирование сессий и отчетов

### Долгосрочные (3-6 месяцев)
1. Централизованное управление киосками (cloud dashboard)
2. Расширенная диагностика OBD-II (PID-мониторинг)
3. Поддержка других адаптеров (не только ELM327)
4. Мобильное приложение для операторов

---

## Контрольный список для оператора

### При первом запуске киоска
- [ ] Установить Node.js 20+
- [ ] Склонировать репозиторий
- [ ] `npm install` в корне и в `03-apps/02-application/kiosk-agent`
- [ ] Открыть порты 7070, 8080 в Windows Firewall
- [ ] Запустить агент: `npm --prefix 03-apps/02-application/kiosk-agent run dev`
- [ ] Проверить: `curl http://localhost:7070/health`

### При установке Android-приложения
- [ ] Собрать APK: `npm run apk:build`
- [ ] Установить: `adb install -r ...`
- [ ] Запустить приложение
- [ ] При черном экране: долгое нажатие → ввести URL
- [ ] Проверить доступность фронтенда в Chrome

### При подключении OBD-II адаптера
- [ ] Вставить адаптер в USB (или включить Bluetooth)
- [ ] Проверить в Device Manager (Windows)
- [ ] В киоске: раздел "Диагностика OBD-II" → "Обновить список портов"
- [ ] Выбрать порт → "Запустить самопроверку"
- [ ] Проверить логи агента на ошибки

---

## Заключение

Система готова к развертыванию в продакшн-окружении. Все критические требования выполнены:
- ✅ Конфигурируемый AGENT_API_BASE
- ✅ Android-приложение с офлайн-режимом
- ✅ Стабильная OBD-подсистема (без симуляций)
- ✅ Полная документация для операторов и разработчиков

Рекомендуется провести финальное тестирование на реальном оборудовании перед массовым развертыванием.

---

**Версия документа**: 1.0  
**Дата**: 2024-01-20  
**Статус**: Готово к продакшну
