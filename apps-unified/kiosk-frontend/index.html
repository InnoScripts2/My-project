<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–ê–≤—Ç–æ—Å–µ—Ä–≤–∏—Å —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./styles.css" />
    <link rel="manifest" href="./manifest.webmanifest" />
    <meta name="theme-color" content="#0b1020" />
  <script type="module" src="./assets/supabase-client.js"></script>
  <script type="module" src="./assets/supabase-init.js"></script>
  </head>
  <body>
    <div id="app" class="app">
      <!-- Screen: Attract -->
  <section id="screen-attract" class="screen active" tabindex="0">
        <div class="center">
          <h1 class="brand">
            <span class="brand-line brand-top">–ê–≤—Ç–æ—Å–µ—Ä–≤–∏—Å</span>
            <span class="brand-line brand-bottom">—Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è</span>
          </h1>
          <div class="cta subtle">–ù–∞–∂–º–∏—Ç–µ –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ</div>
        </div>
      </section>

      <!-- Screen: Welcome & Terms -->
      <section id="screen-welcome" class="screen">
        <div class="center narrow">
          <div class="eyebrow">–°–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</div>
          <h2>–ë—ã—Å—Ç—Ä–æ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–≤—Ç–æ –±–µ–∑ –æ—á–µ—Ä–µ–¥–µ–π –∏ –æ–∂–∏–¥–∞–Ω–∏–π</h2>
          <p class="lead">–ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ–º –∫–∏–æ—Å–∫, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å –∑–∞ —Å—á–∏—Ç–∞–Ω–Ω—ã–µ –º–∏–Ω—É—Ç—ã. –ù–∏–∫–∞–∫–∏—Ö –æ—á–µ—Ä–µ–¥–µ–π, –∑–≤–æ–Ω–∫–æ–≤ –∏ –ª–∏—à–Ω–∏—Ö —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–µ–π. –ü—Ä–æ—Å—Ç–æ –ø–æ–¥—Ö–æ–¥–∏—Ç–µ –∏ –Ω–∞—á–∏–Ω–∞–π—Ç–µ. –¢–µ—Ä–º–∏–Ω–∞–ª —Å–∞–º –≤—ã–¥–∞—ë—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ. –ë–æ–ª—å—à–∏–µ –ø–æ–Ω—è—Ç–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –≤–µ–¥—É—Ç –≤–∞—Å —à–∞–≥ –∑–∞ —à–∞–≥–æ–º. –¢–æ–ª—â–∏–Ω–æ–º–µ—Ç—Ä –±—ã—Å—Ç—Ä–æ –≤—ã—è–≤–∏—Ç –ø–µ—Ä–µ–∫—Ä–∞—Å—ã –∏ —Å–ª–µ–¥—ã —Ä–µ–º–æ–Ω—Ç–∞. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ OBD‚ÄëII –ø–æ–∫–∞–∂–µ—Ç –∫–æ–¥—ã –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–µ–π –∏ —Å—Ç–∞—Ç—É—Å—ã —Å–∏—Å—Ç–µ–º. –í—ã –≤–∏–¥–∏—Ç–µ —Ç–æ–ª—å–∫–æ —è—Å–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ –∂–∞—Ä–≥–æ–Ω–∞. –ö–∞–∂–¥—ã–π —à–∞–≥ –∑–∞–Ω–∏–º–∞–µ—Ç –º–∏–Ω–∏–º—É–º –≤—Ä–µ–º–µ–Ω–∏ –∏ –¥–∞—ë—Ç –º–∞–∫—Å–∏–º—É–º –ø–æ–ª—å–∑—ã. –û–ø–ª–∞—Ç–∞ –ø–æ QR ‚Äî –ø—Ä–∏–≤—ã—á–Ω–æ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ.</p>
          <p class="muted-note">–ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—è–≤–ª—è—é—Ç—Å—è —Å—Ä–∞–∑—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ. –ü–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ email. –ï–≥–æ —É–¥–æ–±–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–¥–∞–≤—Ü—É, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –º–∞—Å—Ç–µ—Ä—É. –ú—ã –±–µ—Ä–µ–∂–Ω–æ –æ—Ç–Ω–æ—Å–∏–º—Å—è –∫ –¥–∞–Ω–Ω—ã–º –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ–º –∏—Ö –ø–æ—Å–ª–µ –¥–æ—Å—Ç–∞–≤–∫–∏ –æ—Ç—á—ë—Ç–∞. –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–æ–∑–¥–∞–Ω –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –æ–ø—ã—Ç–∞ ‚Äî –¥–∞–∂–µ –µ—Å–ª–∏ –≤—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–µ–ª–∞–ª–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Toyota –∏ Lexus —É–∂–µ –≤–Ω—É—Ç—Ä–∏, –∞ —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è. –í—Å–µ —à–∞–≥–∏ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã: –≤–∏–¥–Ω–æ —Å—Ç–∞—Ç—É—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è. –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫ –≤–æ–ø—Ä–æ—Å, –ø–æ–¥—Å–∫–∞–∑–∫–∞ –≤—Å–µ–≥–¥–∞ –ø–æ–¥ —Ä—É–∫–æ–π –Ω–∞ –∫–∞–∂–¥–æ–º —ç–∫—Ä–∞–Ω–µ. –ù–∞—á–Ω–∏—Ç–µ —Å–µ–π—á–∞—Å ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –µ—â—ë –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—ã–ª–∞ —Ç–∞–∫–æ–π –ø—Ä–æ—Å—Ç–æ–π.</p>
          <ul class="checklist">
            <li><strong>–¢–æ–ª—â–∏–Ω–æ–º–µ—Ä –õ–ö–ü:</strong> 40‚Äì60 —Ç–æ—á–µ–∫ –∏–∑–º–µ—Ä–µ–Ω–∏–π ‚Äî –ø–æ–º–æ–≥–∞–µ—Ç —É–≤–∏–¥–µ—Ç—å –ø–µ—Ä–µ–∫—Ä–∞—Å—ã –∏ —à–ø–∞–∫–ª—ë–≤–∫—É.</li>
            <li><strong>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ OBD‚ÄëII:</strong> —á—Ç–µ–Ω–∏–µ –∫–æ–¥–æ–≤ DTC –∏ —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–∏—Å—Ç–µ–º –±–µ–∑ –ø–æ—Å–µ—â–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞.</li>
            <li><strong>–û–ø–ª–∞—Ç–∞ –ø–æ QR:</strong> –±—ã—Å—Ç—Ä–æ –∏ –ø—Ä–∏–≤—ã—á–Ω–æ. –í –ø—Ä–æ–¥–∞–∫—à–Ω–µ ‚Äî —á–µ—Ä–µ–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä.</li>
            <li><strong>–ü–æ–Ω—è—Ç–Ω—ã–µ –∏—Ç–æ–≥–∏:</strong> –∫—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥ –∏ –ø–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã.</li>
          </ul>
          <div class="consent">
            <label class="checkbox">
              <input id="welcome-agree" type="checkbox" />
              <span>–Ø –ø—Ä–∏–Ω–∏–º–∞—é <button type="button" id="open-terms-link" class="link">—É—Å–ª–æ–≤–∏—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è</button></span>
            </label>
          </div>
          <div class="actions column">
            <button class="primary" id="welcome-continue" disabled>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
          </div>
        </div>
      </section>

      <section id="screen-services" class="screen">
        <div class="center narrow">
          <h2>–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É</h2>
          <p class="lead">–¢–µ—Ä–º–∏–Ω–∞–ª –ø–æ–¥—Å–∫–∞–∂–µ—Ç –∫–∞–∂–¥—ã–π —à–∞–≥ –∏ —Å—Ä–∞–∑—É –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç –æ—Ç—á—ë—Ç. –í—ã–±–µ—Ä–∏—Ç–µ, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å.</p>
          <p class="muted-note">–ö–∞–∂–¥–∞—è —É—Å–ª—É–≥–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –≤ —Å—Ä–µ–¥–Ω–µ–º 8‚Äì12 –º–∏–Ω—É—Ç –∏ –≤–∫–ª—é—á–∞–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: –≥–¥–µ –∏—Å–∫–∞—Ç—å —Ä–∞–∑—ä—ë–º—ã, –∫–∞–∫ –¥–µ—Ä–∂–∞—Ç—å –¥–∞—Ç—á–∏–∫–∏ –∏ —á—Ç–æ –æ–∑–Ω–∞—á–∞—é—Ç —Å—Ç–∞—Ç—É—Å—ã —Å–∏—Å—Ç–µ–º –∞–≤—Ç–æ–º–æ–±–∏–ª—è.</p>
          <div class="cards two" id="service-options">
            <div class="card selectable service-card" data-service="thickness" role="button" tabindex="0" aria-pressed="false">
              <div class="card-title">–¢–æ–ª—â–∏–Ω–æ–º–µ—Ç—Ä–∏—è –õ–ö–ü</div>
              <div class="card-desc">40‚Äì60 —Ç–æ—á–µ–∫ –∏–∑–º–µ—Ä–µ–Ω–∏–π –ø–æ –∫—É–∑–æ–≤—É</div>
              <div class="card-price">–æ—Ç 350 ‚ÇΩ</div>
            </div>
            <div class="card selectable service-card" data-service="diagnostics" role="button" tabindex="0" aria-pressed="false">
              <div class="card-title">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ OBD‚ÄëII</div>
              <div class="card-desc">–ß—Ç–µ–Ω–∏–µ DTC –∏ —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–∏—Å—Ç–µ–º</div>
              <div class="card-price">480 ‚ÇΩ</div>
            </div>
          </div>
          <div class="actions row">
            <button class="secondary" data-back>–ù–∞–∑–∞–¥</button>
            <button class="primary" id="service-continue" disabled>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
          </div>
        </div>
      </section>

      <section id="screen-thk-intro" class="screen">
        <div class="center narrow">
          <h2>–¢–æ–ª—â–∏–Ω–æ–º–µ—Ç—Ä–∏—è –õ–ö–ü</h2>
          <p class="lead">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫—É–∑–æ–≤ –∑–∞ –º–∏–Ω—É—Ç—ã ‚Äî –±–µ–∑ —Å–µ—Ä–≤–∏—Å–∞ –∏ –æ–∂–∏–¥–∞–Ω–∏–π. –ú—ã –≤—ã–¥–∞—ë–º —Ç–æ–ª—â–∏–Ω–æ–º–µ—Ä –∏–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ù–∞ —ç–∫—Ä–∞–Ω–µ —Å—Ä–∞–∑—É –≤–∏–¥–Ω–∞ —Å—Ö–µ–º–∞ –∫—É–∑–æ–≤–∞ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –∏–∑–º–µ—Ä–µ–Ω–∏–π. –ö–∞–∂–¥—ã–π –∑–∞–º–µ—Ä ‚Äî —ç—Ç–æ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, —á—Ç–æ —Å–∫—Ä—ã—Ç—ã—Ö –ø–µ—Ä–µ–∫—Ä–∞—Å–æ–≤ –Ω–µ—Ç. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∞–≤—Ç–æ–º–æ–±–∏–ª—è –∏ –Ω–∞—á–Ω–∏—Ç–µ ‚Äî –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ —Å–¥–µ–ª–∞–µ—Ç –∫–∏–æ—Å–∫.</p>
          <p class="muted-note">–ò–∑–º–µ—Ä—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Å–ª–æ–∏ –õ–ö–ü, —á—Ç–æ–±—ã –≤—ã—è–≤–∏—Ç—å –ø–µ—Ä–µ–∫—Ä–∞—Å—ã, —à–ø–∞–∫–ª—ë–≤–∫—É –∏ —Å–ª–µ–¥—ã —Ä–µ–º–æ–Ω—Ç–∞. –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ–¥—Å–∫–∞–∂—É—Ç, –∫—É–¥–∞ –ø—Ä–∏–ª–æ–∂–∏—Ç—å –¥–∞—Ç—á–∏–∫ –∏ –∫–∞–∫ –¥–µ—Ä–∂–∞—Ç—å –µ–≥–æ —Ä–æ–≤–Ω–æ. –ü–æ–Ω—è—Ç–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ —Ç–æ—á–Ω–æ—Å—Ç—å –∑–∞–º–µ—Ä–∞. –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è –∏ —Å—Ä–∞–∑—É –ø–æ–ø–∞–¥–∞—é—Ç –≤ –æ—Ç—á—ë—Ç –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ email. –≠—Ç–æ –±—ã—Å—Ç—Ä—ã–π –∏ –Ω–∞–≥–ª—è–¥–Ω—ã–π —Å–ø–æ—Å–æ–± –æ—Ü–µ–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ –ø–µ—Ä–µ–¥ –ø–æ–∫—É–ø–∫–æ–π.</p>
          <ul class="checklist">
            <li>40‚Äì60 —Ç–æ—á–µ–∫ –Ω–∞ –∫—É–∑–æ–≤–µ –ø–æ –ø–æ–Ω—è—Ç–Ω–æ–π —Å—Ö–µ–º–µ.</li>
            <li>–ü–æ–¥—Å–∫–∞–∑–∫–∏ –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ ‚Äî –±–µ–∑ –ª–∏—à–Ω–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.</li>
            <li>–û—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–∏–º –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω/email —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.</li>
            <li>–î–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –º—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ—Ä–µ–Ω–∏—è –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ ‚Äî –º–æ–∂–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤ –æ—Ç—á—ë—Ç–µ.</li>
          </ul>
          <div class="cards three" id="thk-types">
            <div class="card selectable thk-type-card" data-type="sedan" data-price="350" role="button" tabindex="0" aria-pressed="false">
              <div class="card-title">–°–µ–¥–∞–Ω</div>
              <div class="card-desc">–ö–æ–º–ø–∞–∫—Ç/—Å—Ä–µ–¥–Ω–∏–π</div>
              <div class="card-price">350 ‚ÇΩ</div>
            </div>
            <div class="card selectable thk-type-card" data-type="hatchback" data-price="350" role="button" tabindex="0" aria-pressed="false">
              <div class="card-title">–•—ç—Ç—á–±–µ–∫</div>
              <div class="card-desc">3/5 –¥–≤–µ—Ä–µ–π</div>
              <div class="card-price">350 ‚ÇΩ</div>
            </div>
            <div class="card selectable thk-type-card" data-type="minivan" data-price="400" role="button" tabindex="0" aria-pressed="false">
              <div class="card-title">–ú–∏–Ω–∏–≤—ç–Ω</div>
              <div class="card-desc">MPV/–º–∏–∫—Ä–æ–∞–≤—Ç–æ–±—É—Å</div>
              <div class="card-price">400 ‚ÇΩ</div>
            </div>
          </div>
          <div id="thk-vehicle-preview" class="vehicle-preview hidden" aria-live="polite">
            <img id="thk-vehicle-image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==" alt="" loading="lazy" />
            <div id="thk-vehicle-caption" class="vehicle-caption"></div>
          </div>
          <div class="actions row">
            <button class="secondary" data-back>–ù–∞–∑–∞–¥</button>
            <button class="primary" id="thk-continue-1" disabled>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
          </div>
        </div>
      </section>

      <section id="screen-thk-contact" class="screen">
        <div class="center narrow">
          <h2>–ö—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç?</h2>
          <p class="muted-note">–ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ —Ñ–∞–π–ª–∞. –ú—ã –Ω–µ –ø–µ—Ä–µ–¥–∞—ë–º –¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∏—Ä–∞–µ–º –∏—Ö –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á—ë—Ç–∞.</p>
          <div class="form">
            <label class="field contact-field">
              <span>–¢–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ email</span>
              <input id="thk-contact" class="contact-input" type="text" inputmode="tel" autocomplete="tel" aria-describedby="thk-contact-hint" placeholder="+7 (9XX) XXX-XX-XX –∏–ª–∏ email" />
            </label>
            <div id="thk-contact-hint" class="field-hint">–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –æ—Ç—á—ë—Ç –ø–æ SMS. –§–æ—Ä–º–∞—Ç –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å email, –µ—Å–ª–∏ —É–¥–æ–±–Ω–µ–µ –ø–æ–ª—É—á–∏—Ç—å –ø–∏—Å—å–º–æ.</div>
            <div id="thk-contact-error" class="field-error" role="alert" aria-live="polite"></div>
          </div>
          <div class="contact-instructions">
            <h3>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</h3>
            <ul class="steps">
              <li>–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7 (9XX) XXX-XX-XX –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ email.</li>
              <li>–°—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–∑–º–µ—Ä–µ–Ω–∏–π –ø—Ä–∏—à–ª—ë–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ—Ç—á—ë—Ç.</li>
              <li>–ö–æ–Ω—Ç–∞–∫—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ ‚Äî —É–¥–∞–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</li>
            </ul>
            <div class="contact-illustrations" role="img" aria-label="–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏: —Ç–µ–ª–µ—Ñ–æ–Ω, –ø–∏—Å—å–º–æ, –∑–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö">
              <div class="tile">
                <img src="./assets/icons/phone.svg" alt="–¢–µ–ª–µ—Ñ–æ–Ω" loading="lazy" />
                <div class="caption">SMS —Å —Å—Å—ã–ª–∫–æ–π</div>
              </div>
              <div class="tile">
                <img src="./assets/icons/mail.svg" alt="Email" loading="lazy" />
                <div class="caption">–ü–∏—Å—å–º–æ —Å PDF</div>
              </div>
              <div class="tile">
                <img src="./assets/icons/lock.svg" alt="–ó–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö" loading="lazy" />
                <div class="caption">–£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏</div>
              </div>
            </div>
          </div>
          <div class="actions row">
            <button class="secondary" data-back>–ù–∞–∑–∞–¥</button>
            <button class="primary" id="thk-continue-2" disabled>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
          </div>
        </div>
      </section>

      <section id="screen-thk-payment" class="screen">
        <div class="center narrow">
          <h2>–û–ø–ª–∞—Ç–∞ –ø–æ QR</h2>
          <div class="hero-icon" aria-hidden="true">
            <img src="./assets/icons/credit-card.svg" alt="" loading="lazy" />
          </div>
          <p class="lead">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –¥–ª—è –æ–ø–ª–∞—Ç—ã. –í —ç—Ç–æ–π —Å–±–æ—Ä–∫–µ –æ–ø–ª–∞—Ç–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–ø—Ä–æ–≤–∞–π–¥–µ—Ä –µ—â—ë –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω).</p>
          <p class="muted-note">–ú—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—É–º–º—É –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –¥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —Ç–µ—Ä–º–∏–Ω–∞–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –∏ –æ—Ç–∫—Ä–æ–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥.</p>
          <div id="thk-amount" class="amount" aria-live="polite"></div>
          <div class="qr-placeholder" aria-label="QR placeholder"></div>
          <div class="actions column">
            <button class="secondary" data-back>–ù–∞–∑–∞–¥</button>
          </div>
        </div>
      </section>

      <section id="screen-thk-prep" class="screen">
        <div class="center narrow">
          <h2>–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h2>
          <p class="muted-note">–ü–µ—Ä–µ–¥ –≤—ã–¥–∞—á–µ–π –º—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞—Ä—è–¥ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏. –°–ª–µ–¥—É–π—Ç–µ —à–∞–≥–∞–º –Ω–∏–∂–µ ‚Äî —Ç–∞–∫ –∑–∞–º–µ—Ä—ã –±—É–¥—É—Ç —Ç–æ—á–Ω—ã–º–∏ –¥–∞–∂–µ –Ω–∞ —Å–ª–æ–∂–Ω—ã—Ö —É—á–∞—Å—Ç–∫–∞—Ö –∫—É–∑–æ–≤–∞.</p>
          <ul class="benefits">
            <li>–ú—ã –≤—ã–¥–∞–¥–∏–º —Ç–æ–ª—â–∏–Ω–æ–º–µ—Ä –∏–∑ –æ—Ç—Å–µ–∫–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞.</li>
            <li>–ü—Ä–æ—Ç—Ä–∏—Ç–µ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å, –¥–µ—Ä–∂–∏—Ç–µ –¥–∞—Ç—á–∏–∫ –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ.</li>
            <li>–°–ª–µ–¥—É–π—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º –Ω–∞ —ç–∫—Ä–∞–Ω–µ.</li>
          </ul>
          <div class="actions row">
            <button class="secondary" data-back>–ù–∞–∑–∞–¥</button>
            <button class="primary" id="thk-continue-3">–î–∞–ª–µ–µ</button>
          </div>
        </div>
      </section>

      <section id="screen-thk-measure" class="screen">
        <div class="center narrow">
          <h2>–ò–∑–º–µ—Ä–µ–Ω–∏—è</h2>
        <p class="lead">–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–æ–ª—â–∏–Ω–æ–º–µ—Ä. –ë–µ–∑ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.</p>
          <ul class="benefits">
            <li>–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π –∑–∞–º–µ—Ä –Ω–∞ —ç—Ç–∞–ª–æ–Ω–Ω–æ–π –ø–ª–∞—Å—Ç–∏–Ω–µ ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å.</li>
            <li>–ö–∞–∂–¥—É—é —Ç–æ—á–∫—É —Ñ–∏–∫—Å–∏—Ä—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ, –¥–æ–ø—É—Å—Ç–∏–º–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∏ –∫—Ä–∞—Ç–∫–∏–π —Å–æ–≤–µ—Ç.</li>
            <li>–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–∞—É–∑—É ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–ª–æ–∂–∏—Ç–µ –¥–∞—Ç—á–∏–∫ –≤ –¥–µ—Ä–∂–∞—Ç–µ–ª—å, —Å–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è.</li>
          </ul>
          <div class="status-line"><span id="thk-status" class="badge badge-danger" aria-live="polite">–¢–æ–ª—â–∏–Ω–æ–º–µ—Ä: –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</span></div>
          <button class="primary" id="thk-start" disabled>–ù–∞—á–∞—Ç—å –∏–∑–º–µ—Ä–µ–Ω–∏—è</button>
          <div id="thk-session" class="card hidden" aria-live="polite">
            <div class="card-title">–ü—Ä–æ–≥—Ä–µ—Å—Å –∏–∑–º–µ—Ä–µ–Ω–∏–π</div>
            <div id="thk-progress" class="meta">‚Äî</div>
            <div id="thk-points-grid" class="thk-points-grid"></div>
            <div class="actions row">
              <button class="ghost" type="button" id="thk-dev-mark" style="display:none">–û—Ç–º–µ—Ç–∏—Ç—å —Ç–æ—á–∫—É (DEV)</button>
              <button class="primary" type="button" id="thk-finish" disabled>–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
            </div>
          </div>
          <div class="muted-note">–ù–µ—Ç —Å–∏–º—É–ª—è—Ü–∏–∏ –∏–∑–º–µ—Ä–µ–Ω–∏–π –≤ PROD. –í DEV –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ¬´–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å¬ª –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.</div>
          <div class="actions">
            <button class="secondary" data-back>–ù–∞–∑–∞–¥</button>
          </div>
        </div>
      </section>

      <section id="screen-thk-done" class="screen">
        <div class="center narrow">
          <h2>–ì–æ—Ç–æ–≤–æ</h2>
          <p class="lead">–û—Ç—á—ë—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏ —Ä–µ—à–∏—Ç–µ ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ SMS/email –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ.</p>
          <p class="muted-note">–í —Ñ–∞–π–ª–µ –≤—ã —É–≤–∏–¥–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É —Å —Ç–æ—á–∫–∞–º–∏ –∏–∑–º–µ—Ä–µ–Ω–∏–π, —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ. –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –Ω–∞—á–∞—Ç—å –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é.</p>
          <div id="report-status-thk" class="report-status" aria-live="polite"></div>
          <div id="credits-thk" class="credits"></div>
          <div class="actions row">
            <button class="ghost" id="thk-preview">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
            <button class="primary" id="back-to-home-1">–ù–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</button>
          </div>
        </div>
      </section>

      <!-- Flow: Diagnostics (OBD-II) -->
      <section id="screen-obd-intro" class="screen">
        <div class="center narrow">
          <h2>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ OBD‚ÄëII</h2>
          <p class="lead">–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –∞–¥–∞–ø—Ç–µ—Ä—É ELM327 –∏ —Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–¥—ã –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–µ–π (DTC), —Å—Ç–∞—Ç—É—Å—ã —Å–∏—Å—Ç–µ–º –∏ –∫–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ. –í—Å—ë –ø—Ä–æ–∑—Ä–∞—á–Ω–æ –∏ –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤.</p>
          <p class="muted-note">–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç –º–∞—Ä–∫—É –∞–≤—Ç–æ–º–æ–±–∏–ª—è –∏ –ø–æ–¥–±–∏—Ä–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –æ–ø—Ä–æ—Å–∞. –í –æ—Ç—á—ë—Ç–µ –±—É–¥—É—Ç –∫–æ–¥—ã DTC, –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–µ–π –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–∞–ª—å–Ω–µ–π—à–∏–º –¥–µ–π—Å—Ç–≤–∏—è–º.</p>
          <ul class="checklist">
            <li>–ë—ã—Å—Ç—Ä—ã–π –æ–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º –∏–ª–∏ –¥–µ—Ç–∞–ª—å–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç OBD‚ÄëII ‚Äî –Ω–∞ –≤–∞—à –≤—ã–±–æ—Ä.</li>
            <li>–ü–æ–∫–∞–∂–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–æ–¥—ã/—Å—Ç–∞—Ç—É—Å—ã –∏ –∫—Ä–∞—Ç–∫–æ –æ–±—ä—è—Å–Ω–∏–º, —á—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç.</li>
            <li>–ü–ª–∞—Ç—ë–∂ ‚Äî –ø–æ—Å–ª–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –æ—Ç—á—ë—Ç–∞. –°—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –æ—Ç–∫—Ä–æ–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.</li>
            <li>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å–æ–±–µ—Ä—ë–º live-–¥–∞–Ω–Ω—ã–µ (–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ, —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –æ–±–æ—Ä–æ—Ç—ã), —á—Ç–æ–±—ã –æ—Ü–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ—Ç–æ—Ä–∞.</li>
          </ul>
          <div class="cards two" id="obd-modes">
            <div class="card selectable obd-mode-card" data-mode="general" role="button" tabindex="0" aria-pressed="false">
              <div class="card-title">–û–±—â–∞—è</div>
              <div class="card-desc">–ö—Ä–∞—Ç–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–∏—Å—Ç–µ–º</div>
            </div>
            <div class="card selectable obd-mode-card" data-mode="obd2" role="button" tabindex="0" aria-pressed="false">
              <div class="card-title">OBD‚ÄëII</div>
              <div class="card-desc">–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º OBD‚ÄëII</div>
            </div>
          </div>
          <div class="actions row">
            <button class="secondary" data-back>–ù–∞–∑–∞–¥</button>
            <button class="primary" id="obd-continue-1" disabled>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
          </div>
        </div>
      </section>

      <section id="screen-obd-contact" class="screen">
        <div class="center narrow">
          <h2>–ö—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç?</h2>
          <p class="muted-note">–ú—ã –Ω–∞–ø—Ä–∞–≤–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏. –ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω—É–∂–Ω—ã, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∏—Ç–æ–≥–æ–≤—ã–π PDF.</p>
          <div class="form">
            <label class="field contact-field">
              <span>–¢–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ email</span>
              <input id="obd-contact" class="contact-input" type="text" inputmode="tel" autocomplete="tel" aria-describedby="obd-contact-hint" placeholder="+7 (9XX) XXX-XX-XX –∏–ª–∏ email" />
            </label>
            <div id="obd-contact-hint" class="field-hint">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω —Å –∫–æ–¥–æ–º –†–æ—Å—Å–∏–∏ ‚Äî –º—ã –ø—Ä–∏—à–ª—ë–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è. –î–æ–ø—É—Å—Ç–∏–º –∏ email, –µ—Å–ª–∏ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ –ø–∏—Å—å–º–æ.</div>
            <div id="obd-contact-error" class="field-error" role="alert" aria-live="polite"></div>
          </div>
          <div class="contact-instructions">
            <h3>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</h3>
            <ul class="steps">
              <li>–£–∫–∞–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ email ‚Äî –º—ã –ø—Ä–æ–≤–µ—Ä–∏–º —Ñ–æ—Ä–º–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</li>
              <li>–ü–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –æ—Ç–ø—Ä–∞–≤–∏–º —Å—Å—ã–ª–∫—É –∏ —Ñ–∞–π–ª –æ—Ç—á—ë—Ç–∞.</li>
              <li>–ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ ‚Äî –º—ã –∏—Ö —É–¥–∞–ª—è–µ–º.</li>
            </ul>
            <div class="contact-illustrations" role="img" aria-label="–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏: —Ç–µ–ª–µ—Ñ–æ–Ω, –ø–∏—Å—å–º–æ, –∑–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö">
              <div class="tile">
                <img src="./assets/icons/phone.svg" alt="–¢–µ–ª–µ—Ñ–æ–Ω" loading="lazy" />
                <div class="caption">SMS —Å —Å—Å—ã–ª–∫–æ–π</div>
              </div>
              <div class="tile">
                <img src="./assets/icons/mail.svg" alt="Email" loading="lazy" />
                <div class="caption">–ü–∏—Å—å–º–æ —Å PDF</div>
              </div>
              <div class="tile">
                <img src="./assets/icons/lock.svg" alt="–ó–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö" loading="lazy" />
                <div class="caption">–£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏</div>
              </div>
            </div>
          </div>
          <div class="actions row">
            <button class="secondary" data-back>–ù–∞–∑–∞–¥</button>
            <button class="primary" id="obd-continue-2" disabled>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
          </div>
        </div>
      </section>

      <section id="screen-obd-vehicle" class="screen">
        <div class="center narrow">
          <h2>–í—ã–±–æ—Ä –∞–≤—Ç–æ–º–æ–±–∏–ª—è</h2>
          <p class="lead">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä–∫—É ‚Äî –º—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ —É—á—Ç—ë–º –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã.</p>
          <div class="cards two" id="obd-makes">
            <div class="card selectable obd-make-card" data-make="Toyota" role="button" tabindex="0" aria-pressed="false">
              <div class="card-title">Toyota</div>
              <div class="card-desc">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã TNGA, –Ω–∞–¥—ë–∂–Ω–∞—è —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞, –±—ã—Å—Ç—Ä–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.</div>
            </div>
            <div class="card selectable obd-make-card" data-make="Lexus" role="button" tabindex="0" aria-pressed="false">
              <div class="card-title">Lexus</div>
              <div class="card-desc">–ü—Ä–µ–º–∏—É–º-–º–æ–¥–µ–ª–∏ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–æ–π –∏ –≥–∏–±—Ä–∏–¥–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏.</div>
            </div>
          </div>
          <div id="obd-vehicle-preview" class="vehicle-preview hidden" aria-live="polite">
            <img id="obd-vehicle-image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==" alt="" loading="lazy" />
            <div id="obd-vehicle-caption" class="vehicle-caption"></div>
          </div>
          <p class="muted-note">–õ–æ–≥–æ—Ç–∏–ø –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–Ω—è—Ç—å, —á—Ç–æ —Å—Ü–µ–Ω–∞—Ä–∏–π –ø–æ–¥–æ–±—Ä–∞–Ω –∏–º–µ–Ω–Ω–æ –ø–æ–¥ –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–∞—Ä–∫—É: –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ö–µ–º—ã —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è —Ä–∞–∑—ä—ë–º–∞ –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã CAN/LIN –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤.</p>
          <div class="hint">–õ–æ–≥–æ—Ç–∏–ø –∏ –∫—Ä–∞—Ç–∫–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞. –°–ø–∏—Å–æ–∫ –º–∞—Ä–æ–∫ –±—É–¥–µ–º —Ä–∞—Å—à–∏—Ä—è—Ç—å.</div>
          <div class="actions row">
            <button class="secondary" data-back>–ù–∞–∑–∞–¥</button>
            <button class="primary" id="obd-continue-3" disabled>–î–∞–ª–µ–µ</button>
          </div>
        </div>
      </section>

      <section id="screen-obd-prep" class="screen">
        <div class="center narrow">
          <h2>–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h2>
          <p class="muted-note">–ß—Ç–æ–±—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—à–ª–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä –Ω–µ —Ä–∞–∑—Ä—è–∂–µ–Ω, –∞ –∞–¥–∞–ø—Ç–µ—Ä ELM327 —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–æ —â–µ–ª—á–∫–∞. –ï—Å–ª–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—å –≥–∏–±—Ä–∏–¥–Ω—ã–π, –¥–æ–∂–¥–∏—Ç–µ—Å—å —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –ø—Ä–∏–±–æ—Ä–Ω–æ–π –ø–∞–Ω–µ–ª–∏ –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º.</p>
          <ul class="benefits">
            <li>–í—Å—Ç–∞–≤—å—Ç–µ –∞–¥–∞–ø—Ç–µ—Ä ELM327 –≤ —Ä–∞–∑—ä—ë–º OBD‚ÄëII –∞–≤—Ç–æ–º–æ–±–∏–ª—è.</li>
            <li>–í–∫–ª—é—á–∏—Ç–µ –∑–∞–∂–∏–≥–∞–Ω–∏–µ (–±–µ–∑ –∑–∞–ø—É—Å–∫–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è).</li>
            <li>–°–ª–µ–¥—É–π—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º –Ω–∞ —ç–∫—Ä–∞–Ω–µ.</li>
          </ul>
          <div class="actions row">
            <button class="secondary" data-back>–ù–∞–∑–∞–¥</button>
            <button class="primary" id="obd-continue-4">–î–∞–ª–µ–µ</button>
          </div>
        </div>
      </section>

      <section id="screen-obd-scan" class="screen">
        <div class="center narrow">
          <h2>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
          <p class="lead">–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–π –∞–¥–∞–ø—Ç–µ—Ä ELM327. –ë–µ–∑ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.</p>
          <ul class="benefits">
            <li>–ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –º—ã –≤—ã–ø–æ–ª–Ω—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫—É –∞–¥–∞–ø—Ç–µ—Ä–∞ –∏ —Ñ–∏–∫—Å–∏—Ä—É–µ–º —É—Ä–æ–≤–µ–Ω—å –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è –±–æ—Ä—Ç—Å–µ—Ç–∏.</li>
            <li>–ú–æ–∂–Ω–æ –Ω–∞–±–ª—é–¥–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å: —Å–Ω–∞—á–∞–ª–∞ —Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ–¥—ã, –∑–∞—Ç–µ–º —Å—Ç–∞—Ç—É—Å—ã —Å–∏—Å—Ç–µ–º –∏ live-–¥–∞–Ω–Ω—ã–µ.</li>
            <li>–ï—Å–ª–∏ —Å–≤—è–∑—å –ø—Ä–µ—Ä–≤—ë—Ç—Å—è ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Å—Å–∏—é –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö.</li>
          </ul>
          <div class="status-line"><span id="obd-status" class="badge badge-danger" aria-live="polite">OBD‚Äë–∞–¥–∞–ø—Ç–µ—Ä: –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</span></div>
          <div id="obd-connection-meta" class="obd-connection-meta" data-obd-connection-meta aria-live="polite"></div>
          <button class="primary" id="obd-start" disabled>–ù–∞—á–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
          <div class="muted-note">–ù–µ—Ç —Å–∏–º—É–ª—è—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≤ PROD. –í DEV –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ¬´–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å¬ª.</div>
          <div class="actions">
            <div class="form">
              <label class="field">
                <span>COM-–ø–æ—Ä—Ç –∞–¥–∞–ø—Ç–µ—Ä–∞</span>
                <select id="obd-port">
                  <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Ä—Ç‚Ä¶</option>
                </select>
              </label>
              <div class="form-row">
                <button class="ghost small" type="button" id="obd-refresh">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                <div class="port-status-wrapper">
                  <div id="obd-port-status" class="hint">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∞–¥–∞–ø—Ç–µ—Ä –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å–ø–∏—Å–æ–∫.</div>
                  <div id="obd-port-last-refresh" class="meta"></div>
                </div>
              </div>
            </div>
            <button class="secondary" data-back>–ù–∞–∑–∞–¥</button>
          </div>
        </div>
      </section>

      <section id="screen-obd-paywall" class="screen">
        <div class="center narrow">
          <h2>–ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã</h2>
          <div class="hero-icon hero-icon--indigo" aria-hidden="true">
            <img src="./assets/icons/shield-check.svg" alt="" loading="lazy" />
          </div>
          <p class="lead" id="obd-paywall-lead">–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.</p>
          <p class="muted-note">–î–æ –æ–ø–ª–∞—Ç—ã –≤—ã –≤–∏–¥–∏—Ç–µ —Å–≤–æ–¥–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è. –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –ø–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç —Å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–æ–π –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏.</p>
          <div id="obd-paywall-amount" class="amount" aria-live="polite"></div>
          <div class="qr-placeholder" aria-label="QR placeholder"></div>
          <div id="obd-payment-info" class="payment-info"></div>
          <div id="obd-self-check" class="self-check-box" aria-live="polite"></div>
          <div class="obd-connection-meta" data-obd-connection-meta aria-live="polite"></div>
          <div class="actions column">
            <button class="secondary" data-back>–ù–∞–∑–∞–¥</button>
            <button class="ghost" type="button" id="obd-self-check-rerun">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫—É</button>
          </div>
        </div>
      </section>

      <section id="screen-obd-results" class="screen">
        <div class="center narrow">
          <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏</h2>
          <p class="lead" id="obd-results-lead">–ó–¥–µ—Å—å –±—É–¥—É—Ç –∫–æ–¥—ã DTC –∏ —Å—Ç–∞—Ç—É—Å—ã –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.</p>
          <p class="muted-note">–ö–∞–∂–¥—ã–π –∫–æ–¥ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞–µ—Ç—Å—è –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º —É—Ä–æ–≤–Ω—è —Å–µ—Ä—å—ë–∑–Ω–æ—Å—Ç–∏. –í—ã –º–æ–∂–µ—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å live-–¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã —Å—Ä–∞–≤–Ω–∏—Ç—å –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –¥–æ –∏ –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞, –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–µ—Å—Å–∏—é –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ email.</p>
          <div id="obd-results-wrapper" class="card">
            <div id="obd-results-title" class="card-title">–ö–æ–¥—ã –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–µ–π</div>
            <div id="obd-status-summary" class="obd-summary" aria-live="polite"></div>
            <div id="obd-live-data" class="obd-live" aria-live="polite"></div>
            <div id="obd-summary-grid" class="obd-summary-grid hidden" aria-live="polite"></div>
            <div id="obd-results-list" class="card-desc">–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ –±–µ–∑ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.</div>
            <div id="obd-self-check-results" class="self-check-box self-check-box--inline" aria-live="polite"></div>
            <div class="obd-connection-meta" data-obd-connection-meta aria-live="polite"></div>
          </div>
          <!-- Internal AI automation is not exposed to clients -->
          <div class="actions row">
            <button class="secondary" id="obd-clear" disabled>–°–±—Ä–æ—Å–∏—Ç—å –æ—à–∏–±–∫–∏ (Clear DTC)</button>
            <button class="ghost" id="obd-live-refresh">–û–±–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</button>
            <!-- AI button removed from client UI by policy -->
            <button class="primary" id="obd-finish">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
          </div>
        </div>
      </section>

      <section id="screen-obd-done" class="screen">
        <div class="center narrow">
          <h2>–ì–æ—Ç–æ–≤–æ</h2>
          <p class="lead">–û—Ç—á—ë—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏ —Ä–µ—à–∏—Ç–µ ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ SMS/email –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ.</p>
          <p class="muted-note">–í –æ—Ç—á—ë—Ç–µ —É–∫–∞–∑–∞–Ω—ã –∫–æ–¥—ã –æ—à–∏–±–æ–∫, —Å—Ç–∞—Ç—É—Å MIL, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–∞–ø—Ç–µ—Ä–∞ –∏, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –æ—Ç–º–µ—Ç–∫–∞ –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Å–±—Ä–æ—Å–∞ DTC. –í—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç–µ—Ä–º–∏–Ω–∞–ª—É –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏.</p>
          <div id="report-status-obd" class="report-status" aria-live="polite"></div>
          <div id="credits-obd" class="credits"></div>
          <div class="actions row">
            <button class="ghost" id="obd-preview">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
            <button class="primary" id="back-to-home-2">–ù–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</button>
          </div>
        </div>
      </section>


    </div>

    <!-- Modal: Terms -->
    <div id="terms-modal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="terms-title">
      <div class="modal" role="document">
        <div class="modal-header">
          <div class="modal-title" id="terms-title">–£—Å–ª–æ–≤–∏—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è</div>
          <button type="button" id="terms-close" class="close">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        <div class="modal-body">
          <div id="terms-content" class="terms-content" aria-live="polite">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
        </div>
        <div class="modal-actions">
          <a class="ghost" href="../../docs/legal/terms.md" target="_blank">–û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ</a>
          <button type="button" id="terms-ok" class="primary">–ü–æ–Ω—è—Ç–Ω–æ</button>
        </div>
      </div>
    </div>

    <!-- Modal: Report Preview -->
    <div id="report-preview-modal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="report-preview-title">
      <div class="modal modal--wide" role="document">
        <div class="modal-header">
          <div class="modal-title" id="report-preview-title">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á—ë—Ç–∞</div>
          <button type="button" id="report-preview-close" class="close">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        <div class="modal-body">
          <iframe id="report-preview-frame" title="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á—ë—Ç–∞" style="width:100%;height:60vh;border:1px solid #E5E7EB;border-radius:8px;"></iframe>
        </div>
        <div class="modal-actions">
          <button type="button" id="report-send-sms" class="primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ SMS</button>
          <button type="button" id="report-send-email" class="ghost">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ Email</button>
          <button type="button" id="report-skip-send" class="secondary">–ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- Settings Button (fixed position) -->
    <button
      type="button"
      id="settings-button"
      class="settings-button"
      aria-label="–û—Ç–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö"
      title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏"
      style="display:none;">
      ‚öôÔ∏è
    </button>

    <!-- Modal: Settings -->
    <div id="settings-modal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="settings-title">
      <div class="modal" role="document">
        <div class="modal-header">
          <div class="modal-title" id="settings-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö</div>
          <button type="button" id="settings-close" class="close">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        <div class="modal-body">
          <div class="form">
            <label class="field">
              <span>–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö</span>
              <select id="settings-source">
                <option value="agent">–õ–æ–∫–∞–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)</option>
                <option value="supabase">Supabase (–æ–±–ª–∞—á–Ω–æ, read-only)</option>
              </select>
            </label>

            <div id="settings-supabase-fields" style="display:none;">
              <label class="field">
                <span>Supabase URL</span>
                <input type="url" id="settings-supabase-url" placeholder="https://your-project.supabase.co" />
              </label>
              <label class="field">
                <span>Supabase Anon Key</span>
                <input type="password" id="settings-supabase-anon-key" placeholder="eyJhbGciOi..." />
              </label>
              <div class="hint">
                <strong>–í–∞–∂–Ω–æ:</strong> –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ ANON KEY (–ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á).
                –î–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ –ø—É–±–ª–∏—á–Ω—ã—Ö VIEW.
                –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.
              </div>
            </div>

            <div id="settings-status" class="hint"></div>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" id="settings-save" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button type="button" id="settings-reset" class="secondary">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <script>
      (function(){
        const qs = new URLSearchParams(window.location.search);
        const isDev = qs.get('dev') === '1';

        // Settings and data source management
        const SETTINGS_KEY = 'kiosk-settings';
        let dataSource = 'agent'; // 'agent' or 'supabase'
        let supabaseClient = null;

        // Load settings from localStorage
        function loadSettings() {
          try {
            const saved = localStorage.getItem(SETTINGS_KEY);
            if (saved) {
              const settings = JSON.parse(saved);
              dataSource = settings.source || 'agent';

              if (dataSource === 'supabase' && settings.supabaseUrl && settings.supabaseAnonKey) {
                // Initialize Supabase client
                // Note: @supabase/supabase-js would need to be loaded via CDN
                // For now, we'll just store the config
                console.log('[Settings] Supabase mode configured');
              }

              return settings;
            }
          } catch (e) {
            console.error('[Settings] Failed to load settings:', e);
          }
          return { source: 'agent' };
        }

        function saveSettings(settings) {
          try {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            console.log('[Settings] Settings saved:', settings.source);
          } catch (e) {
            console.error('[Settings] Failed to save settings:', e);
          }
        }

        // Settings UI management
        const settingsButton = document.getElementById('settings-button');
        const settingsModal = document.getElementById('settings-modal');
        const settingsClose = document.getElementById('settings-close');
        const settingsSource = document.getElementById('settings-source');
        const settingsSupabaseFields = document.getElementById('settings-supabase-fields');
        const settingsSupabaseUrl = document.getElementById('settings-supabase-url');
        const settingsSupabaseAnonKey = document.getElementById('settings-supabase-anon-key');
        const settingsSave = document.getElementById('settings-save');
        const settingsReset = document.getElementById('settings-reset');
        const settingsStatus = document.getElementById('settings-status');

        // Show settings button only in DEV or with special key combo (Ctrl+Shift+S)
        if (isDev) {
          settingsButton.style.display = 'block';
        }

        document.addEventListener('keydown', (e) => {
          if (e.ctrlKey && e.shiftKey && e.key === 'S') {
            e.preventDefault();
            settingsButton.style.display = 'block';
            settingsButton.click();
          }
        });

        settingsButton?.addEventListener('click', () => {
          const currentSettings = loadSettings();
          settingsSource.value = currentSettings.source || 'agent';
          settingsSupabaseUrl.value = currentSettings.supabaseUrl || '';
          settingsSupabaseAnonKey.value = currentSettings.supabaseAnonKey || '';
          settingsSupabaseFields.style.display = currentSettings.source === 'supabase' ? 'block' : 'none';
          settingsModal?.classList.remove('hidden');
          settingsStatus.textContent = '';
        });

        settingsClose?.addEventListener('click', () => {
          settingsModal?.classList.add('hidden');
        });

        settingsSource?.addEventListener('change', () => {
          settingsSupabaseFields.style.display = settingsSource.value === 'supabase' ? 'block' : 'none';
        });

        settingsSave?.addEventListener('click', () => {
          const source = settingsSource.value;
          const settings = { source };

          if (source === 'supabase') {
            const url = settingsSupabaseUrl.value.trim();
            const key = settingsSupabaseAnonKey.value.trim();

            if (!url || !key) {
              settingsStatus.textContent = '‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ URL –∏ Anon Key –¥–ª—è Supabase';
              settingsStatus.style.color = '#ef4444';
              return;
            }

            settings.supabaseUrl = url;
            settings.supabaseAnonKey = key;
          }

          saveSettings(settings);
          dataSource = source;

          settingsStatus.textContent = `‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –ò—Å—Ç–æ—á–Ω–∏–∫: ${source === 'agent' ? '–õ–æ–∫–∞–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç' : 'Supabase (read-only)'}`;
          settingsStatus.style.color = '#10b981';

          // Disable device-related buttons in Supabase mode
          updateUIForDataSource();

          setTimeout(() => {
            settingsModal?.classList.add('hidden');
          }, 1500);
        });

        settingsReset?.addEventListener('click', () => {
          localStorage.removeItem(SETTINGS_KEY);
          dataSource = 'agent';
          settingsSource.value = 'agent';
          settingsSupabaseUrl.value = '';
          settingsSupabaseAnonKey.value = '';
          settingsSupabaseFields.style.display = 'none';
          settingsStatus.textContent = '‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é';
          settingsStatus.style.color = '#10b981';
          updateUIForDataSource();
        });

        function updateUIForDataSource() {
          // Disable device-related actions in Supabase mode
          const deviceButtons = document.querySelectorAll('[data-requires-agent]');
          deviceButtons.forEach(btn => {
            if (dataSource === 'supabase') {
              btn.disabled = true;
              btn.title = '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ —Ä–µ–∂–∏–º–µ Supabase (—Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ)';
              btn.style.opacity = '0.5';
            } else {
              btn.disabled = false;
              btn.title = '';
              btn.style.opacity = '1';
            }
          });

          /* REMOVED FOR AUTO-DEPLOY TEST - 2025-01-07
          // Show/hide mode indicator
          let modeIndicator = document.getElementById('mode-indicator');
          if (!modeIndicator) {
            modeIndicator = document.createElement('div');
            modeIndicator.id = 'mode-indicator';
            modeIndicator.style.cssText = 'position:fixed;top:10px;right:10px;padding:8px 12px;background:#f3f4f6;border:1px solid #d1d5db;border-radius:6px;font-size:12px;z-index:999;';
            document.body.appendChild(modeIndicator);
          }

          if (dataSource === 'supabase') {
            modeIndicator.textContent = '‚òÅÔ∏è Supabase (read-only)';
            modeIndicator.style.background = '#dbeafe';
            modeIndicator.style.borderColor = '#3b82f6';
          } else {
            modeIndicator.textContent = 'üñ•Ô∏è –õ–æ–∫–∞–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç';
            modeIndicator.style.background = '#f3f4f6';
            modeIndicator.style.borderColor = '#d1d5db';
          }
          */
        }

        // Load initial settings
        const initialSettings = loadSettings();
        dataSource = initialSettings.source || 'agent';
        updateUIForDataSource();

        // End of settings management

        const screens = [
          'screen-attract','screen-welcome','screen-services',
          // Thickness
          'screen-thk-intro','screen-thk-contact','screen-thk-payment','screen-thk-prep','screen-thk-measure','screen-thk-done',
          // OBD
          'screen-obd-intro','screen-obd-contact','screen-obd-vehicle','screen-obd-prep','screen-obd-scan','screen-obd-paywall','screen-obd-results','screen-obd-done'
        ];
  let idx = 0;
  let hasExitedAttract = false;
  let activeScreenId = 'screen-attract';
  let attractArmTimer = null;
  let attractInteractionArmed = false;
  const THICKNESS_POLL_INTERVAL_MS = 3000;
  const OBD_POLL_INTERVAL_MS = 3000;
  let thicknessPollTimer = null;
  let obdPollTimer = null;
  let thicknessPollPending = false;
  let obdPollPending = false;

        const $ = (id) => document.getElementById(id);
        const scheduleAttractArming = ()=>{
          attractInteractionArmed = false;
          if(attractArmTimer){
            clearTimeout(attractArmTimer);
          }
          attractArmTimer = setTimeout(()=>{
            attractInteractionArmed = true;
          }, 600);
        };

        const show = (id) => {
          document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
          const target = document.getElementById(id);
          if(target){
            target.classList.add('active');
          }
          activeScreenId = id;
          handleScreenActivated(id);
          if(id === 'screen-attract'){
            hasExitedAttract = false;
            scheduleAttractArming();
            $('screen-attract')?.focus({ preventScroll: true });
          }
        };

        // Attract ‚Üí –ª—é–±–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
  const screenAttract = $('screen-attract');
  scheduleAttractArming();
        const exitAttract = ()=>{
          if(hasExitedAttract || !attractInteractionArmed) return;
          hasExitedAttract = true;
          idx = 1;
          show(screens[idx]);
        };
        const bindAttractInteraction = (target, type, options)=>{
          target?.addEventListener(type, ()=>{
            if(document.getElementById('screen-attract')?.classList.contains('active')){
              exitAttract();
            }
          }, options);
        };

        // –†–µ–∞–≥–∏—Ä—É–µ–º –Ω–∞ –ª—é–±—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è
        ['click','pointerdown','touchstart','keydown'].forEach(eventName=>{
          const options = eventName === 'keydown' ? undefined : { passive: true };
          bindAttractInteraction(document, eventName, options);
        });
  // –í –¥–≤–∏–∂–µ–Ω–∏–∏ –º—ã—à–∏ —á–∞—Å—Ç–æ –ø—Ä–∏—Ö–æ–¥—è—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, –ø–æ—ç—Ç–æ–º—É –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∏—Ö –¥–ª—è –≤—ã—Ö–æ–¥–∞.

        // –≠–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ —Å–æ–≥–ª–∞—Å–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏
        const welcomeAgree = document.getElementById('welcome-agree');
        const welcomeContinue = document.getElementById('welcome-continue');
        const serviceCards = document.querySelectorAll('.service-card');
        const serviceContinue = $('service-continue');
        let selectedService = '';
        const sessionState = {
          contact: {
            thickness: null,
            diagnostics: null
          },
          session: {
            thicknessId: null,
            obdId: null
          },
          reportSent: {
            thickness: false,
            diagnostics: false
          }
        };

        // Payments/Agent API helpers (DEV simulation supported by agent)
        // –ë–∞–∑–∞ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –∏–∑ query (?agent=proto://host:port), –ª–∏–±–æ –∏–∑ localStorage, –ª–∏–±–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é host:apiPort
        const __q = (typeof window !== 'undefined') ? new URLSearchParams(window.location.search) : null;
        const API_HOST = (typeof window !== 'undefined' && window.location && window.location.hostname)
          ? window.location.hostname
          : 'localhost';
        const API_PROTOCOL = (typeof window !== 'undefined' && window.location && window.location.protocol === 'https:') ? 'https' : 'http';
        const API_PORT = (__q && __q.get('apiPort')) || '7070';
        const AGENT_QS = (__q && __q.get('agent')) || null; // –ø–æ–ª–Ω–∞—è –±–∞–∑–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä http://192.168.1.10:7070
        if (__q && __q.has('agent') && typeof localStorage !== 'undefined') {
          try { localStorage.setItem('AGENT_API_BASE', AGENT_QS || ''); } catch {}
        }
        if (__q && __q.has('clearAgent') && typeof localStorage !== 'undefined') {
          try { localStorage.removeItem('AGENT_API_BASE'); } catch {}
        }
        const AGENT_LS = (typeof localStorage !== 'undefined') ? (localStorage.getItem('AGENT_API_BASE') || null) : null;
        const AGENT_API_BASE = (AGENT_QS && AGENT_QS.trim()) || (AGENT_LS && AGENT_LS.trim()) || `${API_PROTOCOL}://${API_HOST}:${API_PORT}`;
        const api = (path) => `${AGENT_API_BASE}${path.startsWith('/') ? path : ('/' + path)}`;
        async function postJson(url, body){
          const resp = await fetch(url, { method:'POST', headers:{ 'content-type':'application/json' }, body: JSON.stringify(body||{}) });
          const data = await resp.json().catch(()=>({}));
          if(!resp.ok) throw Object.assign(new Error(data?.message || data?.error || 'request_failed'), { data });
          return data;
        }
        async function getJson(url){
          const resp = await fetch(url);
          const data = await resp.json().catch(()=>({}));
          if(!resp.ok) throw Object.assign(new Error(data?.message || data?.error || 'request_failed'), { data });
          return data;
        }
        async function paymentsCreateIntent(amount, meta){
          return postJson(api('/payments/intent'), { amount, currency: 'RUB', meta });
        }
        async function paymentsGetStatus(intentId){
          return getJson(api(`/payments/${encodeURIComponent(intentId)}/status`));
        }
        async function paymentsConfirmDev(intentId){
          return postJson(api('/payments/confirm-dev'), { id: intentId });
        }
        function startPaymentPolling(intentId, onUpdate, intervalMs = 1200){
          let stopped = false;
          async function tick(){
            if(stopped) return;
            try{
              const st = await paymentsGetStatus(intentId);
              if(typeof onUpdate === 'function') onUpdate(st);
              if(st && (st.status === 'succeeded' || st.status === 'canceled' || st.status === 'failed')){
                stopped = true; return;
              }
            }catch(err){ console.warn('payment status poll failed', err); }
            setTimeout(tick, intervalMs);
          }
          tick();
          return ()=>{ stopped = true; };
        }

        const updateWelcomeState = ()=>{
          if(welcomeContinue){
            welcomeContinue.disabled = !welcomeAgree?.checked;
          }
        };

        const resetServiceSelection = ()=>{
          selectedService = '';
          serviceCards.forEach(card=>{
            card.classList.remove('selected');
            card.setAttribute('aria-pressed', 'false');
          });
          if(serviceContinue) serviceContinue.disabled = true;
        };

        welcomeAgree?.addEventListener('change', updateWelcomeState);
        welcomeContinue?.addEventListener('click', ()=>{
          idx = screens.indexOf('screen-services');
          show('screen-services');
          resetServiceSelection();
        });
        updateWelcomeState();

        serviceCards.forEach(card=>{
          card.addEventListener('click', ()=>{
            serviceCards.forEach(other=>{
              const isCurrent = other === card;
              other.classList.toggle('selected', isCurrent);
              other.setAttribute('aria-pressed', isCurrent ? 'true' : 'false');
            });
            selectedService = card.getAttribute('data-service') || '';
            if(serviceContinue) serviceContinue.disabled = !selectedService;
          });
          card.addEventListener('keydown', (e)=>{
            if(e.key === 'Enter' || e.key === ' '){
              e.preventDefault();
              card.click();
            }
          });
        });

        serviceContinue?.addEventListener('click', ()=>{
          if(selectedService === 'thickness'){
            idx = screens.indexOf('screen-thk-intro');
            resetThkSelection();
            show('screen-thk-intro');
          } else if(selectedService === 'diagnostics'){
            idx = screens.indexOf('screen-obd-intro');
            resetObdVehicleSelection();
            show('screen-obd-intro');
          }
        });

        // –¢–æ–ª—â–∏–Ω–æ–º–µ—Ä –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        const thkTypeCards = document.querySelectorAll('.thk-type-card');
        const thkVehiclePreview = $('thk-vehicle-preview');
        const thkVehicleImage = $('thk-vehicle-image');
        const thkVehicleCaption = $('thk-vehicle-caption');

        const THK_VEHICLE_MEDIA = {
          sedan: {
            src: './assets/images/thk-sedan.png',
            alt: '–°–µ–¥–∞–Ω ‚Äî –ø—Ä–∏–º–µ—Ä –∫—É–∑–æ–≤–∞ –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏–π —Ç–æ–ª—â–∏–Ω–æ–º–µ—Ä–æ–º.',
            caption: '–°–µ–¥–∞–Ω: –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –∫—É–∑–æ–≤ —Å —á–µ—Ç—ã—Ä—å–º—è –¥–≤–µ—Ä—è–º–∏. –ù–∞ —Å—Ö–µ–º–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º 40‚Äì60 —Ç–æ—á–µ–∫.'
          },
          hatchback: {
            src: './assets/images/thk-hatchback.webp',
            alt: '–•—ç—Ç—á–±–µ–∫ ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –∫—É–∑–æ–≤ —Å –ø—è—Ç–æ–π –¥–≤–µ—Ä—å—é –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏–π.',
            caption: '–•—ç—Ç—á–±–µ–∫: –∫–æ—Ä–æ—Ç–∫–∏–π –∫—É–∑–æ–≤ –∏ —É–¥–æ–±–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –∫–∞–∂–¥–æ–π –∑–æ–Ω–µ –∏–∑–º–µ—Ä–µ–Ω–∏–π.'
          },
          minivan: {
            src: './assets/images/thk-minivan.png',
            alt: '–ú–∏–Ω–∏–≤—ç–Ω ‚Äî —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –∫—É–∑–æ–≤ –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏–π —Ç–æ–ª—â–∏–Ω–æ–º–µ—Ä–æ–º.',
            caption: '–ú–∏–Ω–∏–≤—ç–Ω: –±–æ–ª—å—à–µ –æ–±—ä—ë–º –∫—É–∑–æ–≤–∞ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ –¥–ª—è MPV –∏ –º–∏–∫—Ä–æ–∞–≤—Ç–æ–±—É—Å–æ–≤.'
          }
        };

        function applyThkVehiclePreview(type){
          if(!thkVehiclePreview || !thkVehicleImage || !thkVehicleCaption){
            return;
          }
          const media = type ? THK_VEHICLE_MEDIA[type] : null;
          if(!media){
            thkVehiclePreview.classList.add('hidden');
            thkVehicleImage.src = '';
            thkVehicleImage.alt = '';
            thkVehicleCaption.textContent = '';
            return;
          }
          thkVehicleImage.src = media.src;
          thkVehicleImage.alt = media.alt;
          thkVehicleCaption.textContent = media.caption;
          thkVehiclePreview.classList.remove('hidden');
        }

        const obdMakeCards = document.querySelectorAll('.obd-make-card');
        const obdVehiclePreview = $('obd-vehicle-preview');
        const obdVehicleImage = $('obd-vehicle-image');
        const obdVehicleCaption = $('obd-vehicle-caption');

        const OBD_VEHICLE_MEDIA = {
          Toyota: {
            src: './assets/images/logo-toyota.jpg',
            alt: '–õ–æ–≥–æ—Ç–∏–ø Toyota –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.',
            caption: 'Toyota: –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø–ª–∞—Ç—ã –∏ —à–∏–Ω—ã CAN. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, –≥–¥–µ –∏—Å–∫–∞—Ç—å —Ä–∞–∑—ä—ë–º OBD‚ÄëII –∏ –∫–∞–∫–∏–µ —Å–∏—Å—Ç–µ–º—ã –¥–æ—Å—Ç—É–ø–Ω—ã.'
          },
          Lexus: {
            src: './assets/images/Lexus-Logo-1280x720.png',
            alt: '–õ–æ–≥–æ—Ç–∏–ø Lexus –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.',
            caption: 'Lexus: –ø—Ä–µ–º–∏–∞–ª—å–Ω–∞—è —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞ –∏ –≥–∏–±—Ä–∏–¥–Ω—ã–µ –∫–æ–º–ø–ª–µ–∫—Å—ã. –ü–æ–¥—Å–∫–∞–∂–µ–º, –∫–∞–∫–∏–µ –±–ª–æ–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è —á—Ç–µ–Ω–∏—è –∏ –∫–∞–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –≥–∏–±—Ä–∏–¥–Ω—ã–º–∏ –º–æ–¥—É–ª—è–º–∏.'
          }
        };

        function applyObdVehiclePreview(make){
          if(!obdVehiclePreview || !obdVehicleImage || !obdVehicleCaption){
            return;
          }
          const media = make ? OBD_VEHICLE_MEDIA[make] : null;
          if(!media){
            obdVehiclePreview.classList.add('hidden');
            obdVehicleImage.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
            obdVehicleImage.alt = '';
            obdVehicleCaption.textContent = '';
            return;
          }
          obdVehicleImage.src = media.src;
          obdVehicleImage.alt = media.alt;
          obdVehicleCaption.textContent = media.caption;
          obdVehiclePreview.classList.remove('hidden');
        }

    let obdMake = '';
    let obdMode = 'general';
        let obdSelectedPort = '';
        let obdSerialPorts = [];
        let obdScanResults = [];
        let obdPaymentIntent = null;
        let obdPaymentBreakdown = null;
        let obdSessionOpen = false;
        let obdStatusSummary = null;
        let obdLiveData = null;
        let obdSelfCheckReport = null;
        let obdSelfCheckOk = false;
        let obdSelfCheckTimestamp = null;
        let obdSelfCheckRunning = false;
        let obdSelfCheckError = '';
      let obdLastSnapshot = null;
  let obdSessionState = null;

        function handleScreenActivated(id){
          const thicknessActive = id === 'screen-thk-measure';
          enableThicknessPolling(thicknessActive);
          const shouldPollObd = id === 'screen-obd-scan' || (obdSessionOpen && (id === 'screen-obd-paywall' || id === 'screen-obd-results'));
          enableObdPolling(shouldPollObd);
          if(id === 'screen-obd-scan'){
            loadObdPorts(true);
          }
          if(id === 'screen-thk-intro'){
            ensureThicknessSessionId();
          }
          if(id === 'screen-obd-intro'){
            ensureObdSessionId();
          }
          if(id === 'screen-thk-done'){
            maybeSendReport('thickness');
          }
          if(id === 'screen-obd-done'){
            maybeSendReport('diagnostics');
          }
          // AI UI hidden: no exposure in client
        }

        function enableThicknessPolling(shouldEnable){
          if(shouldEnable){
            if(thicknessPollTimer) return;
            pollThickness();
            thicknessPollTimer = setInterval(()=>{ pollThickness(); }, THICKNESS_POLL_INTERVAL_MS);
          } else if(thicknessPollTimer){
            clearInterval(thicknessPollTimer);
            thicknessPollTimer = null;
          }
        }

        function enableObdPolling(shouldEnable){
          if(shouldEnable){
            if(obdPollTimer) return;
            pollObd();
            obdPollTimer = setInterval(()=>{ pollObd(); }, OBD_POLL_INTERVAL_MS);
          } else if(obdPollTimer){
            clearInterval(obdPollTimer);
            obdPollTimer = null;
          }
        }

  const obdModeCards = document.querySelectorAll('.obd-mode-card');
  const obdContactInput = $('obd-contact');
  const obdContactError = $('obd-contact-error');
  const obdC1 = $('obd-continue-1');
  const obdC2 = $('obd-continue-2');
        const obdC3 = $('obd-continue-3');
        const obdC4 = $('obd-continue-4');
  const obdFinish = $('obd-finish');
  const obdAiBtn = null; // AI UI removed (internal-only)
  const obdAiBox = $('obd-ai-box');
  const obdAiSummary = $('obd-ai-summary');
  const obdAiRecos = $('obd-ai-recos');
  const obdAiDisclaimer = $('obd-ai-disclaimer');
  const obdPortSelect = $('obd-port');
  const obdRefreshBtn = $('obd-refresh');
  const obdRefreshLabelBase = obdRefreshBtn?.textContent || '–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫';
  const obdPortStatus = $('obd-port-status');
  const obdLastPortRefresh = $('obd-port-last-refresh');
  let obdPortLoadPending = false;

        function setObdMode(mode){
          if(!mode || !OBD_MODE_CONFIGS[mode]) return;
          obdMode = mode;
          obdModeCards.forEach(card=>{
            const isCurrent = card.getAttribute('data-mode') === mode;
            card.classList.toggle('selected', isCurrent);
            card.setAttribute('aria-pressed', isCurrent ? 'true' : 'false');
          });
          if(obdC1) obdC1.disabled = false;
          applyObdModeUi();
        }

        obdModeCards.forEach(card=>{
          card.addEventListener('click', ()=>{
            const mode = card.getAttribute('data-mode');
            setObdMode(mode);
          });
          card.addEventListener('keydown', (e)=>{
            if(e.key === 'Enter' || e.key === ' '){
              e.preventDefault();
              card.click();
            }
          });
        });
        obdC1?.addEventListener('click', ()=>{
          idx = screens.indexOf('screen-obd-contact');
          show('screen-obd-contact');
          prefillContact('diagnostics');
        });

        obdC2?.addEventListener('click', ()=>{
          idx = screens.indexOf('screen-obd-vehicle');
          show('screen-obd-vehicle');
          applyObdVehiclePreview(obdMake);
          if(obdC3) obdC3.disabled = !obdMake;
        });

        obdC3?.addEventListener('click', ()=>{
          idx = screens.indexOf('screen-obd-prep');
          show('screen-obd-prep');
        });

        obdC4?.addEventListener('click', ()=>{
          idx = screens.indexOf('screen-obd-scan');
          show('screen-obd-scan');
        });

        // AI click handler removed (internal-only automation)

        obdRefreshBtn?.addEventListener('click', ()=>{
          loadObdPorts(true);
        });

        obdPortSelect?.addEventListener('change', ()=>{
          const value = obdPortSelect.value;
          obdSelectedPort = value;
          if(value){
            setObdPortStatus(`–í—ã–±—Ä–∞–Ω –ø–æ—Ä—Ç ${value}.`, 'info');
          } else {
            setObdPortStatus('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Ä—Ç –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.', 'warn');
          }
          pollObd();
        });
    const thkContactInput = $('thk-contact');
    const thkContactError = $('thk-contact-error');
    const thkC1 = $('thk-continue-1');
    const thkC2 = $('thk-continue-2');
  const thkC3 = $('thk-continue-3');
  const thkAmountEl = $('thk-amount');
        let thkType = '';
        let thkPrice = 0;

        function resetThkSelection(){
          thkType = '';
          thkPrice = 0;
          thkTypeCards.forEach(card=>{
            card.classList.remove('selected');
            card.setAttribute('aria-pressed', 'false');
          });
          if(thkC1) thkC1.disabled = true;
          applyThkVehiclePreview('');
        }

        function resetObdVehicleSelection(){
          obdMake = '';
          obdMakeCards.forEach(card=>{
            card.classList.remove('selected');
            card.setAttribute('aria-pressed', 'false');
          });
          if(obdC3) obdC3.disabled = true;
          applyObdVehiclePreview('');
        }

        const contactControllers = {
          thickness: {
            key: 'thickness',
            input: thkContactInput,
            continueBtn: thkC2,
            error: thkContactError
          },
          diagnostics: {
            key: 'diagnostics',
            input: obdContactInput,
            continueBtn: obdC2,
            error: obdContactError
          }
        };

        function preparePhoneDigits(rawValue){
          const digits = (rawValue || '').replace(/\D/g, '');
          if(!digits) return '';
          let normalized = digits;
          if(normalized.startsWith('8')){
            normalized = `7${normalized.slice(1)}`;
          } else if(normalized.startsWith('9') && normalized.length <= 10){
            normalized = `7${normalized}`;
          } else if(!normalized.startsWith('7')){
            normalized = `7${normalized}`;
          }
          return normalized.slice(0, 11);
        }

        function formatPhoneDigits(normalizedDigits){
          if(!normalizedDigits) return '';
          let formatted = '+7';
          const zone = normalizedDigits.slice(1, Math.min(4, normalizedDigits.length));
          if(zone){
            formatted += ` (${zone}`;
            if(zone.length === 3){
              formatted += ')';
            }
          }
          const block2 = normalizedDigits.slice(4, Math.min(7, normalizedDigits.length));
          if(block2){
            formatted += ` ${block2}`;
          }
          const block3 = normalizedDigits.slice(7, Math.min(9, normalizedDigits.length));
          if(block3){
            formatted += `-${block3}`;
          }
          const block4 = normalizedDigits.slice(9, Math.min(11, normalizedDigits.length));
          if(block4){
            formatted += `-${block4}`;
          }
          return formatted;
        }

        function autoFormatContactInput(inputEl){
          if(!inputEl) return;
          const raw = inputEl.value;
          if(!raw){
            return;
          }
          if(/[a-z–∞-—è—ë]/i.test(raw) || raw.includes('@')){
            return;
          }
          const digits = preparePhoneDigits(raw);
          if(!digits){
            inputEl.value = '';
            return;
          }
          const formatted = formatPhoneDigits(digits);
          if(formatted !== raw){
            inputEl.value = formatted;
            requestAnimationFrame(()=>{
              const len = inputEl.value.length;
              inputEl.setSelectionRange(len, len);
            });
          }
        }

        function validateContactValue(rawValue){
          const trimmed = (rawValue || '').trim();
          if(!trimmed){
            return { valid: false, message: '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ email.' };
          }
          const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i;
          if(emailPattern.test(trimmed)){
            return {
              valid: true,
              type: 'email',
              normalized: trimmed.toLowerCase()
            };
          }
          const preparedDigits = preparePhoneDigits(trimmed);
          if(preparedDigits.length < 11){
            return {
              valid: false,
              message: '–£–∫–∞–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –∏–∑ 11 —Ü–∏—Ñ—Ä, –Ω–∞–ø—Ä–∏–º–µ—Ä +7 (900) 123-45-67.'
            };
          }
          const normalizedDigits = preparedDigits.slice(0, 11);
          const formatted = formatPhoneDigits(normalizedDigits);
          return {
            valid: true,
            type: 'phone',
            normalized: `+${normalizedDigits}`,
            formatted
          };
        }

        function updateContactState(key){
          const controller = contactControllers[key];
          if(!controller) return { valid: false };
          const { input, continueBtn, error } = controller;
          if(!input || !continueBtn) return { valid: false };
          const raw = input.value || '';
          const result = validateContactValue(raw);
          if(result.valid){
            continueBtn.disabled = false;
            input.setAttribute('data-valid', '1');
            input.removeAttribute('data-invalid');
            input.setAttribute('aria-invalid', 'false');
            if(error){
              error.textContent = '';
              error.classList.remove('visible');
            }
            sessionState.contact[key] = {
              raw: raw.trim(),
              normalized: result.normalized,
              type: result.type
            };
          } else {
            continueBtn.disabled = true;
            sessionState.contact[key] = null;
            input.removeAttribute('data-valid');
            if(raw.trim()){
              input.setAttribute('data-invalid', '1');
              input.setAttribute('aria-invalid', 'true');
              if(error && result.message){
                error.textContent = result.message;
                error.classList.add('visible');
              }
            } else {
              input.removeAttribute('data-invalid');
              input.setAttribute('aria-invalid', 'false');
              if(error){
                error.textContent = '';
                error.classList.remove('visible');
              }
            }
            if(!raw.trim() && error){
              error.textContent = '';
              error.classList.remove('visible');
            }
          }
          return result;
        }

        function prefillContact(key){
          const controller = contactControllers[key];
          if(!controller || !controller.input) return;
          const stored = sessionState.contact[key];
          if(stored?.raw){
            controller.input.value = stored.raw;
            autoFormatContactInput(controller.input);
          }
          updateContactState(key);
        }

        function commitContactFormatting(key){
          const controller = contactControllers[key];
          if(!controller || !controller.input) return;
          autoFormatContactInput(controller.input);
          const result = validateContactValue(controller.input.value);
          if(result.valid && result.type === 'phone' && result.formatted){
            controller.input.value = result.formatted;
          }
          updateContactState(key);
        }

        function attachContactHandlers(key){
          const controller = contactControllers[key];
          if(!controller || !controller.input) return;
          controller.input.addEventListener('input', ()=>{
            autoFormatContactInput(controller.input);
            const state = updateContactState(key);
            if(state.valid){
              controller.input.setAttribute('data-valid', '1');
            } else if(!controller.input.value.trim()){
              controller.input.removeAttribute('data-valid');
            }
          });
          controller.input.addEventListener('blur', ()=>{
            commitContactFormatting(key);
          });
          updateContactState(key);
        }

        attachContactHandlers('thickness');
        attachContactHandlers('diagnostics');

        function clearContact(key){
          const controller = contactControllers[key];
          if(!controller) return;
          sessionState.contact[key] = null;
          const { input, continueBtn, error } = controller;
          if(input){
            input.value = '';
            input.removeAttribute('data-valid');
            input.removeAttribute('data-invalid');
            input.setAttribute('aria-invalid', 'false');
          }
          if(error){
            error.textContent = '';
            error.classList.remove('visible');
          }
          if(continueBtn){
            continueBtn.disabled = true;
          }
          updateContactState(key);
        }

        thkTypeCards.forEach((el)=>{
          el.addEventListener('click', ()=>{
            thkTypeCards.forEach(card=>{
              const selected = card === el;
              card.classList.toggle('selected', selected);
              card.setAttribute('aria-pressed', selected ? 'true' : 'false');
            });
            thkType = el.getAttribute('data-type') || '';
            thkPrice = Number(el.getAttribute('data-price')||'0');
            applyThkVehiclePreview(thkType);
            if(thkC1) thkC1.disabled = false;
          });
          el.addEventListener('keydown', (e)=>{
            if(e.key==='Enter'||e.key===' '){
              e.preventDefault();
              el.click();
            }
          });
        });

        obdMakeCards.forEach(card=>{
          card.addEventListener('click', ()=>{
            obdMakeCards.forEach(other=>{
              const selected = other === card;
              other.classList.toggle('selected', selected);
              other.setAttribute('aria-pressed', selected ? 'true' : 'false');
            });
            obdMake = card.getAttribute('data-make') || '';
            applyObdVehiclePreview(obdMake);
            if(obdC3) obdC3.disabled = !obdMake;
          });
          card.addEventListener('keydown', (e)=>{
            if(e.key === 'Enter' || e.key === ' '){
              e.preventDefault();
              card.click();
            }
          });
        });

        thkC1?.addEventListener('click', ()=>{
          idx = screens.indexOf('screen-thk-contact');
          show('screen-thk-contact');
          prefillContact('thickness');
        });
        thkC2?.addEventListener('click', async ()=>{
          idx = screens.indexOf('screen-thk-payment');
          if(thkAmountEl) thkAmountEl.textContent = thkPrice ? `–ö –æ–ø–ª–∞—Ç–µ: ${thkPrice} ‚ÇΩ` : '';
          show('screen-thk-payment');
          setupThicknessPaymentUI();
        });
        thkC3.addEventListener('click', async ()=>{
          idx = screens.indexOf('screen-thk-measure');
          show('screen-thk-measure');
          // Try to open thickness device using selected type (BLE hints optional)
          try{
            const payload = { type: thkType || 'sedan' };
            const resp = await fetch(`${API_BASE}/api/thk/open`, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload) });
            const data = await resp.json().catch(()=>({}));
            if(resp.ok && data?.ok){
              if(thkStatus){ thkStatus.className='badge badge-ok'; thkStatus.textContent='–¢–æ–ª—â–∏–Ω–æ–º–µ—Ä: –ø–æ–¥–∫–ª—é—á—ë–Ω'; }
              if(thkStart){ thkStart.disabled = false; }
            }
          }catch{}
        });
        const thkStart = $('thk-start');
        const thkStatus = document.getElementById('thk-status');
        let thkSessionActive = false;
        let thkLastSession = null;
        const thkSessionBox = document.getElementById('thk-session');
        const thkProgressEl = document.getElementById('thk-progress');
        const thkPointsGrid = document.getElementById('thk-points-grid');
        const thkDevMarkBtn = document.getElementById('thk-dev-mark');
        const thkFinishBtn = document.getElementById('thk-finish');

        function setThkSessionVisible(visible){
          if(!thkSessionBox) return;
          thkSessionBox.classList.toggle('hidden', !visible);
        }

        function renderThkSession(session){
          thkLastSession = session || null;
          if(!session){
            if(thkProgressEl) thkProgressEl.textContent = '‚Äî';
            if(thkPointsGrid) thkPointsGrid.innerHTML = '';
            if(thkFinishBtn) thkFinishBtn.disabled = true;
            return;
          }
          // progress
          const m = Number(session.measuredCount||0);
          const s = Number(session.skippedCount||0);
          const p = Number(session.pendingCount||0);
          if(thkProgressEl){
            thkProgressEl.textContent = `–í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${m} ‚Ä¢ –ü—Ä–æ–ø—É—â–µ–Ω–æ: ${s} ‚Ä¢ –û—Å—Ç–∞–ª–æ—Å—å: ${p}`;
          }
          // grid
          if(thkPointsGrid && Array.isArray(session.points)){
            thkPointsGrid.innerHTML = session.points.map(pt=>{
              const st = pt.status || 'pending';
              const label = escapeHtml(pt.label || pt.id);
              const cls = st === 'measured' ? 'thk-point thk-point--ok' : st === 'skipped' ? 'thk-point thk-point--skip' : 'thk-point thk-point--pending';
              return `<div class="${cls}" title="${label}"><span class="thk-point-label">${label}</span></div>`;
            }).join('');
          }
          if(thkFinishBtn) thkFinishBtn.disabled = !session.active;
        }

        async function fetchThkSession(){
          try{
            const resp = await fetch(`${API_BASE}/api/thk/session`, { cache: 'no-store' });
            const json = await resp.json().catch(()=>({}));
            if(resp.ok){
              return json?.session || (json?.active !== undefined ? json : null);
            }
          }catch{}
          return null;
        }

        thkStart?.addEventListener('click', async ()=>{
          if(!thkType){ alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∞–≤—Ç–æ–º–æ–±–∏–ª—è.'); return; }
          thkStart.disabled = true;
          thkStart.dataset.locked = '1';
          try{
            // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ sessionId –∏ –ø–µ—Ä–µ–¥–∞—ë–º –µ–≥–æ –∞–≥–µ–Ω—Ç—É
            ensureThicknessSessionId();
            const resp = await fetch(`${API_BASE}/api/thk/start`, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ type: thkType, sessionId: sessionState.session.thicknessId }) });
            const data = await resp.json().catch(()=>({}));
            if(resp.ok && (data?.ok || data?.active)){
              // Keep on measure screen and render session grid
              thkSessionActive = true;
              setThkSessionVisible(true);
              const session = data?.session || (data.active !== undefined ? data : null);
              renderThkSession(session);
              // –µ—Å–ª–∏ –∞–≥–µ–Ω—Ç –≤–µ—Ä–Ω—É–ª sessionId (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏–ª), —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –µ–≥–æ –ª–æ–∫–∞–ª—å–Ω–æ
              if(data?.sessionId){ sessionState.session.thicknessId = data.sessionId; }
              // Show DEV helper
              if(thkDevMarkBtn){ thkDevMarkBtn.style.display = isDev ? '' : 'none'; }
            } else {
              const message = data?.message || data?.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å —Å–µ—Å—Å–∏—é –∏–∑–º–µ—Ä–µ–Ω–∏–π.';
              alert(String(message));
              thkStart.disabled = false;
              delete thkStart.dataset.locked;
            }
          }catch(e){
            alert('–ê–≥–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.');
            thkStart.disabled = false;
            delete thkStart.dataset.locked;
          }
        });

        // DEV: mark next point as skipped
        thkDevMarkBtn?.addEventListener('click', async ()=>{
          if(!isDev || !thkSessionActive) return;
          try{
            ensureThicknessSessionId();
            const resp = await fetch(`${API_BASE}/api/thk/mark-point`, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ sessionId: sessionState.session.thicknessId }) });
            const data = await resp.json().catch(()=>({}));
            if(resp.ok && data?.ok && data?.session){
              renderThkSession(data.session);
            }
          }catch{}
        });

        // Finish session
        thkFinishBtn?.addEventListener('click', async ()=>{
          try{
            ensureThicknessSessionId();
            await fetch(`${API_BASE}/api/thk/stop`, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ sessionId: sessionState.session.thicknessId }) });
          }catch{}
          thkSessionActive = false;
          setThkSessionVisible(false);
          idx = screens.indexOf('screen-thk-done');
          show('screen-thk-done');
        });

        function resetThicknessFlow(){
          clearContact('thickness');
          thkType = '';
          thkPrice = 0;
          sessionState.session.thicknessId = null;
          sessionState.reportSent.thickness = false;
          enableThicknessPolling(false);
          thicknessPollPending = false;
          thkTypeCards.forEach(card=>{
            card.classList.remove('selected');
            card.setAttribute('aria-pressed', 'false');
          });
          if(thkC1) thkC1.disabled = true;
          if(thkC2) thkC2.disabled = true;
          applyThkVehiclePreview('');
          if(typeof window !== 'undefined'){ window.__thk_intent = null; }
          if(thkAmountEl) thkAmountEl.textContent = '';
          if(thkStart){
            thkStart.disabled = true;
            thkStart.dataset.locked = '';
            thkStart.textContent = '–ù–∞—á–∞—Ç—å –∏–∑–º–µ—Ä–µ–Ω–∏—è';
          }
          if(thkStatus){
            thkStatus.className = 'badge badge-danger';
            thkStatus.textContent = '–¢–æ–ª—â–∏–Ω–æ–º–µ—Ä: –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
          }
        }
        async function pollThickness(){
          if(thicknessPollPending) return;
          thicknessPollPending = true;
          try{
            const r = await fetch(api('/devices/status'));
            const d = await r.json();
            if(d?.status?.thickness==='connected'){
              thkStart.disabled = false;
              if(thkStatus){ thkStatus.className='badge badge-ok'; thkStatus.textContent='–¢–æ–ª—â–∏–Ω–æ–º–µ—Ä: –ø–æ–¥–∫–ª—é—á—ë–Ω'; }
            } else {
              thkStart.disabled = true;
              if(thkStatus){ thkStatus.className='badge badge-danger'; thkStatus.textContent='–¢–æ–ª—â–∏–Ω–æ–º–µ—Ä: –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'; }
            }
            // Also poll the thickness session if we're on the measure screen
            if(activeScreenId === 'screen-thk-measure'){
              const session = await fetchThkSession();
              if(session && session.active){
                thkSessionActive = true;
                setThkSessionVisible(true);
                renderThkSession(session);
                if(thkDevMarkBtn){ thkDevMarkBtn.style.display = isDev ? '' : 'none'; }
              }
            }
          }catch{}
          finally {
            thicknessPollPending = false;
          }
        }
        $('back-to-home-1')?.addEventListener('click', async ()=>{
          await resetAllSessionState();
          idx = screens.indexOf('screen-attract');
          show('screen-attract');
        });

  // OBD flow
  const obdPaymentInfo = $('obd-payment-info');
  const obdPaywallLead = $('obd-paywall-lead');
  const obdPaywallAmount = $('obd-paywall-amount');
  const obdResultsTitle = $('obd-results-title');
  const obdResultsLead = $('obd-results-lead');
  const obdResultsList = $('obd-results-list');
  const obdResultsWrapper = $('obd-results-wrapper');
  const obdStatusSummaryEl = $('obd-status-summary');
  const obdLiveDataEl = $('obd-live-data');
  const obdSummaryGrid = $('obd-summary-grid');
        const obdClear = $('obd-clear');
        const obdLiveRefresh = $('obd-live-refresh');
        const obdSelfCheckBox = $('obd-self-check');
        const obdSelfCheckRerun = $('obd-self-check-rerun');
        const obdSelfCheckResultsBox = $('obd-self-check-results');
        const obdSelfCheckBoxBaseClass = obdSelfCheckBox?.className || '';
        const obdSelfCheckResultsBoxBaseClass = obdSelfCheckResultsBox?.className || '';
        const obdSummaryGridBaseClass = obdSummaryGrid?.className || '';
        if(obdLiveRefresh) obdLiveRefresh.disabled = true;
        if(obdSelfCheckRerun){
          obdSelfCheckRerun.disabled = true;
          obdSelfCheckRerun.addEventListener('click', runObdSelfCheck);
        }

        const OBD_MODE_CONFIGS = {
          general: {
            id: 'general',
            label: '–≠–∫—Å–ø—Ä–µ—Å—Å-–ø—Ä–æ–≤–µ—Ä–∫–∞',
            price: 320,
            paywallLead: '–≠–∫—Å–ø—Ä–µ—Å—Å-–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–∏—Å—Ç–µ–º. –û–ø–ª–∞—Ç–∞ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –æ—Ç—á—ë—Ç–∞.',
            resultsLead: '–°–≤–æ–¥–∫–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–∏—Å—Ç–µ–º–∞–º –∞–≤—Ç–æ–º–æ–±–∏–ª—è. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–µ—Ç–∞–ª–∏.',
            resultsTitle: '–û–±—â–∏–π –æ–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º',
            showOverview: true,
            showDetailedList: true,
          },
          obd2: {
            id: 'obd2',
            label: 'OBD-II',
            price: 480,
            paywallLead: '–ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ OBD-II —Å–æ –≤—Å–µ–º–∏ –∫–æ–¥–∞–º–∏ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–µ–π –∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏.',
            resultsLead: '–ü–æ–¥—Ä–æ–±–Ω–∞—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –∫–æ–¥–æ–≤ OBD-II –∏ —Å—Ç–∞—Ç—É—Å–æ–≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.',
            resultsTitle: '–ö–æ–¥—ã –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–µ–π',
            showOverview: false,
            showDetailedList: true,
          }
        };

        function getObdModeConfig(){
          return OBD_MODE_CONFIGS[obdMode] || OBD_MODE_CONFIGS.general;
        }

        function applyObdModeUi(){
          const config = getObdModeConfig();
          if(obdPaywallLead) obdPaywallLead.textContent = config.paywallLead;
          if(obdResultsLead) obdResultsLead.textContent = config.resultsLead;
          if(obdResultsTitle) obdResultsTitle.textContent = config.resultsTitle;
          if(obdPaywallAmount) obdPaywallAmount.textContent = `–ö –æ–ø–ª–∞—Ç–µ: ${formatCurrency(config.price)}`;
        }

        setObdMode(obdMode);

        function renderObdResults(){
          if(!obdResultsList) return;
          if(obdResultsWrapper){
            obdResultsWrapper.querySelectorAll('.obd-note').forEach(n=>n.remove());
          }
          const config = getObdModeConfig();
          applyObdModeUi();
          renderObdStatusSummary();
          renderObdLiveData();
          renderObdSummaryView(config);

          if(config.showDetailedList === false){
            obdResultsList.innerHTML = '<div class="muted-note">–î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–¥—ã —Å–∫—Ä—ã—Ç—ã –¥–ª—è —ç—Ç–æ–≥–æ —Ä–µ–∂–∏–º–∞. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –Ω–∞ —Ä–µ–∂–∏–º OBD-II –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞.</div>';
            renderObdSelfCheckBoxes();
            return;
          }

          if(!obdScanResults || !obdScanResults.length){
            obdResultsList.textContent = '–ö–æ–¥–æ–≤ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–µ–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ. MIL –ø–æ–≥–∞—à–µ–Ω.';
            renderObdSelfCheckBoxes();
            return;
          }
          const list = document.createElement('ul');
          list.className = 'obd-results-list';
          obdScanResults.forEach(item=>{
            const li = document.createElement('li');
            li.className = 'obd-result-item';
            const header = document.createElement('div');
            header.className = 'obd-result-code';
            header.textContent = item.code;
            const severity = item.severity || 'info';
            const badge = document.createElement('span');
            badge.className = `obd-result-severity ${severityClass(severity)}`;
            badge.textContent = severityLabel(severity);
            header.appendChild(badge);
            li.appendChild(header);
            const desc = document.createElement('div');
            desc.className = 'obd-result-desc';
            desc.textContent = item.description || '–û–ø–∏—Å–∞–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –æ—Ç—á—ë—Ç.';
            li.appendChild(desc);
            if(item.status){
              const status = document.createElement('div');
              status.className = 'obd-note';
              status.textContent = item.status === 'current' ? '–ê–∫—Ç–∏–≤–Ω—ã–π –∫–æ–¥' : '–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –∫–æ–¥';
              li.appendChild(status);
            }
            list.appendChild(li);
          });
          obdResultsList.innerHTML = '';
          obdResultsList.appendChild(list);
          renderObdSelfCheckBoxes();
        }
  const obdStart = $('obd-start');
  const obdStatus = document.getElementById('obd-status');
  const obdConnectionMetaTargets = Array.from(document.querySelectorAll('[data-obd-connection-meta]'));

        function resetDiagnosticsFlow(){
          clearContact('diagnostics');
          resetObdVehicleSelection();
          sessionState.session.obdId = null;
          sessionState.reportSent.diagnostics = false;
          obdSelectedPort = '';
          obdSerialPorts = [];
          obdPortLoadPending = false;
          obdScanResults = [];
          obdPaymentIntent = null;
          obdPaymentBreakdown = null;
          enableObdPolling(false);
          obdPollPending = false;
          obdStatusSummary = null;
          obdLiveData = null;
          obdSelfCheckReport = null;
          obdSelfCheckOk = false;
          obdSelfCheckTimestamp = null;
          obdSelfCheckRunning = false;
          obdSelfCheckError = '';
          if(obdPortSelect){
            obdPortSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Ä—Ç‚Ä¶</option>';
          }
          if(obdPortStatus){
            setObdPortStatus('–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∞–¥–∞–ø—Ç–µ—Ä –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å–ø–∏—Å–æ–∫.', 'warn');
          }
            if(obdLastPortRefresh){
              obdLastPortRefresh.textContent = '';
            }
          if(obdRefreshBtn){
            obdRefreshBtn.disabled = false;
            obdRefreshBtn.textContent = obdRefreshLabelBase;
          }

          if(obdClear) obdClear.disabled = true;
          if(obdLiveRefresh) obdLiveRefresh.disabled = true;
          if(obdStart){
            obdStart.disabled = true;
            obdStart.dataset.locked = '';
            obdStart.textContent = '–ù–∞—á–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ';
          }
          setObdMode('general');
          if(obdStatus){
            obdStatus.className = 'badge badge-danger';
            obdStatus.textContent = 'OBD‚Äë–∞–¥–∞–ø—Ç–µ—Ä: –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
          }
          renderObdResults();
          renderObdPaymentInfo();
          obdSummaryGrid?.className && (obdSummaryGrid.className = obdSummaryGridBaseClass);
          renderObdConnectionMeta(null, null);
          renderObdSelfCheckBoxes();
          obdLastSnapshot = null;
          obdSessionState = null;
        }

        async function fetchObdSnapshot(){
          const endpoints = [
            { url: api('/api/obd/snapshot'), pick: data => data?.snapshot ?? null },
            { url: api('/devices/status'), pick: data => data?.snapshot ?? null, legacy: data => data?.status?.obd }
          ];
          for(const endpoint of endpoints){
            try{
              const resp = await fetch(endpoint.url, { cache: 'no-store' });
              const json = await resp.json().catch(()=>null);
              if(!resp.ok) continue;
              const snapshot = endpoint.pick(json);
              if(snapshot){
                return snapshot;
              }
              if(endpoint.legacy){
                const legacyState = endpoint.legacy(json);
                if(legacyState){
                  return { state: normalizeLegacyObdState(legacyState), reconnectAttempts: 0 };
                }
              }
            } catch(error){
              console.warn('fetchObdSnapshot error', endpoint.url, error);
            }
          }
          return null;
        }

        function normalizeLegacyObdState(state){
          if(state === 'connected' || state === 'connecting') return state;
          return 'disconnected';
        }

        async function fetchObdSession(){
          try{
            const resp = await fetch(api('/api/obd/session'), { cache: 'no-store' });
            if(!resp.ok) return null;
            const json = await resp.json().catch(()=>null);
            return json?.session ?? null;
          } catch(error){
            console.warn('fetchObdSession error', error);
            return null;
          }
        }

        function renderObdConnectionMeta(snapshot, session, errorMessage){
          if(!obdConnectionMetaTargets.length) return;
          let html = '<strong>–°–æ—Å—Ç–æ—è–Ω–∏–µ –∞–¥–∞–ø—Ç–µ—Ä–∞</strong>';

          if(!snapshot){
            const baseMessage = obdSessionOpen
              ? '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ –∞–¥–∞–ø—Ç–µ—Ä–∞.'
              : '–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∞–¥–∞–ø—Ç–µ—Ä –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å–ø–∏—Å–æ–∫.';
            const message = errorMessage ? `${baseMessage} ${errorMessage}`.trim() : baseMessage;
            const blockClass = errorMessage ? 'meta-block error' : 'meta-block';
            html += `<div class="${blockClass}">${escapeHtml(message)}</div>`;
          } else {
            const state = snapshot.state ?? 'disconnected';
            const stateLabel = state === 'connected' ? '–ø–æ–¥–∫–ª—é—á—ë–Ω' : state === 'connecting' ? '–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ‚Ä¶' : '–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
            const lines = [`–°–æ—Å—Ç–æ—è–Ω–∏–µ: ${stateLabel}`];

            if(snapshot.transport === 'serial'){
              let label = '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç: Serial';
              if(snapshot.portPath) label += ` ‚Ä¢ ${snapshot.portPath}`;
              if(typeof snapshot.baudRate === 'number') label += ` ‚Ä¢ ${snapshot.baudRate} –±–æ–¥`;
              lines.push(label);
            } else if(snapshot.transport === 'bluetooth'){
              const btParts = [];
              if(snapshot.bluetoothName) btParts.push(snapshot.bluetoothName);
              if(snapshot.bluetoothAddress) btParts.push(snapshot.bluetoothAddress);
              if(typeof snapshot.bluetoothChannel === 'number') btParts.push(`–∫–∞–Ω–∞–ª ${snapshot.bluetoothChannel}`);
              const label = btParts.length ? `–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç: Bluetooth ‚Ä¢ ${btParts.join(' ‚Ä¢ ')}` : '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç: Bluetooth';
              lines.push(label);
            }

            if(snapshot.identity){
              lines.push(`–ê–¥–∞–ø—Ç–µ—Ä: ${snapshot.identity}`);
            }
            if(snapshot.lastConnectedAt){
              const connectedAt = formatSelfCheckTimestamp(snapshot.lastConnectedAt);
              if(connectedAt){
                lines.push(`–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: ${connectedAt}`);
              }
            }
            if(snapshot.lastFailureAt){
              const failureAt = formatSelfCheckTimestamp(snapshot.lastFailureAt);
              if(failureAt){
                lines.push(`–ü–æ—Å–ª–µ–¥–Ω–∏–π —Å–±–æ–π: ${failureAt}`);
              }
            }
            if(typeof snapshot.reconnectAttempts === 'number' && snapshot.reconnectAttempts > 0){
              lines.push(`–ü–æ–ø—ã—Ç–∫–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${snapshot.reconnectAttempts}`);
            }
            if(snapshot.lastError){
              lines.push(`–ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: ${snapshot.lastError}`);
            }

            const metrics = snapshot.metrics || null;
            const metricsItems = [];
            if(metrics){
              metricsItems.push(`–ö–æ–º–∞–Ω–¥: ${metrics.totalCommands} (—É—Å–ø–µ—à–Ω–æ: ${metrics.successfulCommands}, –æ—à–∏–±–∫–∏: ${metrics.failedCommands}, —Ç–∞–π–º–∞—É—Ç—ã: ${metrics.timeouts})`);
              if(Number.isFinite(metrics.averageLatencyMs)){
                metricsItems.push(`–°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞: ${Math.round(metrics.averageLatencyMs)} –º—Å`);
              }
              if(metrics.lastCommand){
                const duration = Number.isFinite(metrics.lastDurationMs) ? ` ‚Ä¢ ${Math.round(metrics.lastDurationMs)} –º—Å` : '';
                metricsItems.push(`–ü–æ—Å–ª–µ–¥–Ω—è—è –∫–æ–º–∞–Ω–¥–∞: ${metrics.lastCommand}${duration}`);
              }
              if(metrics.lastError){
                metricsItems.push(`–û—à–∏–±–∫–∞: ${metrics.lastError}`);
              }
            }

            if(lines.length){
              html += `<ul>${lines.map(line=>`<li>${escapeHtml(line)}</li>`).join('')}</ul>`;
            }
            if(session){
              const sessionLines = buildSessionLines(session);
              if(sessionLines.length){
                html += `<div class="meta-block"><div>–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏</div><ul>${sessionLines.map(item=>`<li>${escapeHtml(item)}</li>`).join('')}</ul></div>`;
              }
            }
            if(metricsItems.length){
              html += `<div class="meta-block"><div>–ú–µ—Ç—Ä–∏–∫–∏</div><ul>${metricsItems.map(item=>`<li>${escapeHtml(item)}</li>`).join('')}</ul></div>`;
            }
            if(errorMessage){
              html += `<div class="meta-block error">${escapeHtml(errorMessage)}</div>`;
            }
          }

          obdConnectionMetaTargets.forEach(target => {
            target.innerHTML = html;
          });

          function buildSessionLines(sessionSnapshot){
            if(!sessionSnapshot) return [];
            const sessionState = sessionSnapshot.state || 'disconnected';
            const stateMap = {
              disconnected: '–Ω–µ—Ç —Å–µ—Å—Å–∏–∏',
              connecting: '—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ',
              authenticating: '–ø—Ä–æ—Ö–æ–¥–∏—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è',
              ready: '–≥–æ—Ç–æ–≤ –∫ –æ–ø–µ—Ä–∞—Ü–∏—è–º',
              reading: '–∏–¥—ë—Ç –∑–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö',
              clearing: '–æ—á–∏—Å—Ç–∫–∞ –∫–æ–¥–æ–≤',
              error: '–æ—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏',
            };
            const lines = [`–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: ${stateMap[sessionState] || sessionState}`];
            if(sessionSnapshot.activeOperation){
              const active = sessionSnapshot.activeOperation;
              const labelMap = {
                read_dtc: '–ß—Ç–µ–Ω–∏–µ –∫–æ–¥–æ–≤',
                live_data: '–ü–æ–ª—É—á–µ–Ω–∏–µ live-–¥–∞–Ω–Ω—ã—Ö',
                status: '–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º',
                self_check: '–°–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–∞–ø—Ç–µ—Ä–∞',
                clear_dtc: '–û—á–∏—Å—Ç–∫–∞ –∫–æ–¥–æ–≤',
              };
              const opLabel = labelMap[active.name] || active.name;
              lines.push(`${opLabel}: –ø–æ–ø—ã—Ç–∫–∞ ${active.attempt}/${active.maxAttempts}`);
            }
            if(sessionSnapshot.lastError){
              const lastErr = sessionSnapshot.lastError;
              const op = lastErr.operation ? ` (${lastErr.operation})` : '';
              lines.push(`–ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞${op}: ${lastErr.message}`);
            }
            if(Array.isArray(sessionSnapshot.history) && sessionSnapshot.history.length){
              const recent = sessionSnapshot.history.slice(-3).map(entry=>{
                return `${entry.state}${entry.reason ? ` ‚Ä¢ ${entry.reason}` : ''}`;
              });
              lines.push(`–ò—Å—Ç–æ—Ä–∏—è: ${recent.join(' ‚Üí ')}`);
            }
            return lines;
          }
        }
        async function pollObd(){
          if(obdPollPending) return;
          obdPollPending = true;
          try{
            const [snapshot, session] = await Promise.all([fetchObdSnapshot(), fetchObdSession()]);
            if(snapshot){
              obdLastSnapshot = snapshot;
            }
            if(session){
              obdSessionState = session;
            }
            const effectiveSnapshot = snapshot || obdLastSnapshot;
            if(effectiveSnapshot){
              const message = snapshot ? undefined : '–ê–≥–µ–Ω—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç';
              renderObdConnectionMeta(effectiveSnapshot, obdSessionState, message);
            } else {
              renderObdConnectionMeta(null, obdSessionState, '–ê–≥–µ–Ω—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç');
            }
            const state = (snapshot || obdLastSnapshot)?.state || 'disconnected';
            const connected = state === 'connected';
            const connecting = state === 'connecting';
            if(obdStart && !obdStart.dataset.locked){
              const allowStart = connected && !!obdSelectedPort;
              obdStart.disabled = !allowStart;
            }
            if(obdStatus){
              if(connected){
                const identity = effectiveSnapshot?.identity ? ` (${effectiveSnapshot.identity})` : '';
                obdStatus.className='badge badge-ok';
                obdStatus.textContent=`OBD‚Äë–∞–¥–∞–ø—Ç–µ—Ä: –ø–æ–¥–∫–ª—é—á—ë–Ω${identity}`;
              } else if(connecting){
                obdStatus.className='badge badge-warn';
                obdStatus.textContent='OBD‚Äë–∞–¥–∞–ø—Ç–µ—Ä: –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è‚Ä¶';
              } else {
                const lastError = snapshot?.lastError;
                obdStatus.className='badge badge-danger';
                obdStatus.textContent= lastError ? `OBD‚Äë–∞–¥–∞–ø—Ç–µ—Ä: –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (${lastError})` : 'OBD‚Äë–∞–¥–∞–ø—Ç–µ—Ä: –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
              }
            }
          }catch(error){
            console.warn('pollObd error', error);
            renderObdConnectionMeta(obdLastSnapshot, obdSessionState, '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
          }
          finally {
            obdPollPending = false;
          }
        }
        obdStart?.addEventListener('click', startObdScan);
  obdClear?.addEventListener('click', clearObdCodes);
  obdLiveRefresh?.addEventListener('click', ()=>{ loadObdLiveData(true); });
        obdFinish?.addEventListener('click', async ()=>{
          await closeObdSession();
          idx = screens.indexOf('screen-obd-done');
          show('screen-obd-done');
        });
  $('back-to-home-2')?.addEventListener('click', async ()=>{
    await resetAllSessionState();
    idx = screens.indexOf('screen-attract');
    show('screen-attract');
  });

        async function resetAllSessionState(){
          resetServiceSelection();
          if(welcomeAgree){
            welcomeAgree.checked = false;
          }
          updateWelcomeState();
          resetThicknessFlow();
          await closeObdSession();
          resetDiagnosticsFlow();
        }

        // Generic back buttons
        document.querySelectorAll('[data-back]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const current = document.querySelector('.screen.active')?.id || 'screen-services';
            const flowRoots = ['screen-thk-intro','screen-obd-intro'];
            if(flowRoots.includes(current)){
              if(current === 'screen-thk-intro'){
                resetThicknessFlow();
              }
              if(current === 'screen-obd-intro'){
                await closeObdSession();
                resetDiagnosticsFlow();
              }
              idx = screens.indexOf('screen-services');
              show('screen-services');
            } else if(current.startsWith('screen-thk')){
              resetThicknessFlow();
              idx = screens.indexOf('screen-thk-intro');
              show('screen-thk-intro');
            } else if(current.startsWith('screen-obd')){
              await closeObdSession();
              resetDiagnosticsFlow();
              idx = screens.indexOf('screen-obd-intro');
              show('screen-obd-intro');
            } else {
              idx = Math.max(0, idx-1);
              show(screens[idx]);
            }
          });
        });

        // Dev-only skip
        // DEV skip —É–¥–∞–ª—ë–Ω

        // Prevent text selection, context menu for kiosk-like feel
        document.addEventListener('contextmenu', (e)=>e.preventDefault());
        document.addEventListener('selectstart', (e)=>e.preventDefault());

        // Idle timeout
        let idleTimer; const idleMs = 90_000; // 90s prototype
        const resetIdle = ()=>{
          clearTimeout(idleTimer);
          idleTimer = setTimeout(async ()=>{
            await resetAllSessionState();
            idx = 0;
            show(screens[idx]);
          }, idleMs);
        };
        ['click','keydown','pointerdown','touchstart'].forEach(ev=>document.addEventListener(ev, resetIdle));
        resetIdle();

        // Terms modal controls
  const openTermsLink = document.getElementById('open-terms-link');
        const termsModal = document.getElementById('terms-modal');
        const termsClose = document.getElementById('terms-close');
        const termsOk = document.getElementById('terms-ok');
        const termsContent = document.getElementById('terms-content');
        function showTerms(){ if(termsModal){ termsModal.classList.remove('hidden'); } loadTerms(); }
        function hideTerms(){ if(termsModal){ termsModal.classList.add('hidden'); } }
        async function loadTerms(){
          if(!termsContent) return;
          try{ termsContent.textContent='–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶'; const resp = await fetch('../../docs/legal/terms.md'); const txt = await resp.text(); termsContent.textContent = txt; }
          catch{ termsContent.textContent='–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —É—Å–ª–æ–≤–∏—è.'; }
        }
  openTermsLink?.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); showTerms(); });
        termsClose?.addEventListener('click', hideTerms);
        termsOk?.addEventListener('click', hideTerms);
        termsModal?.addEventListener('click', (e)=>{ if(e.target===termsModal) hideTerms(); });

        async function loadObdPorts(forceReload){
          if(!obdPortSelect) return;
          if(obdPortLoadPending) return;
          if(!forceReload && obdSerialPorts.length){
            setObdPortStatus(`–ù–∞–π–¥–µ–Ω–æ –ø–æ—Ä—Ç–æ–≤: ${obdSerialPorts.length}.`, 'info');
            updateObdPortLastRefresh();
            return;
          }
          setObdPortStatus('–ü–æ–∏—Å–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ—Ä—Ç–æ–≤‚Ä¶', 'info');
          obdPortLoadPending = true;
          if(obdRefreshBtn){
            obdRefreshBtn.disabled = true;
            obdRefreshBtn.textContent = '–û–±–Ω–æ–≤–ª—è–µ–º‚Ä¶';
          }
          try{
            const resp = await fetch(api('/api/serialports'));
            const data = await resp.json();
            const list = Array.isArray(data) ? data : Array.isArray(data?.ports) ? data.ports : [];
            obdSerialPorts = list;
            const prev = obdSelectedPort;
            obdPortSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Ä—Ç‚Ä¶</option>';
            list.forEach((p)=>{
              const opt = document.createElement('option');
              opt.value = p.path;
              const labelParts = [p.path];
              if(p.friendlyName) labelParts.push(p.friendlyName);
              else if(p.manufacturer) labelParts.push(p.manufacturer);
              opt.textContent = labelParts.join(' ‚Äî ');
              if(prev && prev === p.path) opt.selected = true;
              obdPortSelect.appendChild(opt);
            });
            if(list.length){
              setObdPortStatus(`–ù–∞–π–¥–µ–Ω–æ –ø–æ—Ä—Ç–æ–≤: ${list.length}.`, 'info');
              updateObdPortLastRefresh();
              if(prev && list.some(p=>p.path===prev)){
                obdSelectedPort = prev;
                if(obdC4) obdC4.disabled = false;
              } else if(list.length === 1){
                obdSelectedPort = list[0].path;
                obdPortSelect.value = obdSelectedPort;
                if(obdC4) obdC4.disabled = false;
                setObdPortStatus(`–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω –ø–æ—Ä—Ç ${obdSelectedPort}.`, 'info');
              } else {
                obdSelectedPort = '';
                if(obdC4) obdC4.disabled = true;
              }
            } else {
              obdSelectedPort = '';
              if(obdC4) obdC4.disabled = true;
              setObdPortStatus('–ü–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã—Ö –∞–¥–∞–ø—Ç–µ—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å–ø–∏—Å–æ–∫.', 'warn');
            }
            pollObd();
          }catch(e){
            console.warn('loadObdPorts error', e);
            obdSerialPorts = [];
            obdSelectedPort = '';
            if(obdC4) obdC4.disabled = true;
            setObdPortStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ—Ä—Ç–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∞–≥–µ–Ω—Ç –∑–∞–ø—É—â–µ–Ω.', 'error');
            updateObdPortLastRefresh(true);
          } finally {
            obdPortLoadPending = false;
            if(obdRefreshBtn){
              obdRefreshBtn.disabled = false;
              obdRefreshBtn.textContent = obdRefreshLabelBase;
            }
          }
        }

        function setObdPortStatus(message, tone){
          if(!obdPortStatus) return;
          obdPortStatus.textContent = message;
          if(tone==='warn'){
            obdPortStatus.style.color = '#B45309';
          } else if(tone==='error'){
            obdPortStatus.style.color = '#991B1B';
          } else {
            obdPortStatus.style.color = '';
          }
        }

        function updateObdPortLastRefresh(isError){
          if(!obdLastPortRefresh) return;
          if(isError){
            obdLastPortRefresh.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å';
            obdLastPortRefresh.style.color = '#991B1B';
            return;
          }
          const ts = formatRelativeTimestamp(new Date());
          obdLastPortRefresh.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ ${ts}`;
          obdLastPortRefresh.style.color = '#1F2937';
        }

        function escapeHtml(value){
          if(value === undefined || value === null) return '';
          return String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
        }

        function formatSelfCheckTimestamp(isoString){
          if(!isoString) return null;
          const dt = new Date(isoString);
          if(Number.isNaN(dt.getTime())) return null;
          const relative = formatRelativeTimestamp(dt);
          const timePart = dt.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
          const datePart = dt.toLocaleDateString('ru-RU');
          return `${timePart} ‚Ä¢ ${datePart} (${relative})`;
        }

        function formatRelativeTimestamp(date){
          const now = Date.now();
          const diffMs = now - date.getTime();
          const minute = 60_000;
          const hour = 3_600_000;
          const day = 86_400_000;
          let relative = '–¥–∞–≤–Ω–æ';
          const abs = Math.abs(diffMs);
          if(abs < minute){
            relative = '–º–µ–Ω–µ–µ –º–∏–Ω—É—Ç—ã –Ω–∞–∑–∞–¥';
          } else if(abs < hour){
            const mins = Math.round(abs / minute);
            relative = `${mins} –º–∏–Ω –Ω–∞–∑–∞–¥`;
          } else if(abs < day){
            const hours = Math.round(abs / hour);
            relative = `${hours} —á –Ω–∞–∑–∞–¥`;
          } else {
            const days = Math.round(abs / day);
            relative = `${days} –¥–Ω –Ω–∞–∑–∞–¥`;
          }
          return relative;
        }

        function formatCurrency(amount){
          if(typeof amount !== 'number' || !Number.isFinite(amount)) return '‚Äî';
          return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 }).format(amount);
        }

        async function startObdScan(){
          if(!obdSelectedPort){
            setObdPortStatus('–í—ã–±–µ—Ä–∏—Ç–µ COM-–ø–æ—Ä—Ç –ø–µ—Ä–µ–¥ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º.', 'warn');
            return;
          }
          if(!obdStart) return;
          const originalLabel = obdStart.textContent;
          obdStart.dataset.locked = '1';
          obdStart.disabled = true;
          obdStart.textContent = '–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ‚Ä¶';
          obdPaymentIntent = null;
          obdPaymentBreakdown = null;
          renderObdPaymentInfo('–ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –æ–ø–ª–∞—Ç—É‚Ä¶');
          if(obdStatus){
            obdStatus.className = 'badge badge-warn';
            obdStatus.textContent = '–ü–æ–¥–∫–ª—é—á–∞–µ–º –∞–¥–∞–ø—Ç–µ—Ä‚Ä¶';
          }
          try{
            const openResp = await fetch(api('/api/obd/open'), {
              method:'POST',
              headers:{'content-type':'application/json'},
              body: JSON.stringify({ transport: 'serial', portPath: obdSelectedPort, portHints: [obdSelectedPort] })
            });
            const openJson = await openResp.json();
            if(!openResp.ok || openJson?.ok === false){
              throw new Error(openJson?.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç');
            }
            obdSessionOpen = true;
            if(openJson?.snapshot){
              obdLastSnapshot = openJson.snapshot;
              renderObdConnectionMeta(openJson.snapshot, obdSessionState);
            }
            const sessionState = await fetchObdSession();
            if(sessionState){
              obdSessionState = sessionState;
              renderObdConnectionMeta(obdLastSnapshot, obdSessionState);
            }
            obdSelfCheckError = '';
            renderObdSelfCheckBoxes();
            const readResp = await fetch(api('/api/obd/read-dtc'), { method:'POST' });
            const readJson = await readResp.json();
            if(!readResp.ok || readJson?.ok === false){
              throw new Error(readJson?.error || '–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫–æ–¥–æ–≤ DTC');
            }
            obdScanResults = Array.isArray(readJson.data) ? readJson.data : [];
            await refreshObdStatus();
            if(obdStatus){
              obdStatus.className = 'badge badge-ok';
              obdStatus.textContent = `OBD‚Äë–∞–¥–∞–ø—Ç–µ—Ä: –ø–æ–¥–∫–ª—é—á—ë–Ω (${obdScanResults.length ? '–Ω–∞–π–¥–µ–Ω—ã –∫–æ–¥—ã' : '–æ—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'})`;
            }
            await prepareObdPaymentIntent();
            idx = screens.indexOf('screen-obd-paywall');
            show('screen-obd-paywall');
            renderObdSelfCheckBoxes();
            loadLatestObdSelfCheck();
          } catch(e){
            console.warn('OBD scan failed', e);
            await closeObdSession();
            if(obdStatus){
              obdStatus.className = 'badge badge-danger';
              obdStatus.textContent = `–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${e?.message || e}`;
            }
            setObdPortStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–¥–∞–ø—Ç–µ—Ä –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.', 'error');
            renderObdPaymentInfo('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.');
            obdStatusSummary = null;
            renderObdStatusSummary();
            obdLiveData = null;
            renderObdLiveData();
          } finally {
            obdStart.dataset.locked = '';
            obdStart.textContent = originalLabel;
            if(obdSessionOpen){
              obdStart.disabled = false;
            }
          }
        }

        function updateObdPaywallDetails(){
          const config = getObdModeConfig();
          if(obdPaywallAmount){
            obdPaywallAmount.textContent = `–ö –æ–ø–ª–∞—Ç–µ: ${formatCurrency(config.price)}`;
          }
        }

        async function prepareObdPaymentIntent(){
          const config = getObdModeConfig();
          updateObdPaywallDetails();
          try{
            const created = await paymentsCreateIntent(config.price, { service: 'obd', mode: config.id, sessionId: sessionState.session.obdId });
            const intent = created.intent || created?.data?.intent || null;
            const breakdown = created.breakdown || created?.data?.breakdown || null;
            if(!intent || !intent.id){
              renderObdPaymentInfo('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç—ë–∂. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.');
              return;
            }
            obdPaymentIntent = intent;
            obdPaymentBreakdown = breakdown;
            // Render QR / info
            const qrBox = document.querySelector('#screen-obd-paywall .qr-placeholder');
            if(qrBox){ qrBox.textContent = intent.qrText || `–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∏ –æ–ø–ª–∞—Ç–∏—Ç–µ (ID: ${intent.id})`; }
            renderObdPaymentInfo();
            // DEV confirm button attach
            attachObdDevConfirmButton();
            // Poll status
            startPaymentPolling(intent.id, (st)=>{
              renderObdPaymentInfo();
              if(st?.status === 'succeeded'){
                show('screen-obd-results');
              }
            });
          } catch(e){
            console.warn('prepareObdPaymentIntent error', e);
            renderObdPaymentInfo('–û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –æ–ø–ª–∞—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
          }
        }

        function attachObdDevConfirmButton(){
          const actionsBox = document.querySelector('#screen-obd-paywall .actions');
          if(!actionsBox) return;
          let btn = document.getElementById('obd-dev-confirm');
          if(!btn){
            btn = document.createElement('button');
            btn.id = 'obd-dev-confirm';
            btn.className = 'ghost';
            btn.type = 'button';
            btn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É (DEV)';
            actionsBox.appendChild(btn);
          }
          btn.style.display = isDev ? '' : 'none';
          btn.onclick = async ()=>{
            if(!obdPaymentIntent?.id) return;
            try{ await paymentsConfirmDev(obdPaymentIntent.id); }catch(e){ console.warn('confirm-dev failed', e); }
          };
        }

        function setupThicknessPaymentUI(){
          const screen = document.getElementById('screen-thk-payment');
          if(!screen) return;
          // Ensure dynamic elements exist
          let statusEl = screen.querySelector('#thk-payment-status');
          if(!statusEl){
            statusEl = document.createElement('div');
            statusEl.id = 'thk-payment-status';
            statusEl.className = 'payment-status';
            screen.querySelector('.center')?.insertBefore(statusEl, screen.querySelector('.qr-placeholder'));
          }
          let detailsEl = screen.querySelector('#thk-payment-details');
          if(!detailsEl){
            detailsEl = document.createElement('div');
            detailsEl.id = 'thk-payment-details';
            detailsEl.className = 'payment-info';
            screen.querySelector('.center')?.insertBefore(detailsEl, screen.querySelector('.actions'));
          }
          let startBtn = screen.querySelector('#thk-payment-start');
          if(!startBtn){
            startBtn = document.createElement('button');
            startBtn.id = 'thk-payment-start';
            startBtn.className = 'ghost';
            startBtn.type = 'button';
            startBtn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å QR –∏ –Ω–∞—á–∞—Ç—å –æ–ø–ª–∞—Ç—É';
            const actions = screen.querySelector('.actions');
            actions?.insertBefore(startBtn, actions.firstChild);
          }
          let devBtn = screen.querySelector('#thk-payment-confirm-dev');
          if(!devBtn){
            devBtn = document.createElement('button');
            devBtn.id = 'thk-payment-confirm-dev';
            devBtn.className = 'ghost';
            devBtn.type = 'button';
            devBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É (DEV)';
            screen.querySelector('.actions')?.appendChild(devBtn);
          }
          devBtn.style.display = isDev ? '' : 'none';
          const qrBox = screen.querySelector('.qr-placeholder');
          let currentIntentId = null;
          let stopPoll = null;
          function renderDetails(){
            detailsEl.textContent = thkPrice ? `–ö –æ–ø–ª–∞—Ç–µ: ${formatCurrency(thkPrice)}` : '';
          }
          renderDetails();
          function renderStatus(text){ statusEl.textContent = text || ''; }
          startBtn.onclick = async ()=>{
            try{
              renderStatus('–ì–æ—Ç–æ–≤–∏–º –ø–ª–∞—Ç—ë–∂‚Ä¶');
              const created = await paymentsCreateIntent(thkPrice || 350, { service: 'thickness', type: thkType || 'sedan', sessionId: sessionState.session.thicknessId });
              const intent = created.intent || created?.data?.intent || null;
              if(!intent || !intent.id){ renderStatus('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç—ë–∂.'); return; }
              currentIntentId = intent.id;
              if(qrBox){ qrBox.textContent = intent.qrText || `–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR (ID: ${intent.id})`; }
              renderStatus('–û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã‚Ä¶');
              if(stopPoll) stopPoll();
              stopPoll = startPaymentPolling(currentIntentId, async (st)=>{
                if(st?.status === 'succeeded'){
                  renderStatus('–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º‚Ä¶');
                  // –ø–µ—Ä–µ—Ö–æ–¥ –∫ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                  idx = screens.indexOf('screen-thk-prep');
                  show('screen-thk-prep');
                } else if(st?.status){
                  renderStatus(`–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã: ${st.status}`);
                }
              });
            }catch(e){ renderStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –æ–ø–ª–∞—Ç—ã.'); }
          };
          devBtn.onclick = async ()=>{
            if(!currentIntentId) return;
            try{ await paymentsConfirmDev(currentIntentId); }catch(e){ console.warn('thk confirm-dev failed', e); }
          };
        }

        function renderObdPaymentInfo(message){
          if(!obdPaymentInfo) return;
          if(message){
            obdPaymentInfo.innerHTML = `<div class="obd-note">${message}</div>`;
            return;
          }
          if(!obdPaymentIntent){
            obdPaymentInfo.innerHTML = '<div class="obd-note">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–ø–ª–∞—Ç—ã‚Ä¶</div>';
            return;
          }
          const config = getObdModeConfig();
          const gross = obdPaymentBreakdown?.gross ?? config.price;
          const net = obdPaymentBreakdown?.net ?? gross;
          const partner = obdPaymentBreakdown?.partner;
          const partnerPercent = partner ? Math.round(partner.sharePercent * 1000) / 10 : null;
          const parts = [
            `<li>–ö–æ–¥–æ–≤ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–µ–π: ${obdScanResults.length ? obdScanResults.length : '–Ω–µ—Ç'}</li>`,
            `<li>–ö —Å–ø–∏—Å–∞–Ω–∏—é: ${formatCurrency(gross)}</li>`
          ];
          if(partner){
            parts.push(`<li>–î–æ–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ (${partnerPercent ?? 0}%): ${formatCurrency(partner.shareAmount)}</li>`);
          }
          parts.push(`<li>–ù–µ—Ç—Ç–æ –ø–æ—Å–ª–µ –≤—ã–ø–ª–∞—Ç—ã –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º: ${formatCurrency(net)}</li>`);
          obdPaymentInfo.innerHTML = `<strong>–ò—Ç–æ–≥ –ø–µ—Ä–µ–¥ –æ–ø–ª–∞—Ç–æ–π</strong><ul>${parts.join('')}</ul>`;
        }

        function renderObdSelfCheckBoxes(){
          renderObdSelfCheckTarget(obdSelfCheckBox, obdSelfCheckBoxBaseClass, 'paywall');
          renderObdSelfCheckTarget(obdSelfCheckResultsBox, obdSelfCheckResultsBoxBaseClass, 'results');
          if(obdSelfCheckRerun){
            const canRun = obdSessionOpen && !obdSelfCheckRunning;
            obdSelfCheckRerun.disabled = !canRun;
            obdSelfCheckRerun.textContent = obdSelfCheckRunning ? '–í—ã–ø–æ–ª–Ω—è–µ–º —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫—É‚Ä¶' : '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫—É';
          }
        }

        function renderObdSelfCheckTarget(target, baseClass, context){
          if(!target) return;
          const classes = baseClass ? baseClass.split(/\s+/).filter(Boolean) : [];
          if(obdSelfCheckRunning){
            classes.push('self-check-box--loading');
          } else if(obdSelfCheckReport){
            classes.push(obdSelfCheckOk ? 'self-check-box--ok' : (obdSelfCheckReport.passes === 0 ? 'self-check-box--error' : 'self-check-box--warn'));
          } else if(obdSelfCheckError){
            classes.push('self-check-box--error');
          }
          target.className = classes.join(' ');

          if(obdSelfCheckRunning){
            target.innerHTML = '<strong>–°–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è‚Ä¶</strong><div class="meta">–≠—Ç–æ –∑–∞–π–º—ë—Ç –¥–æ 10 —Å–µ–∫—É–Ω–¥.</div>';
            return;
          }

          if(obdSelfCheckError){
            let html = `<strong>–°–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞</strong><div>${escapeHtml(obdSelfCheckError)}</div>`;
            if(obdSessionOpen){
              html += '<div class="meta">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É.</div>';
            }
            target.innerHTML = html;
            return;
          }

          if(!obdSelfCheckReport){
            let html = '<strong>–°–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–∞–ø—Ç–µ—Ä–∞</strong><div class="meta">–í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è –≤ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∞–¥–∞–ø—Ç–µ—Ä–∞.</div>';
            if(context === 'paywall'){
              html += '<div>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫—É –ø–µ—Ä–µ–¥ –æ–ø–ª–∞—Ç–æ–π.</div>';
            }
            target.innerHTML = html;
            return;
          }

          const report = obdSelfCheckReport;
          const items = [];
          if(typeof report.attemptsPerformed === 'number'){
            const baseLine = `–ü–æ–ø—ã—Ç–æ–∫: ${report.attemptsPerformed}, —É—Å–ø–µ—à–Ω—ã—Ö: ${report.passes}`;
            items.push(report.fails ? `${baseLine}, —Å –æ—à–∏–±–∫–∞–º–∏: ${report.fails}` : baseLine);
          }
          items.push(`–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —á—Ç–µ–Ω–∏–π: ${report.consistent ? '–¥–∞' : '–Ω–µ—Ç'}`);
          if(report.metrics?.rpm){
            items.push(`–û–±–æ—Ä–æ—Ç—ã: ${report.metrics.rpm.min}‚Äì${report.metrics.rpm.max} –æ–±/–º–∏–Ω`);
          }
          if(report.metrics?.coolantTempC){
            items.push(`–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –û–ñ: ${report.metrics.coolantTempC.min}‚Äì${report.metrics.coolantTempC.max} ¬∞C`);
          }
          if(report.metrics?.vehicleSpeedKmh){
            items.push(`–°–∫–æ—Ä–æ—Å—Ç—å: ${report.metrics.vehicleSpeedKmh.min}‚Äì${report.metrics.vehicleSpeedKmh.max} –∫–º/—á`);
          }

          let html = '<strong>–°–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–∞–ø—Ç–µ—Ä–∞</strong>';
          if(report.summary){
            html += `<div>${escapeHtml(report.summary)}</div>`;
          }
          if(items.length){
            html += `<ul>${items.map(item=>`<li>${escapeHtml(item)}</li>`).join('')}</ul>`;
          }
          const tsLabel = formatSelfCheckTimestamp(obdSelfCheckTimestamp);
          if(tsLabel){
            html += `<div class="meta">–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—É—Å–∫: ${escapeHtml(tsLabel)}</div>`;
          }

          if(context === 'results' && Array.isArray(report.steps)){
            const failing = report.steps.filter(step => Array.isArray(step.errors) && step.errors.length);
            if(failing.length){
              const entries = failing.slice(0, 3).map(step => {
                const primary = step.errors[0] || '–û—à–∏–±–∫–∞ –±–µ–∑ –¥–µ—Ç–∞–ª–µ–π';
                return `<li>–ü–æ–ø—ã—Ç–∫–∞ ${escapeHtml(step.attempt)}: ${escapeHtml(primary)}</li>`;
              }).join('');
              html += `<div>–û—à–∏–±–∫–∏ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–ø—É—Å–∫–æ–≤:</div><ul>${entries}</ul>`;
              if(failing.length > 3){
                html += `<div class="meta">–ü–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ 3 –∏–∑ ${escapeHtml(failing.length)} –æ—à–∏–±–æ–∫.</div>`;
              }
            }
          }

          target.innerHTML = html;
        }

        async function loadLatestObdSelfCheck(){
          try{
            const resp = await fetch(api('/api/obd/self-check/latest'), { cache: 'no-store' });
            if(resp.status === 404){
              obdSelfCheckReport = null;
              obdSelfCheckOk = false;
              obdSelfCheckTimestamp = null;
              if(!obdSelfCheckRunning){
                obdSelfCheckError = '';
              }
            } else {
              const data = await resp.json();
              if(resp.ok && data?.report){
                obdSelfCheckReport = data.report;
                obdSelfCheckOk = !!data.ok;
                obdSelfCheckTimestamp = data.timestamp || null;
                obdSelfCheckError = '';
              } else {
                obdSelfCheckReport = null;
                obdSelfCheckOk = false;
                obdSelfCheckTimestamp = null;
                const message = data?.error ? String(data.error) : '–°–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.';
                obdSelfCheckError = message;
              }
            }
          } catch(e){
            console.warn('loadLatestObdSelfCheck error', e);
            if(obdSessionOpen){
              obdSelfCheckError = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏.';
            }
          }
          renderObdSelfCheckBoxes();
        }

        async function runObdSelfCheck(){
          if(obdSelfCheckRunning) return;
          if(!obdSessionOpen){
            obdSelfCheckError = '–°–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∞–¥–∞–ø—Ç–µ—Ä–∞.';
            renderObdSelfCheckBoxes();
            return;
          }
          obdSelfCheckRunning = true;
          obdSelfCheckError = '';
          renderObdSelfCheckBoxes();

          let shouldRefresh = false;
          try{
            const resp = await fetch(api('/api/obd/self-check'), {
              method:'POST',
              headers:{'content-type':'application/json'},
              body: JSON.stringify({ attempts: 3, delayMs: 400 })
            });
            const data = await resp.json().catch(()=>({}));
            if(resp.ok && data?.report){
              obdSelfCheckReport = data.report;
              obdSelfCheckOk = !!data.ok;
              obdSelfCheckTimestamp = new Date().toISOString();
              obdSelfCheckError = '';
              shouldRefresh = true;
            } else {
              obdSelfCheckReport = null;
              obdSelfCheckOk = false;
              obdSelfCheckTimestamp = null;
              const message = data?.error ? String(data.error) : '–°–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.';
              obdSelfCheckError = message;
            }
          } catch(e){
            console.warn('runObdSelfCheck error', e);
            obdSelfCheckReport = null;
            obdSelfCheckOk = false;
            obdSelfCheckTimestamp = null;
            obdSelfCheckError = '–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–¥–∞–ø—Ç–µ—Ä.';
          } finally {
            obdSelfCheckRunning = false;
            if(shouldRefresh){
              await loadLatestObdSelfCheck();
            } else {
              renderObdSelfCheckBoxes();
            }
          }
        }

        function severityLabel(severity){
          switch(severity){
            case 'critical': return '–ö—Ä–∏—Ç–∏—á–Ω–æ';
            case 'warning': return '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ';
            default: return '–ò–Ω—Ñ–æ';
          }
        }

        function severityClass(severity){
          if(severity==='critical') return 'obd-severity-critical';
          if(severity==='warning') return 'obd-severity-warning';
          return 'obd-severity-info';
        }
        function appendObdResultsNote(message){
          if(!obdResultsWrapper) return;
          let note = obdResultsWrapper.querySelector('.obd-note');
          if(!note){
            note = document.createElement('div');
            note.className = 'obd-note';
            obdResultsWrapper.appendChild(note);
          }
          note.textContent = message;
        }

        async function clearObdCodes(){
          if(!obdSessionOpen) return;
          if(obdClear) obdClear.disabled = true;
          try{
            const resp = await fetch(api('/api/obd/clear-dtc'), { method:'POST' });
            const data = await resp.json();
            if(resp.ok && data?.ok){
              obdScanResults = [];
              await refreshObdStatus();
              await loadObdLiveData(true);
              renderObdResults();
              appendObdResultsNote('–ö–æ–¥—ã –æ—á–∏—â–µ–Ω—ã. –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ.');
            } else {
              appendObdResultsNote('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å –∫–æ–¥—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–¥–∞–ø—Ç–µ—Ä.');
            }
          } catch(e){
            console.warn('clearObdCodes error', e);
            appendObdResultsNote('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫–æ–¥–æ–≤. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏.');
          } finally {
            if(obdClear) obdClear.disabled = !obdSessionOpen;
          }
        }

        async function closeObdSession(){
          if(!obdSessionOpen) return;
          try{
            await fetch(api('/api/obd/close'), { method:'POST' });
          }catch{}
          obdSessionOpen = false;
          enableObdPolling(false);
          obdPollPending = false;
          if(obdClear) obdClear.disabled = true;
          if(obdLiveRefresh) obdLiveRefresh.disabled = true;
          obdStatusSummary = null;
          renderObdStatusSummary();
          obdLiveData = null;
          renderObdLiveData();
          obdSelfCheckReport = null;
          obdSelfCheckOk = false;
          obdSelfCheckTimestamp = null;
          obdSelfCheckRunning = false;
          obdSelfCheckError = '';
          renderObdSelfCheckBoxes();
          obdLastSnapshot = null;
          obdSessionState = null;
          renderObdConnectionMeta(null, null);
        }

        async function refreshObdStatus(){
          if(!obdSessionOpen) return;
          try{
            const resp = await fetch(api('/api/obd/status'));
            const data = await resp.json();
            if(resp.ok && data?.ok){
              obdStatusSummary = data.data;
            } else {
              obdStatusSummary = null;
            }
          }catch(e){
            console.warn('refreshObdStatus error', e);
            obdStatusSummary = null;
          }
          renderObdStatusSummary();
        }

        async function loadObdLiveData(force){
          if(!obdSessionOpen) return;
          if(!force && obdLiveData){
            renderObdLiveData();
            return;
          }
          if(obdLiveRefresh) obdLiveRefresh.disabled = true;
          try{
            const resp = await fetch(api('/api/obd/live-basic'));
            const data = await resp.json();
            if(resp.ok && data?.ok){
              obdLiveData = data.data;
            } else {
              obdLiveData = null;
            }
          }catch(e){
            console.warn('loadObdLiveData error', e);
            obdLiveData = null;
          } finally {
            renderObdLiveData();
            if(obdLiveRefresh) obdLiveRefresh.disabled = !obdSessionOpen;
          }
        }

        function renderObdLiveData(){
          if(!obdLiveDataEl) return;
          if(!obdSessionOpen){
            obdLiveDataEl.innerHTML = '';
            return;
          }
          if(!obdLiveData){
            obdLiveDataEl.innerHTML = '<div class="muted-note">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.</div>';
            return;
          }
          const rows = [];
          if(isFiniteNumber(obdLiveData.rpm)) rows.push(renderLiveRow('–û–±–æ—Ä–æ—Ç—ã –¥–≤–∏–≥–∞—Ç–µ–ª—è', `${Math.round(obdLiveData.rpm)} –æ–±/–º–∏–Ω`));
          if(isFiniteNumber(obdLiveData.vehicleSpeedKmh)) rows.push(renderLiveRow('–°–∫–æ—Ä–æ—Å—Ç—å', `${Math.round(obdLiveData.vehicleSpeedKmh)} –∫–º/—á`));
          if(isFiniteNumber(obdLiveData.coolantTempC)) rows.push(renderLiveRow('–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –û–ñ', `${Math.round(obdLiveData.coolantTempC)} ¬∞C`));
          if(isFiniteNumber(obdLiveData.intakeTempC)) rows.push(renderLiveRow('–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤–ø—É—Å–∫–∞', `${Math.round(obdLiveData.intakeTempC)} ¬∞C`));
          if(isFiniteNumber(obdLiveData.batteryVoltageV)) rows.push(renderLiveRow('–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ –±–ª–æ–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è', `${obdLiveData.batteryVoltageV.toFixed(2)} –í`));
          if(isFiniteNumber(obdLiveData.throttlePosPercent)) rows.push(renderLiveRow('–ü–æ–ª–æ–∂–µ–Ω–∏–µ –¥—Ä–æ—Å—Å–µ–ª—è', `${obdLiveData.throttlePosPercent.toFixed(1)} %`));
          obdLiveDataEl.innerHTML = rows.length ? rows.join('') : '<div class="muted-note">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –∞–≤—Ç–æ.</div>';
        }

        function renderLiveRow(label, value){
          return `<div class="obd-live-row"><strong>${label}</strong><span>${value}</span></div>`;
        }

        function isFiniteNumber(value){
          return typeof value === 'number' && Number.isFinite(value);
        }

        function renderObdStatusSummary(){
          if(!obdStatusSummaryEl) return;
          if(!obdStatusSummary){
            obdStatusSummaryEl.innerHTML = '';
            return;
          }
          const { milOn, dtcCount, readiness } = obdStatusSummary;
          const entries = Object.entries(readiness || {});
          const readyCount = entries.filter(([, ready])=>ready).length;
          const notReady = entries.filter(([, ready])=>!ready).map(([key])=>monitorLabel(key));
          const total = entries.length;
          const readinessSummary = total ? `${readyCount}/${total}` : '‚Äî';
          const statusDotClass = milOn ? 'alert' : (dtcCount > 0 ? 'warn' : '');
          const statusText = milOn ? 'MIL –≥–æ—Ä–∏—Ç' : (dtcCount > 0 ? 'DTC –∞–∫—Ç–∏–≤–Ω—ã' : 'MIL –ø–æ–≥–∞—à–µ–Ω');
          const listMarkup = notReady.length ? `<ul>${notReady.map(item=>`<li>‚Ä¢ ${item}</li>`).join('')}</ul>` : '<div>–í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –º–æ–Ω–∏—Ç–æ—Ä—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã.</div>';
          obdStatusSummaryEl.innerHTML = `
            <div><span class="dot${statusDotClass ? ' '+statusDotClass : ''}"></span> ${statusText}. –ù–∞–π–¥–µ–Ω–æ –∫–æ–¥–æ–≤: ${dtcCount}.</div>
            <div>–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: ${readinessSummary}</div>
            ${listMarkup}
          `;
        }

        let thirdPartyCredits = null;

        function monitorLabel(key){
          const map = {
            misfire: '–ú–æ–Ω–∏—Ç–æ—Ä –ø—Ä–æ–ø—É—Å–∫–æ–≤ –∑–∞–∂–∏–≥–∞–Ω–∏—è',
            fuelSystem: '–¢–æ–ø–ª–∏–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞',
            components: '–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã',
            catalyst: '–ö–∞—Ç–∞–ª–∏–∑–∞—Ç–æ—Ä',
            heatedCatalyst: '–ü–æ–¥–æ–≥—Ä–µ–≤–∞–µ–º—ã–π –∫–∞—Ç–∞–ª–∏–∑–∞—Ç–æ—Ä',
            evapSystem: '–°–∏—Å—Ç–µ–º–∞ EVAP',
            secondaryAirSystem: '–í—Ç–æ—Ä–∏—á–Ω—ã–π –≤–æ–∑–¥—É—Ö',
            oxygenSensor: '–î–∞—Ç—á–∏–∫–∏ –∫–∏—Å–ª–æ—Ä–æ–¥–∞',
            oxygenSensorHeater: '–ü–æ–¥–æ–≥—Ä–µ–≤ –¥–∞—Ç—á–∏–∫–æ–≤ O2',
            egrSystem: '–†–µ—Ü–∏—Ä–∫—É–ª—è—Ü–∏—è –≤—ã—Ö–ª–æ–ø–∞ (EGR)',
          };
          return map[key] || `–ú–æ–Ω–∏—Ç–æ—Ä ${key}`;
        }

        function renderObdSummaryView(config){
          if(!obdSummaryGrid) return;
          const classes = obdSummaryGridBaseClass ? obdSummaryGridBaseClass.split(/\s+/).filter(Boolean) : [];
          if(!config.showOverview){
            if(!classes.includes('hidden')) classes.push('hidden');
            obdSummaryGrid.className = classes.join(' ');
            obdSummaryGrid.innerHTML = '';
            return;
          }
          const overview = buildObdGeneralOverview();
          if(!overview.length){
            if(!classes.includes('hidden')) classes.push('hidden');
            obdSummaryGrid.className = classes.join(' ');
            obdSummaryGrid.innerHTML = '';
            return;
          }
          const visibleClasses = classes.filter(cls => cls !== 'hidden');
          obdSummaryGrid.className = visibleClasses.join(' ');
          const cards = overview.map(item=>{
            const details = item.details?.length ? `<ul>${item.details.map(line=>`<li>${escapeHtml(line)}</li>`).join('')}</ul>` : '';
            const meta = item.meta ? `<div class="meta">${escapeHtml(item.meta)}</div>` : '';
            return `
              <div class="obd-summary-card">
                <h3>${escapeHtml(item.title)}</h3>
                <div class="obd-summary-status ${item.tone}">${escapeHtml(item.statusText)}</div>
                ${details}
                ${meta}
              </div>
            `;
          }).join('');
          obdSummaryGrid.innerHTML = cards;
        }

        function buildObdGeneralOverview(){
          const status = obdStatusSummary || {};
          const readiness = status.readiness || {};
          const codes = Array.isArray(obdScanResults) ? obdScanResults : [];

          const engineCodes = codes.filter(code => typeof code?.code === 'string' && /^P/.test(code.code));
          const safetyCodes = codes.filter(code => typeof code?.code === 'string' && /^[BC]/.test(code.code));
          const emissionCodes = codes.filter(code => typeof code?.code === 'string' && /^P0(4|5|6|7|8)/.test(code.code));

          const buckets = [
            buildOverviewBucket('–°–∏–ª–æ–≤–æ–π –∞–≥—Ä–µ–≥–∞—Ç', engineCodes, ['misfire','fuelSystem','components'], status.milOn),
            buildOverviewBucket('–°–∏—Å—Ç–µ–º—ã –∫—É–∑–æ–≤–∞ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏', safetyCodes, ['secondaryAirSystem'], false),
            buildOverviewBucket('–≠–∫–æ–ª–æ–≥–∏—è –∏ –≤—ã—Ö–ª–æ–ø', emissionCodes, ['catalyst','heatedCatalyst','evapSystem','oxygenSensor','oxygenSensorHeater','egrSystem'], false),
          ];

          return buckets.filter(Boolean);

          function buildOverviewBucket(title, bucketCodes, monitorKeys, forceWarn){
            const severity = determineBucketSeverity(bucketCodes, monitorKeys, forceWarn);
            const tone = severityToTone(severity);
            const statusText = severityToStatusText(severity);
            const details = [];
            if(bucketCodes.length){
              const primary = bucketCodes.slice(0, 2).map(code => {
                const label = code.description ? `${code.code}: ${code.description}` : code.code;
                return label;
              }).join('; ');
              details.push(primary);
              if(bucketCodes.length > 2){
                details.push(`–ï—â—ë ${bucketCodes.length - 2} –∫–æ–¥(–∞) –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.`);
              }
            } else if(!monitorKeys || monitorKeys.every(key => readiness[key] !== false)){
              details.push('–ü—Ä–æ–±–ª–µ–º –Ω–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ.');
            }

            const pending = (monitorKeys || []).filter(key => readiness[key] === false);
            let meta = '';
            if(pending.length){
              meta = `–ù–µ –∑–∞–≤–µ—Ä—à–µ–Ω—ã –º–æ–Ω–∏—Ç–æ—Ä—ã: ${pending.map(monitorLabel).join(', ')}`;
            }

            return {
              title,
              tone,
              statusText,
              details,
              meta,
            };
          }

          function determineBucketSeverity(bucketCodes, monitorKeys, forceWarn){
            let level = 0;
            if(forceWarn && bucketCodes.length === 0){
              level = Math.max(level, 1);
            }
            bucketCodes.forEach(code => {
              level = Math.max(level, severityWeightFromCode(code));
            });
            const pending = (monitorKeys || []).some(key => readiness[key] === false);
            if(pending){
              level = Math.max(level, 1);
            }
            return level;
          }

          function severityToTone(level){
            if(level >= 3) return 'alert';
            if(level >= 1) return 'warn';
            return 'ok';
          }

          function severityToStatusText(level){
            if(level >= 3) return '–¢—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ';
            if(level >= 1) return '–ï—Å—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è';
            return '–í—Å—ë —Å—Ç–∞–±–∏–ª—å–Ω–æ';
          }

          function severityWeightFromCode(code){
            const severity = typeof code?.severity === 'string' ? code.severity.toLowerCase() : '';
            if(severity === 'critical') return 3;
            if(severity === 'warning') return 2;
            if(severity === 'info') return 1;
            if(code?.status === 'current') return 2;
            return 1;
          }
        }

        async function loadCredits(){
          if(thirdPartyCredits !== null) return thirdPartyCredits;
          try{
            const resp = await fetch('../../docs/legal/third-party-credits.json');
            if(resp.ok){
              const data = await resp.json();
              if(Array.isArray(data?.items)){
                thirdPartyCredits = data.items;
              } else if(Array.isArray(data)){
                thirdPartyCredits = data;
              } else {
                thirdPartyCredits = [];
              }
            } else {
              thirdPartyCredits = [];
            }
          }catch(e){
            console.warn('loadCredits error', e);
            thirdPartyCredits = [];
          }
          return thirdPartyCredits;
        }

        function renderCredits(hostId, filterFn){
          const host = document.getElementById(hostId);
          if(!host) return;
          const credits = Array.isArray(thirdPartyCredits) ? thirdPartyCredits : [];
          const filtered = typeof filterFn === 'function' ? credits.filter(filterFn) : credits;
          if(!filtered.length){
            host.innerHTML = '';
            return;
          }
          host.innerHTML = '';
          const wrap = document.createElement('div');
          wrap.className = 'credits-grid';
          filtered.forEach(p=>{
            const card = document.createElement('div');
            card.className = 'credits-card';
            const name = document.createElement('div');
            name.className = 'credits-name';
            name.textContent = p.displayName || p.product || '–ü–∞—Ä—Ç–Ω—ë—Ä';
            const roles = document.createElement('div');
            roles.className = 'credits-roles';
            const rolesText = Array.isArray(p.roles) ? p.roles.join(' ‚Ä¢ ') : '';
            roles.textContent = rolesText;
            const devs = document.createElement('ul');
            devs.className = 'credits-devs';
            (p.developers||[]).forEach(d=>{
              const li = document.createElement('li');
              li.textContent = d;
              devs.appendChild(li);
            });
            card.appendChild(name);
            if(rolesText) card.appendChild(roles);
            if(devs.childElementCount) card.appendChild(devs);
            wrap.appendChild(card);
          });
          host.appendChild(wrap);
        }

        renderObdSelfCheckBoxes();

  // –ü–æ–¥–≥—Ä—É–∑–∏–º –∫—Ä–µ–¥–∏—Ç—ã –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ
        loadCredits();
        // –†–µ–Ω–¥–µ—Ä –ø—Ä–∏ –≤—Ö–æ–¥–µ –Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —ç–∫—Ä–∞–Ω—ã
        const observer = new MutationObserver(()=>{
          if(document.getElementById('screen-thk-done')?.classList.contains('active')){
            renderCredits('credits-thk', p=> (p.product||'').toLowerCase().includes('rdevice'));
          }
          if(document.getElementById('screen-obd-done')?.classList.contains('active')){
            renderCredits('credits-obd', p=> (p.product||'').toLowerCase().includes('diagzone'));
          }
          if(document.getElementById('screen-obd-paywall')?.classList.contains('active')){
            loadLatestObdSelfCheck();
          }
          if(document.getElementById('screen-obd-results')?.classList.contains('active')){
            loadLatestObdSelfCheck();
          }
        });
        observer.observe(document.body, { attributes:true, subtree:true, attributeFilter:['class'] });

        // ===== Reports: generate & send (DEV-only endpoints on agent) =====
        function ensureThicknessSessionId(){
          if(!sessionState.session.thicknessId){
            sessionState.session.thicknessId = `T-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,6)}`;
          }
        }
        function ensureObdSessionId(){
          if(!sessionState.session.obdId){
            sessionState.session.obdId = `O-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,6)}`;
          }
        }

        function getContactPayload(kind){
          const info = kind === 'thickness' ? sessionState.contact.thickness : sessionState.contact.diagnostics;
          if(!info) return null;
          if(info.type === 'phone') return { phone: info.normalized };
          if(info.type === 'email') return { email: info.normalized };
          // fallback if type is missing
          const raw = (info.normalized || info.raw || '').toLowerCase();
          return raw.includes('@') ? { email: raw } : { phone: raw };
        }

        function setReportStatus(kind, message, tone){
          const id = kind === 'thickness' ? 'report-status-thk' : 'report-status-obd';
          const el = document.getElementById(id);
          if(!el) return;
          el.textContent = message || '';
          el.style.color = tone === 'error' ? '#B91C1C' : tone === 'ok' ? '#166534' : '';
        }

        async function maybeSendReport(kind){
          // –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞: —Å–Ω–∞—á–∞–ª–∞ –≤—Å–µ–≥–¥–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á—ë—Ç (–µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä; –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ –≤—ã–±–æ—Ä—É
          const already = kind === 'thickness' ? sessionState.reportSent.thickness : sessionState.reportSent.diagnostics;
          if(already) return;
          const contact = getContactPayload(kind);
          if(!contact){
            setReportStatus(kind, '–ö–æ–Ω—Ç–∞–∫—Ç –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî –æ—Ç—á—ë—Ç –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –ª–æ–∫–∞–ª—å–Ω–æ.', 'error');
            return;
          }
          try{
            setReportStatus(kind, '–ì–æ—Ç–æ–≤–∏–º –æ—Ç—á—ë—Ç‚Ä¶');
            const payload = buildReportPayload(kind, contact);
            if(!payload){
              setReportStatus(kind, '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á—ë—Ç–∞.', 'error');
              return;
            }
            const resp = await fetch(api('/reports/generate'), {
              method:'POST',
              headers:{'content-type':'application/json'},
              body: JSON.stringify({ data: payload })
            });
            const data = await resp.json().catch(()=>({}));
            if(resp.ok && data?.ok){
              if(kind === 'thickness') sessionState.reportSent.thickness = true;
              if(kind === 'diagnostics') sessionState.reportSent.diagnostics = true;
              setReportStatus(kind, `–û—Ç—á—ë—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω (ID: ${data.id}).`, 'ok');
              // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
              openReportPreview({ id: data.id, email: payload.contact?.email, phone: payload.contact?.phone });
            } else {
              const message = data?.message || data?.error || '–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á—ë—Ç–∞.';
              setReportStatus(kind, String(message), 'error');
            }
          } catch(e){
            setReportStatus(kind, '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å –∞–≥–µ–Ω—Ç–æ–º –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞.', 'error');
          }
        }

        // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á—ë—Ç–∞: –º–æ–¥–∞–ª–∫–∞ + –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
        const reportPreviewModal = document.getElementById('report-preview-modal');
        const reportPreviewFrame = document.getElementById('report-preview-frame');
        const reportPreviewClose = document.getElementById('report-preview-close');
        const reportSendSmsBtn = document.getElementById('report-send-sms');
        const reportSendEmailBtn = document.getElementById('report-send-email');
        const reportSkipSendBtn = document.getElementById('report-skip-send');
        let lastPreview = null;

        function openReportPreview(info){
          lastPreview = info || null;
          if(!lastPreview) return;
          const url = api(`/reports/view/${encodeURIComponent(info.id)}`);
          if(reportPreviewFrame) reportPreviewFrame.src = url;
          reportPreviewModal?.classList.remove('hidden');
        }
        function closeReportPreview(){
          reportPreviewModal?.classList.add('hidden');
          if(reportPreviewFrame) reportPreviewFrame.src = 'about:blank';
        }
        reportPreviewClose?.addEventListener('click', closeReportPreview);
        reportSkipSendBtn?.addEventListener('click', ()=>{
          closeReportPreview();
        });
        reportSendSmsBtn?.addEventListener('click', async ()=>{
          if(!lastPreview) return;
          if(!lastPreview.phone){
            alert('–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω. –£–∫–∞–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–∞ —à–∞–≥–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤.');
            return;
          }
          try{
            const kind = activeScreenId.startsWith('screen-thk') ? 'thickness' : 'diagnostics';
            const payload = buildReportPayload(kind, { phone: lastPreview.phone, email: lastPreview.email });
            const resp = await fetch(api('/reports/send-sms'), {
              method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ data: payload, phone: lastPreview.phone })
            });
            const data = await resp.json().catch(()=>({}));
            if(resp.ok && data?.ok){
              setReportStatus(kind, `–°—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–æ SMS. (ID: ${data.id})`, 'ok');
              closeReportPreview();
            } else {
              const message = data?.message || data?.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ SMS.';
              alert(String(message));
            }
          }catch(e){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å –∞–≥–µ–Ω—Ç–æ–º.'); }
        });
        reportSendEmailBtn?.addEventListener('click', async ()=>{
          if(!lastPreview) return;
          if(!lastPreview.email){
            alert('Email –Ω–µ —É–∫–∞–∑–∞–Ω. –£–∫–∞–∂–∏—Ç–µ email –Ω–∞ —à–∞–≥–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤.');
            return;
          }
          try{
            const kind = activeScreenId.startsWith('screen-thk') ? 'thickness' : 'diagnostics';
            const payload = buildReportPayload(kind, { phone: lastPreview.phone, email: lastPreview.email });
            const resp = await fetch(api('/reports/send'), {
              method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ data: payload })
            });
            const data = await resp.json().catch(()=>({}));
            if(resp.ok && data?.ok){
              setReportStatus(kind, `–û—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ ${lastPreview.email}. (ID: ${data.id})`, 'ok');
              closeReportPreview();
            } else {
              const message = data?.message || data?.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email.';
              alert(String(message));
            }
          }catch(e){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å –∞–≥–µ–Ω—Ç–æ–º.'); }
        });

        // –ö–Ω–æ–ø–∫–∏ ¬´–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä¬ª –Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö —ç–∫—Ä–∞–Ω–∞—Ö
        document.getElementById('thk-preview')?.addEventListener('click', ()=>{
          const idText = document.getElementById('report-status-thk')?.textContent || '';
          const match = idText.match(/ID:\s*([\w.-]+)/);
          if(match){
            const contact = getContactPayload('thickness') || {};
            openReportPreview({ id: match[1], ...contact });
          } else {
            alert('–û—Ç—á—ë—Ç –µ—â—ë –Ω–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω.');
          }
        });
        document.getElementById('obd-preview')?.addEventListener('click', ()=>{
          const idText = document.getElementById('report-status-obd')?.textContent || '';
          const match = idText.match(/ID:\s*([\w.-]+)/);
          if(match){
            const contact = getContactPayload('diagnostics') || {};
            openReportPreview({ id: match[1], ...contact });
          } else {
            alert('–û—Ç—á—ë—Ç –µ—â—ë –Ω–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω.');
          }
        });

        function buildReportPayload(kind, contact){
          if(kind === 'thickness'){
            ensureThicknessSessionId();
            const sessionId = sessionState.session.thicknessId || `T-${Date.now()}`;
            // –°–æ–±–∏—Ä–∞–µ–º –∫—Ä–∞—Ç–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ —Å–µ—Å—Å–∏–∏ –¥–ª—è –æ—Ç—á—ë—Ç–∞ (–±–µ–∑ —Ñ–µ–π–∫–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π)
            const s = thkLastSession;
            const points = Array.isArray(s?.points)
              ? s.points.map(pt=>({ id: pt.id, label: pt.label, status: pt.status, valueMicrons: pt.valueMicrons }))
              : [];
            const summary = thkType ? `–ò–∑–º–µ—Ä–µ–Ω–∏—è –¥–ª—è —Ç–∏–ø–∞: ${thkType}. –í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${s?.measuredCount ?? 0}. –ü—Ä–æ–ø—É—â–µ–Ω–æ: ${s?.skippedCount ?? 0}. –û—Å—Ç–∞–ª–æ—Å—å: ${s?.pendingCount ?? 0}.` : '';
            return { sessionId, contact, points, summary };
          } else {
            ensureObdSessionId();
            const sessionId = sessionState.session.obdId || `O-${Date.now()}`;
            const dtc = Array.isArray(obdScanResults) ? obdScanResults.map(r=>({ code: String(r.code||'').toUpperCase(), description: r.description || '' })) : [];
            const mil = !!(obdStatusSummary && obdStatusSummary.milOn);
            return { sessionId, contact, dtc, mil };
          }
        }
      })();
    </script>
  </body>
  <script>
    // PWA: register service worker in supported browsers
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(() => {});
      });
    }
  </script>
</html>
