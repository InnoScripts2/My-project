# Анализ часть 6 отчеты и доставка

КОНТЕКСТ
Цель: стандартизировать PDF/HTML отчеты, предпросмотр и отправку. Вход: packages/report, docs/tech.

МИНИМАЛЬНЫЕ ПОЛЯ
Толщинометрия: дата, время, тип авто, список измерений по зонам, средние значения, отклонения, интерпретация. Диагностика: дата, время, марка авто, список DTC с описаниями, статусы систем, результат сброса (если выполнялся), рекомендации. Без лишних полей: город, СТО, имя мастера.

HTML ШАБЛОНЫ
Handlebars или подобный. Шаблоны: report-thickness.html, report-diagnostics.html. Стили: inline CSS для email совместимости, таблицы, цветовые коды статусов (зелёный/жёлтый/красный). Адаптивность для просмотра на мобильных.

PDF ГЕНЕРАЦИЯ
Puppeteer: рендер HTML в PDF, поддержка стилей, embed изображений. Альтернатива: pdfkit или jsPDF. Формат A4, ориентация portrait. Header: логотип, дата. Footer: контакты, QR для повторного доступа (опционально).

ЛОКАЛЬНЫЙ ПРЕДПРОСМОТР
UI: кнопка предпросмотр открывает в iframe или новом окне. Backend: endpoint /api/reports/:sessionId/preview возвращает HTML. Без сохранения персональных данных на долгий срок.

EMAIL/SMS ДОСТАВКА
Адаптеры: EmailService (SMTP/SendGrid), SMSService (Twilio/аналог). Методы: sendEmail(to, subject, body, attachments), sendSMS(to, body). Retry: 3 попытки с задержкой. Логирование успеха/неудачи. Валидация адресов email/phone. Без спама: rate limiting.

КРАТКОСРОЧНОЕ ХРАНЕНИЕ
Отчеты хранятся локально 24 часа, затем удаляются. Персональные данные: только контакты клиента, минимум. Шифрование в покое (опционально). Очистка по cron.

МЕТРИКИ
report_generated_total{type, status}, report_delivered_total{channel, status}, report_generation_duration_seconds. Алерты на высокий процент ошибок доставки.

ТЕСТЫ
Юнит: рендер шаблонов, генерация PDF, валидация данных. Интеграция: mock SMTP/SMS, проверка форматов. E2E: сессия → генерация → доставка.

РИСКИ
PII утечка: минимизация полей, сроки хранения. Ошибки доставки: retry и алерты. Спам: валидация и rate limiting. Качество PDF: тесты рендера.

КРИТЕРИИ ГОТОВНОСТИ
Шаблоны HTML созданы, генерация PDF настроена, адаптеры email/SMS описаны, политика хранения утверждена, метрики добавлены, тесты определены.
