/**
 * Анализатор DTC кодов с генерацией инсайтов
 *
 * Принимает код неисправности и возвращает:
 * - Развёрнутое описание на русском
 * - Возможные причины
 * - Рекомендации по ремонту
 * - Примерная стоимость ремонта (диапазон)
 * - Критичность (для сортировки в отчёте)
 */
const DTC_DATABASE = {
    P0300: {
        title: 'Случайные/множественные пропуски воспламенения',
        description: 'Обнаружены пропуски воспламенения в нескольких цилиндрах или случайные пропуски.',
        causes: ['Некачественное топливо', 'Изношенные свечи зажигания', 'Проблемы с катушками зажигания', 'Засорённые форсунки'],
        recommendations: ['Проверить качество топлива', 'Заменить свечи зажигания', 'Диагностика системы зажигания'],
        severity: 'CRITICAL',
        cost: { min: 3000, max: 15000 },
    },
    P0301: {
        title: 'Пропуски воспламенения, цилиндр 1',
        description: 'Детектированы пропуски воспламенения в первом цилиндре.',
        causes: ['Неисправная свеча зажигания', 'Проблема с катушкой зажигания', 'Низкая компрессия', 'Проблема с форсункой'],
        recommendations: ['Заменить свечу зажигания цилиндра 1', 'Проверить катушку зажигания', 'Измерить компрессию'],
        severity: 'HIGH',
        cost: { min: 2000, max: 8000 },
    },
    P0302: {
        title: 'Пропуски воспламенения, цилиндр 2',
        description: 'Детектированы пропуски воспламенения во втором цилиндре.',
        causes: ['Неисправная свеча зажигания', 'Проблема с катушкой зажигания', 'Низкая компрессия', 'Проблема с форсункой'],
        recommendations: ['Заменить свечу зажигания цилиндра 2', 'Проверить катушку зажигания', 'Измерить компрессию'],
        severity: 'HIGH',
        cost: { min: 2000, max: 8000 },
    },
    P0303: {
        title: 'Пропуски воспламенения, цилиндр 3',
        description: 'Детектированы пропуски воспламенения в третьем цилиндре.',
        causes: ['Неисправная свеча зажигания', 'Проблема с катушкой зажигания', 'Низкая компрессия', 'Проблема с форсункой'],
        recommendations: ['Заменить свечу зажигания цилиндра 3', 'Проверить катушку зажигания', 'Измерить компрессию'],
        severity: 'HIGH',
        cost: { min: 2000, max: 8000 },
    },
    P0304: {
        title: 'Пропуски воспламенения, цилиндр 4',
        description: 'Детектированы пропуски воспламенения в четвёртом цилиндре.',
        causes: ['Неисправная свеча зажигания', 'Проблема с катушкой зажигания', 'Низкая компрессия', 'Проблема с форсункой'],
        recommendations: ['Заменить свечу зажигания цилиндра 4', 'Проверить катушку зажигания', 'Измерить компрессию'],
        severity: 'HIGH',
        cost: { min: 2000, max: 8000 },
    },
    P0305: {
        title: 'Пропуски воспламенения, цилиндр 5',
        description: 'Детектированы пропуски воспламенения в пятом цилиндре.',
        causes: ['Неисправная свеча зажигания', 'Проблема с катушкой зажигания', 'Низкая компрессия', 'Проблема с форсункой'],
        recommendations: ['Заменить свечу зажигания цилиндра 5', 'Проверить катушку зажигания', 'Измерить компрессию'],
        severity: 'HIGH',
        cost: { min: 2000, max: 8000 },
    },
    P0306: {
        title: 'Пропуски воспламенения, цилиндр 6',
        description: 'Детектированы пропуски воспламенения в шестом цилиндре.',
        causes: ['Неисправная свеча зажигания', 'Проблема с катушкой зажигания', 'Низкая компрессия', 'Проблема с форсункой'],
        recommendations: ['Заменить свечу зажигания цилиндра 6', 'Проверить катушку зажигания', 'Измерить компрессию'],
        severity: 'HIGH',
        cost: { min: 2000, max: 8000 },
    },
    P0420: {
        title: 'Эффективность катализатора ниже порога (Банк 1)',
        description: 'Каталитический нейтрализатор работает ниже порога эффективности.',
        causes: ['Изношенный катализатор', 'Неисправные датчики кислорода', 'Утечка выхлопных газов', 'Проблемы с топливной системой'],
        recommendations: ['Проверить датчики кислорода', 'Проверить герметичность выхлопной системы', 'Возможна замена катализатора'],
        severity: 'MEDIUM',
        cost: { min: 15000, max: 50000 },
    },
    P0171: {
        title: 'Слишком бедная топливная смесь (Банк 1)',
        description: 'Система управления двигателем определила слишком бедную топливную смесь.',
        causes: ['Подсос воздуха во впускном тракте', 'Слабое давление топлива', 'Неисправный датчик MAF', 'Загрязненные форсунки'],
        recommendations: ['Проверить герметичность впускного тракта', 'Проверить давление топлива', 'Очистить датчик MAF'],
        severity: 'MEDIUM',
        cost: { min: 2000, max: 10000 },
    },
    P0172: {
        title: 'Слишком богатая топливная смесь (Банк 1)',
        description: 'Система управления двигателем определила слишком богатую топливную смесь.',
        causes: ['Загрязненный воздушный фильтр', 'Неисправный датчик MAF', 'Проблемы с регулятором давления топлива', 'Негерметичные форсунки'],
        recommendations: ['Заменить воздушный фильтр', 'Проверить датчик MAF', 'Проверить давление топлива'],
        severity: 'MEDIUM',
        cost: { min: 2000, max: 12000 },
    },
    P0128: {
        title: 'Температура охлаждающей жидкости ниже температуры термостата',
        description: 'Двигатель не достигает рабочей температуры в установленное время.',
        causes: ['Неисправный термостат', 'Низкий уровень охлаждающей жидкости', 'Неисправный датчик температуры'],
        recommendations: ['Заменить термостат', 'Проверить уровень охлаждающей жидкости', 'Проверить датчик температуры'],
        severity: 'LOW',
        cost: { min: 1500, max: 5000 },
    },
    P0133: {
        title: 'Медленный отклик датчика кислорода (Банк 1, Датчик 1)',
        description: 'Датчик кислорода реагирует медленнее, чем ожидается.',
        causes: ['Старение датчика кислорода', 'Загрязнение датчика', 'Проблемы с проводкой'],
        recommendations: ['Заменить датчик кислорода', 'Проверить проводку датчика'],
        severity: 'MEDIUM',
        cost: { min: 3000, max: 8000 },
    },
    P0401: {
        title: 'Недостаточный поток рециркуляции выхлопных газов (EGR)',
        description: 'Система EGR не обеспечивает достаточный поток рециркуляции.',
        causes: ['Засоренный клапан EGR', 'Засоренные каналы EGR', 'Неисправный вакуумный модулятор'],
        recommendations: ['Очистить клапан EGR', 'Проверить каналы EGR', 'Заменить клапан EGR при необходимости'],
        severity: 'MEDIUM',
        cost: { min: 3000, max: 12000 },
    },
    U0100: {
        title: 'Потеря связи с ECM/PCM',
        description: 'Отсутствует связь с блоком управления двигателем.',
        causes: ['Проблемы с проводкой CAN шины', 'Неисправный блок управления', 'Проблемы с питанием'],
        recommendations: ['Проверить проводку CAN шины', 'Проверить питание блока управления', 'Диагностика у специалиста'],
        severity: 'CRITICAL',
        cost: { min: 5000, max: 50000 },
    },
    C1201: {
        title: 'Неисправность системы ABS',
        description: 'Обнаружена общая неисправность антиблокировочной системы тормозов.',
        causes: ['Неисправный датчик скорости колеса', 'Проблемы с проводкой', 'Неисправный модуль ABS'],
        recommendations: ['Проверить датчики скорости колес', 'Проверить проводку ABS', 'Диагностика модуля ABS'],
        severity: 'HIGH',
        cost: { min: 5000, max: 25000 },
    },
    P0100: {
        title: 'Неисправность датчика массового расхода воздуха (MAF)',
        description: 'Проблема с цепью датчика массового расхода воздуха.',
        causes: ['Неисправный датчик MAF', 'Проблемы с проводкой', 'Загрязнение датчика'],
        recommendations: ['Очистить датчик MAF', 'Проверить проводку', 'Заменить датчик при необходимости'],
        severity: 'MEDIUM',
        cost: { min: 3000, max: 12000 },
    },
    P0115: {
        title: 'Неисправность датчика температуры охлаждающей жидкости (ECT)',
        description: 'Проблема с цепью датчика температуры охлаждающей жидкости.',
        causes: ['Неисправный датчик ECT', 'Короткое замыкание в проводке', 'Обрыв проводки'],
        recommendations: ['Проверить датчик ECT', 'Проверить проводку', 'Заменить датчик при необходимости'],
        severity: 'MEDIUM',
        cost: { min: 1500, max: 5000 },
    },
    P0120: {
        title: 'Неисправность датчика положения дроссельной заслонки (TPS)',
        description: 'Проблема с цепью датчика положения дроссельной заслонки.',
        causes: ['Неисправный датчик TPS', 'Проблемы с проводкой', 'Механическая проблема дроссельной заслонки'],
        recommendations: ['Проверить датчик TPS', 'Проверить механику дроссельной заслонки', 'Заменить датчик при необходимости'],
        severity: 'MEDIUM',
        cost: { min: 3000, max: 10000 },
    },
    P0505: {
        title: 'Неисправность системы управления холостым ходом',
        description: 'Система управления холостым ходом работает неправильно.',
        causes: ['Загрязненный клапан холостого хода', 'Подсос воздуха', 'Неисправный клапан'],
        recommendations: ['Очистить клапан холостого хода', 'Проверить герметичность впуска', 'Заменить клапан при необходимости'],
        severity: 'MEDIUM',
        cost: { min: 2000, max: 8000 },
    },
    P0442: {
        title: 'Небольшая утечка в системе контроля испарения топлива (EVAP)',
        description: 'Обнаружена небольшая утечка в системе улавливания паров топлива.',
        causes: ['Незатянутая крышка топливного бака', 'Поврежденные шланги EVAP', 'Неисправный клапан продувки'],
        recommendations: ['Проверить крышку топливного бака', 'Проверить шланги системы EVAP', 'Проверить клапан продувки адсорбера'],
        severity: 'LOW',
        cost: { min: 500, max: 5000 },
    },
};
export function getDtcInsight(dtcCode) {
    const normalizedCode = dtcCode.toUpperCase().trim();
    const definition = DTC_DATABASE[normalizedCode];
    if (definition) {
        return {
            code: normalizedCode,
            title: definition.title,
            description: definition.description,
            possibleCauses: definition.causes,
            recommendations: definition.recommendations,
            severity: definition.severity,
            estimatedCost: definition.cost ? { ...definition.cost, currency: 'RUB' } : undefined,
        };
    }
    const prefix = normalizedCode[0];
    const fallback = generateFallbackInsight(normalizedCode, prefix);
    return fallback;
}
function generateFallbackInsight(code, prefix) {
    const prefixMap = {
        P: { category: 'Силовой агрегат (двигатель/трансмиссия)', severity: 'MEDIUM' },
        B: { category: 'Кузов (электрика, системы комфорта)', severity: 'LOW' },
        C: { category: 'Шасси (тормоза, подвеска, рулевое)', severity: 'HIGH' },
        U: { category: 'Сеть (CAN, коммуникации)', severity: 'CRITICAL' },
    };
    const info = prefixMap[prefix] || { category: 'Неизвестная категория', severity: 'MEDIUM' };
    return {
        code,
        title: `Неисправность ${info.category}`,
        description: `Код ошибки ${code} относится к категории ${info.category}. Для получения точной информации обратитесь к документации производителя.`,
        possibleCauses: ['Требуется дополнительная диагностика', 'Обратитесь к руководству по ремонту'],
        recommendations: ['Обратиться в специализированный сервис', 'Провести комплексную диагностику'],
        severity: info.severity,
    };
}
