<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Подключение OBD-II адаптера</title>
  <link rel="stylesheet" href="../../styles/obd/diagnostics.css">
  <link rel="stylesheet" href="../../styles/obd/gauges.css">
</head>
<body>
  <div class="diagnostics-container">
    <header class="diagnostics-header">
      <h1>Подключение OBD-II адаптера</h1>
      <p>Вставьте адаптер в разъём автомобиля</p>
    </header>

    <div class="connection-illustration">
      <div class="obd-port-image">
        <svg width="200" height="200" viewBox="0 0 200 200">
          <rect x="50" y="80" width="100" height="60" rx="8" fill="#2a2a2a" stroke="#00aaff" stroke-width="2"/>
          <rect x="60" y="90" width="20" height="10" fill="#00aaff"/>
          <rect x="85" y="90" width="20" height="10" fill="#00aaff"/>
          <rect x="110" y="90" width="20" height="10" fill="#00aaff"/>
          <rect x="60" y="105" width="20" height="10" fill="#00aaff"/>
          <rect x="85" y="105" width="20" height="10" fill="#00aaff"/>
          <rect x="110" y="105" width="20" height="10" fill="#00aaff"/>
        </svg>
      </div>
      <div class="connection-hint">
        Разъём OBD-II обычно находится под рулевой колонкой
      </div>
    </div>

    <div id="connection-status-container" class="status-container"></div>

    <div class="connection-instructions">
      <h3>Как подключить адаптер</h3>
      <ol class="instruction-list">
        <li>Найдите разъём OBD-II в автомобиле (обычно под рулём)</li>
        <li>Вставьте адаптер в разъём до щелчка</li>
        <li>Подождите, пока адаптер установит соединение</li>
        <li>После успешного подключения вы автоматически перейдёте к сканированию</li>
      </ol>
    </div>

    <div id="connection-error" class="error-message" style="display: none;"></div>

    <div class="actions">
      <button id="retry-button" class="btn btn-secondary" style="display: none;">Повторить</button>
      <button id="skip-button" class="btn btn-dev" style="display: none;">Пропустить (DEV)</button>
    </div>
  </div>

  <script type="module">
    import { getObdStatus, connectObd } from '../../api/obd-client.js';
    import { ConnectionStatus } from '../../components/obd/connection-status.js';

    const connectionStatusContainer = document.getElementById('connection-status-container');
    const connectionError = document.getElementById('connection-error');
    const retryButton = document.getElementById('retry-button');
    const skipButton = document.getElementById('skip-button');

    const connectionStatus = new ConnectionStatus(connectionStatusContainer);

    const urlParams = new URLSearchParams(window.location.search);
    const isDev = urlParams.get('dev') === '1';
    const vehicleMake = sessionStorage.getItem('vehicleMake') || 'Toyota';
    const vehicleModel = sessionStorage.getItem('vehicleModel') || '';
    const mode = sessionStorage.getItem('diagnosticMode') || 'general';

    if (isDev) {
      skipButton.style.display = 'block';
    }

    let pollTimer = null;
    let timeoutTimer = null;

    async function attemptConnection() {
      connectionError.style.display = 'none';
      retryButton.style.display = 'none';

      try {
        await connectObd(vehicleMake, vehicleModel, mode);
        startStatusPolling();
        startConnectionTimeout();
      } catch (error) {
        showError(`Не удалось подключиться к адаптеру: ${error.message}`);
      }
    }

    function startStatusPolling() {
      if (pollTimer) {
        clearInterval(pollTimer);
      }

      pollTimer = setInterval(async () => {
        try {
          const status = await getObdStatus();
          connectionStatus.update(status);

          if (status.connected) {
            clearInterval(pollTimer);
            clearTimeout(timeoutTimer);
            setTimeout(() => {
              window.location.href = './scanning.html';
            }, 1000);
          }
        } catch (error) {
          console.error('Status poll error:', error);
        }
      }, 2000);
    }

    function startConnectionTimeout() {
      if (timeoutTimer) {
        clearTimeout(timeoutTimer);
      }

      timeoutTimer = setTimeout(() => {
        clearInterval(pollTimer);
        showError('Не удалось подключиться к адаптеру в течение 30 секунд. Проверьте подключение.');
      }, 30000);
    }

    function showError(message) {
      connectionError.textContent = message;
      connectionError.style.display = 'block';
      retryButton.style.display = 'block';
    }

    retryButton.addEventListener('click', () => {
      attemptConnection();
    });

    skipButton.addEventListener('click', () => {
      window.location.href = './scanning.html?dev=1';
    });

    attemptConnection();
  </script>
</body>
</html>
