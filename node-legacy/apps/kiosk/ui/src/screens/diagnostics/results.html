<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Результаты диагностики</title>
  <link rel="stylesheet" href="../../styles/obd/diagnostics.css">
</head>
<body>
  <div class="diagnostics-container">
    <header class="diagnostics-header">
      <h1>Результаты диагностики</h1>
    </header>

    <div id="overall-status" class="overall-status"></div>

    <section class="results-section">
      <h2>Ключевые параметры</h2>
      <div id="snapshot-table" class="snapshot-table"></div>
    </section>

    <section class="results-section">
      <h2>Коды ошибок</h2>
      <div id="dtc-list-container"></div>
    </section>

    <section id="hybrid-section" class="results-section" style="display: none;">
      <h2>Гибридная система</h2>
      <div id="hybrid-panel-container"></div>
    </section>

    <div id="results-error" class="error-message" style="display: none;"></div>

    <div class="actions">
      <button id="clear-dtc-button" class="btn btn-warning" style="display: none;">Очистить ошибки</button>
      <button id="paywall-button" class="btn btn-primary">Оплатить и получить отчёт</button>
    </div>
  </div>

  <div id="clear-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <h3>Подтверждение очистки ошибок</h3>
      <p>Вы уверены, что хотите очистить все коды ошибок?</p>
      <p class="modal-warning">Это действие нельзя отменить. После очистки коды будут удалены из памяти ECU.</p>
      <div class="modal-actions">
        <button id="cancel-clear" class="btn btn-secondary">Отмена</button>
        <button id="confirm-clear" class="btn btn-warning">Очистить</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { getDtcCodes, clearDtcCodes, getLivePids } from '../../api/obd-client.js';
    import { DtcList } from '../../components/obd/dtc-list.js';
    import { HybridPanel } from '../../components/obd/hybrid-panel.js';

    const overallStatus = document.getElementById('overall-status');
    const snapshotTable = document.getElementById('snapshot-table');
    const dtcListContainer = document.getElementById('dtc-list-container');
    const hybridPanelContainer = document.getElementById('hybrid-panel-container');
    const hybridSection = document.getElementById('hybrid-section');
    const resultsError = document.getElementById('results-error');
    const clearDtcButton = document.getElementById('clear-dtc-button');
    const paywallButton = document.getElementById('paywall-button');
    const clearModal = document.getElementById('clear-modal');
    const cancelClear = document.getElementById('cancel-clear');
    const confirmClear = document.getElementById('confirm-clear');

    const dtcList = new DtcList(dtcListContainer);
    const hybridPanel = new HybridPanel(hybridPanelContainer);

    const vehicleMake = sessionStorage.getItem('vehicleMake') || '';

    if (vehicleMake === 'Toyota' || vehicleMake === 'Lexus') {
      hybridSection.style.display = 'block';
    }

    let currentDtcCodes = [];

    async function loadResults() {
      try {
        const [dtcData, pidsData] = await Promise.all([
          getDtcCodes(),
          getLivePids(),
        ]);

        currentDtcCodes = dtcData.codes || [];

        displayOverallStatus(currentDtcCodes);
        displaySnapshot(pidsData.pids || []);
        dtcList.render(currentDtcCodes);

        if (currentDtcCodes.length > 0) {
          clearDtcButton.style.display = 'block';
        }
      } catch (error) {
        console.error('Failed to load results:', error);
        resultsError.textContent = `Не удалось загрузить результаты: ${error.message}`;
        resultsError.style.display = 'block';
      }
    }

    function displayOverallStatus(dtcCodes) {
      const hasErrors = dtcCodes.length > 0;

      overallStatus.innerHTML = `
        <div class="status-icon ${hasErrors ? 'status-error' : 'status-ok'}">
          ${hasErrors ? '❌' : '✓'}
        </div>
        <div class="status-text">
          ${hasErrors ? 'Обнаружены проблемы' : 'Всё в норме'}
        </div>
        <div class="status-details">
          ${hasErrors ? `Найдено ошибок: ${dtcCodes.length}` : 'Все системы автомобиля работают в штатном режиме'}
        </div>
      `;
    }

    function displaySnapshot(pids) {
      const table = document.createElement('table');
      table.className = 'params-table';

      pids.forEach((pid) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="param-name">${pid.name}</td>
          <td class="param-value">${pid.value} ${pid.unit}</td>
        `;
        table.appendChild(row);
      });

      snapshotTable.innerHTML = '';
      snapshotTable.appendChild(table);
    }

    clearDtcButton.addEventListener('click', () => {
      clearModal.style.display = 'flex';
    });

    cancelClear.addEventListener('click', () => {
      clearModal.style.display = 'none';
    });

    confirmClear.addEventListener('click', async () => {
      clearModal.style.display = 'none';

      try {
        await clearDtcCodes(true);
        
        currentDtcCodes = [];
        dtcList.render(currentDtcCodes);
        displayOverallStatus(currentDtcCodes);
        clearDtcButton.style.display = 'none';

        const successMessage = document.createElement('div');
        successMessage.className = 'success-message';
        successMessage.textContent = 'Коды ошибок успешно очищены';
        overallStatus.appendChild(successMessage);

        setTimeout(() => {
          successMessage.remove();
        }, 5000);
      } catch (error) {
        console.error('Failed to clear DTC codes:', error);
        resultsError.textContent = `Не удалось очистить коды ошибок: ${error.message}`;
        resultsError.style.display = 'block';
      }
    });

    paywallButton.addEventListener('click', () => {
      window.location.href = '../../../index.html#paywall';
    });

    loadResults();
  </script>

  <style>
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: #2a2a2a;
      padding: 40px;
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
    }

    .modal-content h3 {
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 28px;
      color: #ffffff;
    }

    .modal-content p {
      margin-bottom: 15px;
      font-size: 18px;
      color: #b0b0b0;
    }

    .modal-warning {
      color: #ffaa00;
      font-weight: 600;
    }

    .modal-actions {
      display: flex;
      gap: 16px;
      margin-top: 30px;
    }

    .modal-actions .btn {
      flex: 1;
    }

    .success-message {
      margin-top: 20px;
      padding: 16px;
      background: #00cc66;
      color: #ffffff;
      border-radius: 8px;
      font-size: 18px;
      text-align: center;
    }
  </style>
</body>
</html>
