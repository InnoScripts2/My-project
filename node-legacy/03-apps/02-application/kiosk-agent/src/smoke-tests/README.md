# Smoke Tests — Цикл 4/09

Смок-тесты для проверки базовой функциональности устройств и интеграций после переноса кода.

## Обзор

Smoke tests (дымовые тесты) — это быстрые проверки, которые убеждаются, что основные функции системы работают. Они не заменяют полные интеграционные тесты, но позволяют быстро выявить критические проблемы.

## Структура тестов

### OBD Smoke Test (`obd-smoke.ts`)

Проверяет базовую функциональность OBD-II интеграции:

- Автодетект адаптера (ELM327) удалён после миграции на BLE. Используйте BLE-подключение KINGBOLEN.
- **Self-check** - проверка консистентности данных от адаптера
- **Чтение DTC** - получение кодов неисправностей
- **Ручное подключение** - подключение к явно указанному порту (через `OBD_PORT`)

**Особенности:**
- В DEV без подключенного устройства не считается ошибкой
- Поддерживает переменные окружения: `OBD_PORT`, `OBD_BAUD`
- Автоматически пропускает Bluetooth-устройства в среде без BT

### Thickness Smoke Test (`thickness-smoke.ts`)

Проверяет базовую функциональность толщиномера:

- **Snapshot** - получение текущего состояния устройства
- **Points Template** - проверка шаблонов точек измерения
- **Open Connection** - подключение к устройству (mock в DEV)
- **Session Management** - создание и остановка сессии измерений
- **DEV Mark Point** - пометка точек как пропущенных (только DEV)

**Особенности:**
- В DEV использует mock-подключение
- Проверяет, что есть минимум 24 точки для каждого типа авто
- DEV-функционал недоступен в PROD

### Payments Smoke Test (`payments-smoke.ts`)

Проверяет базовую функциональность платежной интеграции (только DEV):

- **Create Intent** - создание платежного интента
- **Get Status** - получение статуса платежа
- **Get Intent** - получение полной информации об интенте
- **Confirm DEV-only** - подтверждение платежа в DEV
- **Status Polling** - симуляция polling статуса

**Особенности:**
- **ТОЛЬКО DEV** - скрипт отказывается работать в PROD
- Использует `DevPaymentProvider` из пакета `@selfservice/payments`
- Проверяет, что история платежей корректно сохраняется

### Run All (`run-all.ts`)

Главный раннер, запускающий все smoke tests последовательно:

- Запускает OBD, Thickness и Payments тесты
- Пропускает Payments в PROD
- Останавливается на первой критической ошибке в PROD
- Выводит финальную сводку всех тестов

## Запуск тестов

### Отдельные тесты

```bash
# OBD smoke test
npm run smoke:obd

# Thickness smoke test
npm run smoke:thickness

# Payments smoke test (только DEV)
npm run smoke:payments

# Все тесты
npm run smoke:all
```

### С переменными окружения

```bash
# OBD с явным портом
OBD_PORT=/dev/ttyUSB0 OBD_BAUD=38400 npm run smoke:obd

# Установка окружения
AGENT_ENV=QA npm run smoke:all
```

## Коды возврата

- `0` - все тесты прошли успешно
- `1` - критическая ошибка в PROD (требуется немедленное внимание)
- `2` - некоторые тесты провалились (в DEV - приемлемо)
- `3` - фатальная ошибка (например, исключение в коде теста)

## Результаты

Каждый тест выводит:
- Временные метки
- Статус каждого шага (✓ PASS / ✗ FAIL)
- Детали ошибок
- Общую сводку с количеством пройденных/проваленных тестов
- Общее время выполнения

Пример вывода:

```
[2025-10-04T07:49:33.891Z] [INFO] === Payments Smoke Test Suite - Cycle 4/09 ===
[2025-10-04T07:49:33.891Z] [INFO] Environment: DEV
[2025-10-04T07:49:33.891Z] [INFO]
[2025-10-04T07:49:33.891Z] [INFO] Starting test: Payment Create Intent
[2025-10-04T07:49:33.891Z] [INFO] Payment Create Intent: SUCCESS
[2025-10-04T07:49:33.891Z] [INFO]   Intent ID: dev_1759564173891
[2025-10-04T07:49:33.891Z] [INFO]   Amount: 480 RUB
[2025-10-04T07:49:33.891Z] [INFO]   Status: pending
...
[2025-10-04T07:49:34.096Z] [INFO] === Test Summary ===
[2025-10-04T07:49:34.096Z] [INFO] ✓ PASS: Payment Create Intent
[2025-10-04T07:49:34.096Z] [INFO] ✓ PASS: Payment Get Status
[2025-10-04T07:49:34.096Z] [INFO] ✓ PASS: Payment Get Intent
[2025-10-04T07:49:34.096Z] [INFO] ✓ PASS: Payment Confirm (DEV-only)
[2025-10-04T07:49:34.096Z] [INFO] ✓ PASS: Payment Status Polling (202ms)
[2025-10-04T07:49:34.096Z] [INFO]
[2025-10-04T07:49:34.096Z] [INFO] Total: 5 passed, 0 failed
[2025-10-04T07:49:34.096Z] [INFO] Total duration: 202ms
```

## Принципы

### Без симуляции данных в PROD

В продакшн-режиме тесты НЕ генерируют фиктивные данные устройств:
- OBD: если адаптер не найден - тест помечает это как нормальное состояние
- Толщиномер: в PROD требуется реальное устройство
- Платежи: в PROD smoke tests не запускаются вообще

### DEV-only функционал

Некоторые тесты доступны только в DEV:
- `payments-smoke.ts` - полностью отказывается работать в PROD
- `thickness-smoke.ts` - `markPoint()` доступен только в DEV
- Кнопка «Пропустить» недоступна в PROD

### Быстрое выполнение

Smoke tests должны выполняться быстро (< 1 минуты для всех):
- OBD: автодетект с таймаутами, но без длительного ожидания
- Thickness: mock-подключение в DEV
- Payments: in-memory провайдер без реальных HTTP-запросов

## Интеграция в CI/CD

Рекомендуется запускать smoke tests:
- После сборки проекта
- Перед деплоем в QA/PROD
- После обновления зависимостей
- При обнаружении проблем в продакшне

Пример для GitHub Actions:

```yaml
- name: Run Smoke Tests
  run: |
    cd 03-apps/02-application/kiosk-agent
    npm run smoke:all
  env:
    AGENT_ENV: QA
```

## Известные ограничения

1. **Permissions** - OBD автодетект требует доступа к `/dev/ttyX` портам. В CI без доступа все тесты будут пропущены (это нормально).

2. **Bluetooth** - OBD Bluetooth-автодетект отключен в smoke tests для ускорения выполнения.

3. **Real Hardware** - тесты не заменяют проверку на реальном оборудовании. Они проверяют только корректность кода и интерфейсов.

## Расширение

При добавлении новых устройств/интеграций:

1. Создайте новый файл `{name}-smoke.ts`
2. Следуйте структуре существующих тестов
3. Добавьте npm script в `package.json`
4. Добавьте тест в `run-all.ts`
5. Обновите эту документацию

## См. также

- [INTEGRATION_VERIFICATION.md](../../../../../09-docs/01-interfaces/docs-root/internal/INTEGRATION_VERIFICATION.md) - полный чек-лист интеграции
- [OBD Self-check](../devices/obd/runSelfCheck.ts) - детальная самопроверка OBD
- [Unit Tests](../) - юнит-тесты всех модулей
