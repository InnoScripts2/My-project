# Stage 3 — перенос Windows-приложения в Android стек

## Цель
- Разобрать рабочие сценарии Windows-приложения `блок 4` и подготовить техническое задание для переписывания на связку Kotlin + C++ (JNI) + Python.
- Зафиксировать, какие элементы безопасности, сетевые проверки и утилиты переносим, упрощаем или удаляем.
- Определить набор артефактов (формы, CSV, алгоритмы), требующих конверсии и автоматизировать извлечение данных.

## Ключевые результаты
- Матрица функций Windows-версии → целевые Android/агент компоненты.
- Решения по антиотладке, проверкам срока действия и PowerShell-утилитам из `Program.cs`.
- План миграции UI-форм `lib/Protocol/*.cs` и сервисов `lib/Interface/*.cs` в Kotlin.
- Оценка трудозатрат и последовательность задач для реализации JNI-слоя PassThru.

## Фокусные зоны анализа
1. **Точка входа (`Program.cs`)**
   - Антиотладка `Boeing747`: решить, нужна ли новая защита или оставляем мониторинг только в операторском режиме.
   - Проверка целостности WinAPI: проверить необходимость аналогичных механизмов на Android (SafetyNet, Play Integrity).
   - Источник времени (`testerpresent.com.au`): определить стратегию синхронизации времени (NTP/локальный агент) и условия отказа.
   - Неиспользуемые утилиты (`ExecutePowerShellCommand`, генераторы): либо удалить, либо заменить внутри оператора.

2. **PassThru-интерфейсы (`lib/Interface/*.cs`)**
   - Снять последовательность вызовов `PassThruOpen/Connect/Ioctl/WriteMsgs/ReadMsgs`.
   - Зафиксировать используемые перечисления, структуры, параметры таймингов.
   - Определить, какие части переходят в C++ библиотеку (`libs/cpp`), а какие остаются в Kotlin.

3. **Диагностические сценарии (`lib/Protocol/*.cs`)**
   - Категоризировать формы UDS/OBD по функциям: чтение DTC, очистка ошибок, мониторинг PID, сервисные функции.
   - Составить карту экранов → Android фрагментов на базе `docs/tech/winforms-to-kotlin-mapping.md`.
   - Оценить объём бизнес-логики в UI и необходимые сервисы Kotlin.

4. **Ресурсы и данные**
   - Подтвердить статус DTC- и VIN-справочников, проверить соответствие текущей миграции (`prepare_resources.py`).
   - Зафиксировать дополнительные файлы (тексты подсказок, медиа) для обработки в отдельных скриптах.

5. **Безопасность и лицензирование**
   - Проверить лицензии DarkUI, сторонних библиотек, J2534 DLL.
   - Подготовить список уведомлений, которые нужно сохранять в Android-приложении и агенте.

## План задач
1. **Документирование антиотладочных механизмов**
   - [x] Сконсолидировать описание `Boeing747`, проверок WinAPI и логики истечения срока в `docs/windows-app-analysis.md` (выполнено).
   - [x] Подготовить решение: перенести, адаптировать или удалить (аргументировать в отдельном разделе Stage 3) — см. `docs/tech/anti-debug-migration-options.md`.

2. **Инвентаризация PassThru API**
   - [x] Проанализировать `lib/Interface/J2534.cs`, `J2534_Struct.cs`, `connectSelectedJ2534Device.cs`.
   - [x] Сформировать таблицу параметров и создать черновик `jni/pass-thru-api.md`.

3. **Карточки сценариев диагностики**
   - [x] Для каждой формы из `lib/Protocol/` подготовить краткое резюме (функция, входы, выходы, зависимости) — см. `docs/tech/protocol-service-cards.md`.
   - [x] Обновить `docs/tech/winforms-to-kotlin-mapping.md` привязкой к конкретным сервисам Kotlin (новые сервисы каталога PID, DID и heartbeat).

4. **Конвертация ресурсов**
   - [x] Проверить полноту выгрузки `prepare_resources.py` и зафиксировать отсутствующие каталоги (см. `docs/tech/resource-conversion-audit.md`).
   - [x] Описать процедуру для операторов по обновлению `.obdresource` пакетов (см. `docs/internal/resource-update-procedure.md`).

5. **Артефакты безопасности и лицензии**
   - [x] Собрать список уведомлений из `Program.cs` и `lib/Interface/*` (см. `docs/tech/security-licensing-audit.md`).
   - [x] Подготовить раздел «юридические обязательства» для Android-приложения (см. `docs/tech/security-licensing-audit.md`).

## Методы работы
- Использовать `docs/windows-app-analysis.md` как основной источник и пополнять его по мере изучения файлов.
- Для каждой группы файлов создавать отдельные заметки в `docs/internal/` с трассировкой.
- Сложную бизнес-логику фиксировать в виде диаграмм последовательностей (`docs/tech/sequences/`).

## Критерии завершения Stage 3
- Все сценарии Windows-приложения задокументированы и промаркированы для переноса или удаления.
- JNI API PassThru согласован с требованиями Kotlin команды.
- Подготовлены входные данные для Stage 4 (описание C++ инфраструктуры).
- Юридические ограничения и обязательства учтены в будущих версиях приложений.
