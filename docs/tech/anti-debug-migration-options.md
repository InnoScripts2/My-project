# Антиотладка и механизмы защиты при переносе на Android

## Существующие механизмы Windows-версии (`Program.cs`)
- **Процесс `Boeing747`**: циклический опрос `Process.GetProcesses()` с завершением известных инструментов (`dnSpy`, `ILSpy`, `MegaDumper`, `ExtremeDumper`). При обнаружении — аварийный выход приложения.
- **Проверка патчинга WinAPI**: чтение первых байт `IsDebuggerPresent`, `CheckRemoteDebuggerPresent`, `Debugger.get_IsAttached`. Наличие JMP/patch приводит к завершению.
- **Временной предохранитель**: жёстко заданная дата истечения, сравнение с HTTP-заголовком `Date` домена `testerpresent.com.au`; при просрочке приложение закрывается.
- **Обфускационные классы**: вспомогательные «шумы» (генераторы, фракталы), повышающие сложность реверса, но не влияющие на защиту.

## Требования киоска самообслуживания
- Приложение запускается на закреплённом устройстве (Android/Electron), физический доступ ограничен.
- Киоск должен функционировать офлайн; жесткая дата истечения недопустима.
- Защита не должна мешать обслуживающему персоналу и не должна останавливать сеансы клиентов.
- Устройства управляются локальным агентом; важна синхронизация версии ПО и пакетов данных, а не агрессивная антиотладка.

## Оценка применимости на Android
- **Процесс-киллеры**: нет доступа к списку процессов аналогично Windows; kill чужих приложений запрещён. Механизм непереносим и нарушает политики Android.
- **Проверка байтов API**: в ART/Java/JNI отсутствии прямого доступа к адресам системных функций; эквивалент невозможен без рут-доступа.
- **Жёсткая дата**: создаёт риск блокировки киоска при потере синхронизации времени/интернета.
- **Обфускация**: перенос бессмысленный; предпочитаем структурную безопасность (подписанные пакеты, контроль целостности).

## Предлагаемое решение
1. **Контроль целостности приложения**
   - Используем встроенный механизм подписи APK (Google Play / собственный подпись). Агент проверяет SHA-256 бинаря UI/агента при старте и сверяет с эталоном.
   - Для `.obdresource` пакетов уже внедрена проверка подписи (Ed25519).

2. **Play Integrity / SafetyNet**
   - В киоске с доступом к Google Play включить `Play Integrity API` (проверка CTS, настраиваемый verdict).
   - Для офлайн-устройств использовать локальные проверки: контроль `ro.build.tags`, `adb`-статуса, запрет отладки через `adb shell setprop persist.sys.usb.config none` (конфигурируется на уровне прошивки).

3. **Tamper detection на уровне агента**
   - Агент проверяет, включён ли `developer options`/`adb`. Если активированы, переводит киоск в режим обслуживания и журналирует событие.
   - При критических отклонениях блокирует операции диагностики, но не завершает сеанс клиента, выводит сервисное сообщение оператору.

4. **Временные ограничения**
   - Отказываемся от жёсткой даты. Вместо этого вводим конфигурируемый «max build age» (например, 180 дней) с предупреждением оператора. Агент фиксирует устаревание в мониторинге, но не блокирует работу до проверки оператором.

5. **Средства аудита**
   - Логи агента содержат сведения о попытках включения отладчика (события `android.os.Debug.isDebuggerConnected()`), о несоответствии подписи, о включённом `adb`.
   - При наличии сети метрики отправляются в мониторинг; офлайн — сохраняем локальный журнал.

## План внедрения
1. **Stage 3 (анализ)**
   - Зафиксировать отказ от прямого переноса `Boeing747` и WinAPI-проверок.
   - Определить источники данных для проверки отладки на Android (`Debug.isDebuggerConnected`, `Debug.waitingForDebugger`).
   - Подготовить требования к прошивке киоска (отключение `adb`, kiosk mode, auto-login, обновления ОС).

2. **Stage 4 (реализация)**
   - Реализовать в агенте модуль `TamperMonitor`:
     - Проверка подписи `.obdresource`, приложений, скриптов.
     - Обработчик статуса отладки (`if (Debug.isDebuggerConnected())` → перевод агента в режим обслуживания).
   - В UI добавить сервисный экран с кодом доступа для выхода из режима обслуживания.

3. **Поддержка эксплуатации**
   - Добавить чек-лист в `docs/internal/kiosk-hardening-checklist.md` (создать) с пунктами: блокировка USB, отключение отладчика, обновления ОС.
   - Внести политику обновления максимального срока сборки в документацию оператора.

## Вывод
- Агрессивные антиотладочные проверки Windows-версии неприменимы в Android-киоске и могут нанести вред UX.
- Безопасность переносится на уровень
  - контроля целостности пакетов и подписей,
  - мониторинга статуса отладки и `adb`,
  - организационных мер (locked-down OS, kiosk mode).
- Требуется реализовать `TamperMonitor` в агенте и регламент технического обслуживания вместо «убийства» процессов и жёсткой даты.
