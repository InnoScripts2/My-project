# Требования к подписанным обновлениям DTC

## Назначение
- Описывает требования безопасности для внешних пакетов DTC (`*.obdresource`) и инфраструктуры подписи.
- Применяется ко всем окружениям (DEV/QA/PROD) с учётом ограничений офлайн-режима киоска.

## Ключевой материал
- Используется пара ключей Ed25519: приватный ключ хранится офлайн (`keys/private_ed25519.pem`), публичный зашивается в агент (`keys/public_ed25519.pem`).
- Приватный ключ размещается на шифрованном носителе; доступ имеют двое сотрудников по процедуре four-eyes.
- Публичный ключ публикуется в репозитории конфигурации агента и входит в билд фронтенда для двусторонней проверки.
- Ключи обновляются не реже одного раза в 12 месяцев или при подозрении на компрометацию; архив пакетов содержит идентификатор ключа (`keyId`).

## Процесс подписи
- Подготовка данных выполняется скриптом `tools/data-migration/prepare_resources.py`, выход — JSON каталоги и атрибуция.
- Release-инженер формирует структуру пакета в `build/dtc-package/<brand>` и запускает `sign_package.py`.
- Скрипт подписывает канонический архив и обновляет `manifest.json`: `checksum`, `records`, `createdAtUtc`, `keyId`.
- Подпись публикуется рядом с архивом (`<package>.obdresource.sig`), оба файла сохраняются в `dist/` и выгружаются в репозиторий обновлений.

## Распределение пакетов
- HTTPS-репозиторий (S3+CloudFront либо Azure Blob + CDN) с обязательной MFA для операций записи.
- Кэш-слой в киоске: локальная директория `/data/updates/dtc`, хранит последнюю установленную и ожидающие пакеты.
- Офлайн-доставка через USB требует присутствия как архива, так и подписи; агент отклоняет одиночные файлы.
- Политика истечения: пакеты старше 24 месяцев помечаются устаревшими и требуют подтверждения от службы поддержки перед установкой.

## Проверки на стороне киоска
- Агент выполняет последовательность: проверка подписи, сравнение SHA-256, сравнение `records`, проверка `appMinVersion`, проверка `keyId`.
- Логи (`logs/update-agent.log`) фиксируют `packageId`, версию, `checksum`, результат проверки, источник (HTTPS или USB).
- При неуспешной проверке пакет перемещается в `quarantine/` с отметкой причины.

## Аудит и ротация
- Ежеквартальный аудит сравнивает список установленных пакетов с репозиторием и журналом подписи.
- Любая операция подписи документируется в `docs/internal/update-playbook.md` с указанием оператора, даты, версии.
- При ротации ключа выпускается CRL (список отозванных `keyId`) и распространяется вместе с обновлением агента.

## Реакция на инциденты
- При компрометации приватного ключа выпуск останавливается, ключ переводится в список отозванных, агенту доставляется обновление с новым публичным ключом и CRL.
- Все пакеты, подписанные скомпрометированным ключом, переупаковываются; операторам направляется уведомление о необходимости повторной установки.

## Нерешённые вопросы
- Интеграция с централизованным HSM рассматривается на Stage 1; требуется оценка стоимости и вариантов подключения.
- Требуется оформить политику хранения журналов (`update-agent.log`, `signing.log`) и их ретенцию (минимум 24 месяца).
