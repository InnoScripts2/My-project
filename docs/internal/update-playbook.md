# Обновление пакетов DTC

## Назначение

- Регламентирует выпуск и доставку внешних каталогов DTC (`.obdresource`).
- Охватывает работу release-инженера и дежурного оператора киоска.

## Подготовка пакета (release-инженер)

- Запустить `python tools/data-migration/prepare_resources.py` для целевого бренда; результат - JSON в `tmp-emulator-test/migration-output/dtc` и атрибуция в `licenses/`.
- Сформировать рабочий каталог `build/dtc-package/<brand>` с подпапками `data/` и `licenses/`, скопировать туда свежие файлы и шаблон `templates/dtc-manifest.json`.
- Заполнить `manifest.json`: `packageId`, `version`, `appMinVersion`, `notes`.
- Выполнить `python tools/data-migration/sign_package.py --input build/dtc-package/<brand> --key keys/private_ed25519.pem --output dist/<package>.obdresource --force`.
- Проверить результат `python tools/data-migration/verify_package.py --input dist/<package>.obdresource --signature dist/<package>.obdresource.sig --key keys/public_ed25519.pem`.
- Опубликовать архив и подпись в утверждённом HTTPS-репозитории, внести запись в журнал релизов.

## Онлайн-обновление (оператор)

- Получить уведомление о новой версии (email + запись в журнале).
- В интерфейсе обслуживания убедиться, что агент скачал пакет автоматически (статус «Ожидает подтверждения»).
- Подтвердить импорт; дождаться окончания и проверить счётчик записей в журнале обновлений.
- Если автоматическая загрузка не стартовала, запустить ручную синхронизацию и повторить проверку.

## Оффлайн-обновление (оператор)

- Скопировать архив `.obdresource` и подпись `.obdresource.sig` на USB в корень накопителя.
- Подключить USB к киоску; дождаться появления диалога «Найден пакет DTC».
- Выбрать файл, подтвердить импорт, дождаться завершения проверки подписи и загрузки в базу.
- Сравнить количество импортированных записей с `manifest.json`; результат зафиксировать в журнале.
- Удалить файлы с USB и поместить их в архив службы поддержки (срок хранения - 12 месяцев).

## Инциденты: отзыв ключей и переупаковка

- Немедленно остановить публикацию новых пакетов: заблокировать pipeline и уведомить release-инженера.
- Разослать оператором шаблон уведомления об инциденте (email + SMS) с инструкцией не устанавливать новые пакеты.
- Выпустить `revoked-keys.json` с идентификаторами ключей и доставить его в репозиторий конфигурации и CDN.
- Сгенерировать новую пару ключей на офлайн-машине, задокументировать процедуру в журнале сейфа.
- Переподписать актуальные пакеты: `python tools/data-migration/sign_package.py --input build/dtc-package/<brand> --key keys/<new_key>.pem --output dist/<package>.obdresource`.
- Обновить подписи в хранилище, зафиксировать хэш и `keyId` в журнале релизов.
- Обновить агенты: доставить новый публичный ключ и CRL через конфигурационный репозиторий.

## Контроль и аудит

- Агент обязан логировать: источник обновления, пакет, версию, checksum, результат валидации.
- Раз в квартал проводить сверку всех установленных пакетов с репозиторием (release-инженер отвечает за отчёт).
- Ключи подписи хранятся на офлайн-носителях; доступ имеют два доверенных сотрудника по процедуре 4-глаз.
- Скрипт `sign_package.py` пишет события в `logs/signing.log`; журнал хранится в защищённом репозитории и проверяется ежемесячно.
- Для экспресс-проверок журнала использовать `python tools/data-migration/check_signing_log.py --log logs/signing.log`.
