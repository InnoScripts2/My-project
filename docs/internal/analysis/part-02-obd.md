# Анализ часть 2 OBD-II драйверы и протокол

КОНТЕКСТ
Цель: детализировать протокол ELM327, список команд, форматы PID/DTC/FreezeFrame, таймауты и восстановление. Вход: существующие файлы агента и вспомогательные проекты: node-bluetooth-obd-master, node-obd2-master, ecu-simulator-master, esp32-obd2-master, uds-c-master.

КОМАНДЫ И ПОСЛЕДОВАТЕЛЬНОСТИ
Инициализация: ATZ, ATE0, ATL0, ATS0, ATH0, ATSP0 (auto), 0100 для списка поддерживаемых PID. Чтение DTC: 03, очистка DTC: 04. Freeze Frame: 02 00. PID: 01 0C (RPM), 01 0D (Speed), 01 05 (Coolant temp). Таймауты команд 2000–5000 мс с backoff и попытками повторов. Очередь запросов с приоритетами и ограничением параллелизма до 1.

ПАРСИНГ
DTC: 2 байта на код, категории P/C/B/U. PID: вычисления по формулам A,B,C,D из таблиц. Freeze Frame: первый кадр по умолчанию 00. Ошибки парсинга маркируются format_error с сырым кадром.

СОБЫТИЯ И СТАТУСЫ
События: connected, disconnected, dtc-read, dtc-cleared, pid-read, error. Статусы: adapter_detected, protocol_selected, scan_in_progress, idle. Порог обновления PID 1–5 Гц.

СБОИ И ВОССТАНОВЛЕНИЕ
Таймаут: retry с экспоненциальной задержкой до N попыток и затем failover. Потеря соединения: auto-reconnect с охлаждением. Неверный формат: сброс последовательности и повторный init. Очистка DTC требует явного подтверждения и логирования.

ТЕСТЫ
Юнит: парсинг PID 0C/0D/05, декодер DTC, обработка 03/04. Интеграция: эмулятор ECU и последовательность init→scan→clear. Нагрузочные: 10 минут опроса PID с ограничением по частоте.

ИНТЕГРАЦИЯ
Интерфейсы DeviceObd, события EventEmitter, HTTP/WS адаптеры. Ограничение PROD: только реальные данные, никаких симуляций. DEV: заглушки отключаемы флагом.

КРИТЕРИИ ГОТОВНОСТИ
Спецификация команд и таймаутов зафиксирована, таблицы формул PID определены, обработка DTC и FF описана, тесты определены. Документация интеграции обновлена.
