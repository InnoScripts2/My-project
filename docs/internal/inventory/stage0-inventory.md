
# Инвентаризация Stage 0 — 2025-10-13

## Сводная таблица артефактов

| Артефакт | Путь | Языки | Назначение | Ключевые зависимости | Состояние готовности |
| --- | --- | --- | --- | --- | --- |
| pyobd2 | блок 1/ | Python (>=3.8) | GUI-клиент для OBD-II, чтение DTC и PID, генерация отчётов | wxPython 4.2.1, pyserial 3.5, numpy 1.23, tornado 3.2.1, pint 0.20.1, pillow 10.4.0 | Архивный проект, сборка через setuptools; требует актуализации зависимостей и аудита лицензии GPL-2.0 |
| BluetoothSPP sample (app) | блок 2/app | Java (Android) | Демонстрационное Android-приложение для работы с Bluetooth SPP-адаптером | Android Gradle Plugin 1.0.0, compileSdk задаётся через gradle.properties, зависимость на локальный модуль `:library` | Устаревший стек (Gradle 1.x, jcenter); код пригоден только как справочник |
| BluetoothSPP library | блок 2/library | Java (Android) | Переиспользуемая библиотека SPP Bluetooth | Android Gradle Plugin 1.0.0, maven_push.gradle | Архивный модуль, требует миграции на современный Gradle |
| ExpressOBD | блок 3/ExpressOBD | C# (.NET Framework 4.5.2) | Лёгкий WinForms-клиент для OBD-II (ELM327) | System.Windows.Forms, стандартные BCL; без внешних пакетов | Компилируется Visual Studio 2015+, рассчитан на настольный запуск |
| Generic Diagnostic Tool | блок 4/ | C# (.NET Framework 4.8.1) | Расширенный WinForms-инструмент с поддержкой J2534, CAN sniffer, диаграммы протоколов, справочники DTC | DarkUIReborn 1.0.0.1, J2534 API, собственные CSV-таблицы кодов | Крупный проект, требует библиотеки J2534 и набора ресурсов, активно использует небезопасный код |
| serialport-rs | блок 5/ | Rust 2021 | Кроссплатформенная библиотека низкоуровневого доступа к последовательному порту | crates: bitflags, nix, libudev (optional), windows-sys, clap, quickcheck, rstest | Актуальная версия 4.8.2-alpha.0; готов к сборке cargo, нужен аудит совместимости лицензии MPL-2.0 |
| Serial Port Sample | блок 6/app | Kotlin, Java | Android-приложение с UI для работы с последовательным портом, обновление по сети | AndroidX, Kotlin stdlib, PermissionX, AppUpdate, локальный модуль `:serialport` | Проект актуален (compileSdk 32), но использует устаревший Kotlin synthetics; нужен перевод на ViewBinding |
| Serial Port Library | блок 6/serialport | Kotlin | Библиотека для доступа к последовательному порту (Android) | Kotlin stdlib, AndroidX | Собирается как модуль проекта блок 6, потенциально переносимая |
| Android Kiosk Shell | apps-unified/android-kiosk | Kotlin | WebView-оболочка для киоска, своя сборочная обвязка | AndroidX core/appcompat/material, coroutines, Mockito для тестов | Минимально жизнеспособный проект, рекомендуем как базу для дальнейшего развития |
| diagnostics-core library | apps-unified/android-kiosk/diagnostics-core | Kotlin | Библиотека диагностического ядра PassThru (контракты, клиент, контроллер сеанса) | androidx.core-ktx 1.13.1, kotlinx-coroutines-core/-android 1.8.1 | В разработке: логика вынесена из app-модуля, добавлен общедоступный парсер ELM DTC, требуется интеграция с UI и расширение тестов |

## Сопоставление pyobd2 ↔ Generic Diagnostic Tool

| Функциональность | pyobd2 (Python) | Generic Diagnostic Tool (C#) | План переноса в киоск |
| --- | --- | --- | --- |
| Транспорт ELM327 | Поддерживает последовательный порт, авто-поиск, восстановление соединения | Через собственный `ElmManager` для USB/COM; также выступает fallback к J2534 | Использовать как эталон поведения при разработке Kotlin-модуля `ElmSerialDriver` (реализация в `libs/cpp` + JNI) |
| Работа с J2534 | Не поддерживается | Полноценный стек (open/connect, write/read, filters, periodic) | Перенос алгоритмов фильтров, heartbeat и ioctl в C++ слой `pass-thru-jni` |
| DTC и Freeze Frame | Чтение PID, DTC, Freeze Frame через стандартные 01, 02 PID; вывод в wx таблицы | Расширенный интерфейс: чтение модов 03, 07, 0A, отображение по брендам, экспорт | Нормализовать CSV из C# и объединить с pyobd2 расшифровкой в единую БД `.obdresource` |
| Live Data / графики | Реализованы графики PID (wxPlot), расчёт базовых показателей | Продвинутые графики, множественные панели, CAN Sniffer | UI-логика будет реализована заново в Android; формулы преобразований перенести из Python и C# в `diagnostics-core` |
| Security Access / Seed-Key | Нет | Набор алгоритмов в `lib/Algorithms` с кастомной криптографией | Переписать безопасные алгоритмы в Kotlin/NDK, добавить модульное тестирование, хранить секреты в защищённом хранилище |
| VIN Decoder / отчёты | VIN декодер отсутствует, отчёты формируются вручную | VIN парсер в `lib/Decoder`, экспорт CSV/PDF | Сформировать сервис VIN (Kotlin) и генератор отчётов с использованием Stage 3 resource pipeline |
| UI/UX | Окна wxPython, локализация EN, GPL лицензия | WinForms + DarkUIReborn, жёсткий UX | Полностью новая Android UI; использовать только алгоритмы и данные |
| Лицензии | GPL-2.0 → неприемлемо для прямого включения | Ограничительная лицензия Benjamin Jack Leighton → требуется письменное разрешение | Переписываем логику с нуля, избегаем прямого копирования кода |

## Обнаруженные дубли и риски

- Android-проекты в блоках 2 и 6 решают схожую задачу сериал-блютуз коммуникации, но опираются на старые версии инструментов; содержимое пригодно как справочник, не для прямого переноса.
- Два отдельных WinForms-проекта (ExpressOBD и Generic Diagnostic Tool) перекрывают функциональность диагностики через ELM327/J2534. Для дальнейшей миграции нужно выбрать единую базу, учитывая лицензии и состояние кода.
- Rust-библиотека `serialport` пересекается по тематике с Android- и C#-модулями, что потребует согласования единого стека сериал-коммуникаций.
- Каталоги `libs/python` и `libs/cpp`, упомянутые в плане, отсутствуют. Их нужно создать при подготовке будущих пакетов.

## Отчёт по блок 4 (Windows-приложение)

**Структура модулей**
- `Program.cs` — точка входа, инициализация форм, вспомогательные классы шифрования/энтропии, загрузка справочников.
- `lib/Interface` — формы и логика для подключения устройств (`connectSelectedJ2534Device`, `J2534DeviceFinder`), отправки/приёма сообщений (`sendPassThruMsg`, `receivePassThruMsg`), CAN Sniffer, конфигурация J2534.
- `lib/Protocol` — набор форм и процедур для UDS/OBD команд (диагностическая сессия, чтение/очистка DTC, ECU Reset, Routine Control, Security Access и др.), плюс CSV-справочники кодов в `lib/Protocol/DTC`.
- `lib/Algorithms` — алгоритмы расчёта ключей безопасности и вспомогательные криптографические функции.
- `lib/Main` — общие утилиты UI, логирование, преобразования форматів.
- `lib/Decoder` — обработка VIN.

**Используемые библиотеки и ресурсы**
- Сторонняя библиотека UI `DarkUIReborn` (NuGet пакет в `packages/`).
- Стандартные сборки .NET Framework 4.8.1.
- Собственные CSV-файлы с DTC кодами для брендов (Acura, Toyota, Lexus и др.).
- Значимые namespace: `PassThruJ2534`, `UltraComplexSystem`, `J2534`.

**Последовательность команд и рабочий поток**
- Форма `connectSelectedJ2534Device` инициализирует поиск устройств через `PassThruScanForDevices` и открывает соединение (`PassThruOpen`, `PassThruConnect`).
- Логика отправки команд строится вокруг `PassThruWriteMsgs` и `PassThruReadMsgs`, с поддержкой фильтров (`PassThruStartMsgFilter`) и периодических сообщений.
- Модули протокола вызывают `Ioctl` команды (`FAST_INIT`, `FIVE_BAUD_INIT`, `CLEAR_MSG_FILTERS`) для подготовки сеанса, затем формируют кадры UDS/ISO15765 и отправляют их через общие обработчики.
- Обработка ответов сводится в формы `diagnosticTroubleCodes`, `testerPresent`, `ecuReset`, где результаты отображаются в UI и сохраняются в логи.
- CAN Sniffer проводит непрерывное чтение буфера (`ReadAllMessages`) с пользовательскими фильтрами.

**Точки интеграции с OBD/J2534 оборудованием**
- Поддержка стандартного интерфейса SAE J2534: подключение, настройка каналов, управление напряжениями, чтение VIN и диагностических сервисов.
- Прямой доступ к CAN/ISO15765, ISO14230, J1850 через перечисления `ProtocolID` и флаги конфигурации.
- Использование CSV-справочников для расшифровки кодов неисправностей после получения ответов от адаптера.
- Механизмы безопасности (Security Access) реализованы в `lib/Algorithms`, требуют точного соблюдения синхронизации с ECU.

**Рекомендации по переносу**
- Зафиксировать юридические ограничения: множество файлов содержит жёсткие лицензии (© Jack Leighton, Tester Present). Перед использованием требуется письменное разрешение.
- Выделить ядро взаимодействия с J2534 (классы `J2534`, `ConnectFlag`, `PassThruMsg`) для дальнейшего портирования в C++/JNI.
- Вынести CSV-справочники DTC в общий формат (например, SQLite/JSON) для Android и Python компонентов.
- Обновить UI-часть для использования современного фреймворка или оставить исключительно как источник алгоритмов.

## Следующие шаги

- [x] Создать каталоги `libs/cpp` и `libs/python`, подготовить структуру под будущие пакеты.
- [x] Выполнить лицензионный аудит блоков 3 и 4 (условия распространения ограничивают производственное использование).
- [x] Определить, какая из Android-баз (блок 2, блок 6, `apps-unified/android-kiosk`) станет целевой, чтобы исключить дублирование.
- [x] Сопоставить функционал pyobd2 и Generic Diagnostic Tool с требованиями целевого киоска, выделить переносимые алгоритмы (см. раздел «Сопоставление pyobd2 ↔ Generic Diagnostic Tool»).
- [x] Устранить повреждённые ресурсы launcher в `apps-unified/android-kiosk`, чтобы восстановить прогон unit-тестов.
- [ ] Интегрировать модуль `diagnostics-core` с UI-потоками и последовательным драйвером киоска.

## Обновление статуса (13.10.2025)

- Лицензии: `docs/tech/security-licensing-audit.md` дополнен сведениями по ExpressOBD (блок 3) и подтверждает ограничения для материалов Benjamin Jack Leighton.
- Целевая Android-база: закреплён проект `apps-unified/android-kiosk` как единственный источник; каталоги из блоков 2 и 6 переведены в статус справочных.
- Структуру `libs/cpp` и `libs/python` проверили — директории присутствуют, настроены базовые CMake/pytest заготовки.
- `diagnostics-core`: реализован общий `ElmResponseParser`, тесты перенесены в модуль библиотеки, `ElmCommandHandler` использует общий код.
- Остаётся подготовить таблицу сопоставления pyobd2 ↔ Generic Diagnostic Tool с указанием переносимых алгоритмов.
